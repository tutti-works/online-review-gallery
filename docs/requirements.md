# オンライン講評会支援ギャラリーアプリ 要件定義書

## 1. 概要

### 1.1. プロジェクトの背景と目的

大学の設計課題などにおいて、従来は対面で行われていた作品の講評会がオンラインへ移行しつつある。しかし、ファイルの共有やフィードバックを一元的に、かつ効率的に行うための最適なツールが存在しない。
本プロジェクトは、Google Classroomに提出された学生の作品（画像、PDF等）を自動的に取得し、視覚的に優れたギャラリー形式で一覧表示するWebアプリケーションを開発することを目的とする。これにより、教員が行うオンライン講評会を円滑にし、インタラクティブなフィードバックの機会を創出する。

### 1.2. 開発するシステムの概要

本システムは、管理者（教員・TA）が操作するデータインポート機能を持つ。この機能はGoogle Classroom APIおよびGoogle Drive APIと連携し、指定された課題の提出物を取得する。取得されたファイルはWeb表示に最適化された画像（WebP）に変換され、Firebase Storageにアップロードされる。
利用者は、Firebase Storage上の画像をPinterestのようなMasonryレイアウトのギャラリーで閲覧し、管理者は各作品に対して「いいね」やコメント形式でのフィードバックを行える。

---

## 2. システムの利用者と役割

本システムの利用者は以下の通りとし、役割（ロール）に応じて利用できる機能を制限する。

| 役割 | 利用者 | 主な操作 |
|:-----|:-------|:---------|
| **管理者 (Admin)** | 教員, TA | Googleアカウントでログイン。データインポート機能の実行、作品の閲覧、全作品への「いいね」・コメント・ラベルの付与、作品の削除、全データリセット。 |
| **閲覧者 (Viewer)** | 学生 | Googleアカウントでログイン。ギャラリーの閲覧のみ。 |
| **ゲスト (Guest)** | 未認証ユーザー | ログインなしでギャラリーの閲覧のみ可能。 |

---

## 3. 機能要件

### 3.1. ユーザー認証機能 (F-01)

- **F-01-01: Googleサインイン**
  - 利用者は自身のGoogleアカウントを使用してシステムにサインインできる。
- **F-01-02: 役割（ロール）判定**
  - サインインしたGoogleアカウントが、事前にFirestoreに登録されたリストに基づき、「管理者」か「閲覧者」かを自動的に判定する。
- **F-01-03: アクセス制御**
  - 役割に応じて、操作可能な機能へのアクセスを制限する。閲覧者は閲覧以外の操作（いいね、コメント投稿など）は行えない。

### 3.2. データインポート機能 (F-02)

- **F-02-01: インポート対象の選択**
  - 管理者は、Google Classroom上のクラスと特定の課題を選択し、インポート対象として指定できる。
- **F-02-02: 複数ファイル提出の統合処理**
  - 同じ学生が複数ファイルを提出した場合、自動的に1つの作品（artwork）としてまとめる。
  - 学生ごとにファイルをグループ化し、全ファイルの全ページを統合して表示する。
  - ページ番号は全ファイル通しで採番される（例: file1.pdf 3ページ + file2.jpg 1ページ = 全4ページ）。
  - サムネイルは全体の1ページ目のみ生成（複数ファイルでも1つのサムネイル）。
- **F-02-03: 提出物の変換とアップロード**
  - 管理者がインポートを実行すると、Firebase Functionsが起動する。
  - 指定された課題の全提出物ファイル（画像、PDF）をGoogle Driveからダウンロードする。
  - **画像ファイルの場合:** Web表示に適したサイズにリサイズ・最適化し、WebP形式に直接変換する（Sharp使用）。
  - **PDFファイルの場合:** PDFの各ページを一旦JPEG（3400x2404px）に変換し、SharpでWebP形式に再変換する。Cloud Runを使用してGraphicsMagick/Ghostscriptでの高品質変換を行う。
  - JPEG経由の2段階変換により、メモリ使用量を抑えてSegmentation Faultを回避。
  - サムネイル画像（420x297px、WebP形式）を自動生成し、アスペクト比を維持する。
  - 変換・最適化して生成された全てのWebP画像をFirebase Storageにアップロードする。
  - WebP形式により、JPEG比で約30%のファイルサイズ削減を実現。
- **F-02-04: メタデータの保存**
  - 作品のメタデータ（提出ファイル情報、作成者、提出日時など）をFirestoreに保存する。
  - 提出された全ファイルの情報（ファイル名、種類、元URL）を`files`配列に保存する。
  - 各画像には元ファイル情報（`sourceFileId`, `sourceFileName`）を紐付ける。
  - エラーが発生したファイルは`errorFiles`（ファイル名）と`errorDetails`（詳細情報）に記録され、処理を継続する。
- **F-02-05: インポート進捗表示**
  - インポート処理の進捗状況（処理済み学生提出数/総学生提出数）をリアルタイムで表示する。
  - Cloud Tasksを使用した非同期分散処理により、大量ファイルのインポートでもタイムアウトを回避する。
- **F-02-06: インポート待機中のユーザー誘導**
  - インポート開始時に黄色の警告ボックスを表示し、ページを閉じないよう注意喚起する。
  - ブラウザを閉じようとした際に確認ダイアログを表示（beforeunload）。
  - 段階的にステータスメッセージを変更し（「データ取得中」→「ファイル確認中」→「処理キュー準備中」）、処理が進行中であることを視覚的に示す。
  - ローディングスピナーアニメーションで処理中であることを強調。

### 3.3. ギャラリー表示機能 (F-03)

- **F-03-01: Masonryレイアウト表示**
  - 異なるサイズ・アスペクト比の作品を、隙間なく美しく配置するMasonryレイアウト（グリッド形式）で表示する。
  - 複数ページある作品（元がPDF）の場合は、1ページ目の画像がサムネイルとして表示される。
  - サムネイルには学生名、いいね数、コメント数、ページ数、ラベル、遅刻フラグを表示する。
- **F-03-02: 作品の拡大・複数ページ表示**
  - ギャラリー上のサムネイルをクリックすると、作品を全画面モーダルウィンドウで拡大表示する。
  - 作品が複数ページで構成される場合（元がPDF）、モーダル内で「次へ」「前へ」といったナビゲーションを提供し、全ページを閲覧できるようにする。
  - ページサムネイルを下部に表示し、クリックで該当ページにジャンプできる。
  - モーダルのヘッダーに現在表示中のファイル名を表示し、ページ切り替え時に自動で更新する。
- **F-03-03: ズーム・パン機能**
  - モーダル内で画像をズームイン/ズームアウト（0.5〜3倍）できる。
  - ズーム時にドラッグ操作でパン（画像の移動）が可能。
- **F-03-04: 並び替え・フィルタリング**
  - 提出日時順（早い/遅い）、学籍番号順（A→Z/Z→A）で並び替えが可能。
  - **個別ラベルフィルタリング:** 赤（1〜5）、青（1〜5）の10種類のラベルボタンによるフィルタリング（OR条件）
  - **合計ラベルフィルタリング（実装済み）:** ラベル数字の合計値（1〜10）でフィルタリング
    - プルダウン選択で合計値を指定（デフォルト: "合計で絞り込み"）
    - 合計フィルター選択時は個別ラベルボタンを自動的に無効化（`opacity-50 cursor-not-allowed`スタイル適用）
    - 合計フィルター解除時は個別ラベルボタンを再び有効化
    - 正規表現（`/-(\d+)$/`）でラベルから数字を抽出し、`reduce`で合計値を計算
    - 個別フィルターと合計フィルターは排他的に動作
    - 実装方式: クライアント側での動的フィルタリング（シンプルで十分な性能）
- **F-03-05: ギャラリー切り替え機能**
  - ドロップダウンで授業と課題を選択し、異なるギャラリーを切り替えることができる。
  - URLパラメータ（`galleryId`）で特定のギャラリーを表示する。
  - **初回訪問時の挙動:**
    - ギャラリーが1つも存在しない場合：「まだギャラリーがありません」メッセージを表示
    - ギャラリーが存在する場合：「課題を選択してください」メッセージを表示し、ドロップダウンで選択を促す
  - **再訪問時の挙動:**
    - localStorageに保存された最後に閲覧したギャラリーを自動表示
    - 保存されたギャラリーが削除されている場合は、選択画面を表示
  - **URL・localStorage同期:**
    - URLパラメータとlocalStorageを自動同期し、ブックマークや直接アクセスに対応
    - 削除されたギャラリーIDの場合は、URL・localStorageから自動削除して選択画面に遷移

### 3.4. 評価・フィードバック機能 (F-04)

- **F-04-01: いいね機能**
  - 管理者は、各作品に対して「いいね」を付けることができる。一度のみクリック可能で、再度クリックすると解除される（トグル式）。
  - 「いいね」の総数は作品ごとにリアルタイムで表示される。
  - 楽観的UI更新により、スムーズな操作感を実現する。
- **F-04-02: コメント機能**
  - 管理者は、各作品に対してテキストコメントを投稿できる。
  - 投稿されたコメントは、投稿者名（Googleアカウント名）とタイムスタンプと共に時系列で表示される。
- **F-04-03: ラベル機能**
  - 管理者は、各作品に対して赤（1〜5）、青（1〜5）の計10種類のラベルを付けることができる。
  - ラベルはトグル式で、クリックすると追加/削除される。
  - 複数のラベルを同時に付けることが可能。
  - ラベルは作品サムネイルとモーダルに表示される。
- **F-04-04: 作品削除機能**
  - 管理者は、作品をギャラリーから削除できる。
  - 削除時には確認ダイアログが表示される。
  - Firestore上のドキュメントとStorage上の画像ファイルが同時に削除される。

### 3.5. データ管理機能 (F-05)

- **F-05-01: 全データリセット**
  - 管理者は、ダッシュボードから全ギャラリー、全作品、全画像ファイルを一括削除できる。
  - 削除時には2回の確認ダイアログが表示される。
  - Firestore上の全コレクション（artworks, likes, importJobs, galleries）とStorage上の全画像が削除される。
  - 削除実行時にlocalStorageもクリアされる。
- **F-05-02: ギャラリー別データ削除**
  - 管理者は、ダッシュボードから特定のギャラリーに紐づくデータのみを削除できる。
  - 2段階ドロップダウン（授業選択 → 課題選択）で削除対象を選択する。
  - 課題が選択されている場合のみ削除ボタンが有効になる。
  - 削除されるデータ：該当ギャラリーの作品、いいね、インポートジョブ、ギャラリードキュメント、Storage上の画像ファイル。
  - 削除時には2回の確認ダイアログが表示される。
  - 削除されたギャラリーがlocalStorageに保存されている場合は自動的にクリアされる。

### 3.6. 作品注釈機能 (F-06) ※基本実装完了

- **F-06-01: フリーハンド描画**
  - ✅ 管理者は、作品画像の上にフリーハンドで線を描画できる（Konva.js Line + Bezier曲線）。
  - ✅ 指やペンによるタッチ操作に対応し、滑らかな線の描画が可能。
  - ✅ 描画時にブラシの色（カラーピッカー）と太さ（1〜30px）を選択できる。
- **F-06-02: 注釈の編集**
  - ✅ 描画モードと選択モードを切り替えることができる。
  - ✅ 選択モードでは、描画した線をクリックして選択し、移動が可能。
  - ✅ 選択した線を個別に削除、または全ての注釈を一括クリアできる。
  - 🔄 消しゴムツールの追加（予定）
  - 🔄 元に戻す/やり直し機能の追加（予定）
- **F-06-03: 注釈データの保存**
  - ✅ 注釈データはベクトルデータ（JSON形式）としてFirestoreに保存される。
  - ✅ 各ページ（画像）ごとに独立した注釈データを持つ。
  - ✅ 注釈の作成者、作成日時、更新日時を記録する。
  - ✅ 未保存の変更がある場合は警告を表示する。
- **F-06-04: 注釈の表示**
  - ✅ モーダル内で「注釈」ボタンをクリックすると、注釈モードに切り替わる。
  - ✅ 管理者は注釈の編集が可能、閲覧者は注釈の表示のみ可能。
  - ✅ 保存済みの注釈データを読み込んで、キャンバス上に復元する。
  - 🔄 注釈がある場合はデフォルトで注釈を表示し、表示/非表示切り替えボタンを設置（予定）
- **F-06-05: ページ間での注釈管理**
  - ✅ 複数ページの作品では、各ページごとに独立した注釈を管理する。
  - ✅ ページを切り替えると、該当ページの注釈が自動的に読み込まれる。
  - 🔄 ページ切り替え時に未保存の注釈を自動保存する機能（予定）
- **F-06-06: ズーム・パン連携（予定）**
  - 🔄 注釈モードでも通常表示と同様に画像をズーム（拡大/縮小）できる
  - 🔄 注釈モードでも手のひらツールで画像位置を移動できる
  - 🔄 注釈は画像のズーム・パンに追従して表示される
  - 🔄 注釈モード開始時に、現在のズーム率と表示位置を維持する
- **F-06-07: ツールバー拡張（予定）**
  - 🔄 描画ツールボタン（ペンアイコン）
  - 🔄 線の選択・移動ツールボタン（矢印アイコン、既存の選択モードを改善）
  - 🔄 画像移動ツールボタン（手のひらアイコン、ズーム・パン操作用）
  - 🔄 消しゴムツールボタン（部分削除機能）
  - 🔄 線の太さプリセット（細: 2px、中: 6px、太: 12px）
  - 🔄 色パレット（黒・赤・青・緑・黄・白の6色ボタン）
  - 🔄 元に戻す/やり直しボタン（Undo/Redo、履歴管理）
  - 🔄 全消去（クリア）ボタン（既存機能のUI改善）
  - 🔄 保存ボタン（既存機能のUI改善）
- **F-06-08: キーボードショートカット（予定）**
  - 🔄 `Ctrl+Z` / `Cmd+Z`: 元に戻す
  - 🔄 `Ctrl+Y` / `Cmd+Y` / `Ctrl+Shift+Z`: やり直し
  - 🔄 `D`: 描画モード
  - 🔄 `V`: 線の選択・移動モード
  - 🔄 `H`: 画像移動（Hand）モード
  - 🔄 `E`: 消しゴムモード
  - 🔄 `Delete` / `Backspace`: 選択中の線を削除
  - 🔄 `Esc`: 注釈モード終了（未保存の場合は確認）
  - 🔄 `Ctrl+S` / `Cmd+S`: 注釈を保存
- **F-06-09: 自動保存機能（予定）**
  - 🔄 ページ切り替え時に未保存の注釈を自動保存
  - 🔄 10秒間操作がない場合にバックグラウンドで自動保存
  - 🔄 注釈モード終了時に自動保存（未保存の場合）
  - 🔄 自動保存中は控えめなインジケーターを表示
- **F-06-10: 注釈のプレビュー表示（予定）**
  - 🔄 注釈がある作品のサムネイルに注釈アイコンを表示
  - 🔄 通常表示モード時に注釈をオーバーレイ表示（デフォルトON）
  - 🔄 注釈の表示/非表示を切り替えるボタン
- **F-06-11: 高度な描画ツール（予定、優先度: 低）**
  - 🔄 テキストツール（文字入力、フォントサイズ・色の選択）
  - 🔄 図形ツール（矩形・円の描画）
  - 🔄 マルチタッチジェスチャー対応（ピンチイン/アウト、2本指パン、筆圧検知）

---

## 4. 非機能要件

| 項目 | 要件 |
|:-----|:-----|
| **パフォーマンス** | ・ギャラリーの初回表示（主要コンテンツの描画完了）が3秒以内であること。<br>・「いいね」やコメントの反映は非同期で行い、ユーザー操作を妨げないこと。<br>・データインポート処理は、100件程度のファイル数をタイムアウトせずに安定して処理できること。 |
| **UI/UX** | ・直感的で学習コストの低いインターフェースであること。<br>・レスポンシブデザインに対応し、PCおよびタブレットのブラウザで最適に表示されること。 |
| **セキュリティ** | ・Firebase AuthenticationとFirestoreのセキュリティルールを適切に設定し、権限のない利用者によるデータの読み書きを完全に防止すること。<br>・APIキーなどの機密情報は適切に管理すること。 |
| **可用性** | ・VercelおよびFirebaseのSLAに準拠し、安定したサービス稼働を目指す。 |
| **動作環境** | ・**対応ブラウザ:** 最新バージョンのGoogle Chrome, Safari, Firefox, Microsoft Edge。 |

---

## 5. システム構成

- **フロントエンド:** Next.js 14 (React, TypeScript)
  - Tailwind CSS を使用したスタイリング
  - レスポンシブデザイン対応
- **バックエンド:**
  - **Firebase Functions (第2世代):** インポート制御、データ取得、作品削除などの主要機能
  - **Cloud Run:** PDF処理専用（GraphicsMagick/Ghostscript使用）
  - Cloud Tasksを使用した非同期分散処理（ファンアウト）アーキテクチャで、タイムアウトを回避
  - メモリ: Functions 1GB〜2GB、Cloud Run 2GB
- **データベース:** Firestore
  - コレクション: artworks, galleries, importJobs, likes, userRoles
  - Security Rulesによる役割ベースのアクセス制御
- **ファイルストレージ:** Firebase Storage
  - 作品画像、サムネイル、一時ファイルのホスティング
  - 自動クリーンアップ機能（毎日午前3時）
- **認証:** Firebase Authentication (Google Sign-In)
- **外部API連携:** Google Drive API, Google Classroom API（データインポート機能でのみ利用）
- **ホスティング/デプロイ:**
  - **Firebase Hosting:** SSR対応、asia-northeast1リージョン
  - **GitHub Actions:** 自動デプロイパイプライン
- **モニタリング:** Google Analytics（有効化済み）

---

## 6. 開発スコープ

### 6.1. 範囲内（実装済み）

- ✅ 上記の機能要件（F-01〜F-05）に記載された全ての機能の実装
- ✅ PDFファイルの各ページを高品質画像（3400x2404px、A3横向き比率）に変換
- ✅ 複数ページの作品をページめくり形式で閲覧できる機能
- ✅ 画像（JPEG, PNG, GIF）ファイルの最適化と表示対応
- ✅ サムネイル自動生成（420x297px、アスペクト比維持）
- ✅ **複数ファイル提出の統合処理**（同じ学生の複数ファイルを1つのartworkにまとめる）
- ✅ ズーム・パン機能による詳細な作品閲覧
- ✅ ラベル機能による作品の分類
- ✅ 並び替え・個別ラベルフィルタリング機能
- ✅ **合計ラベルフィルター機能**（ラベル数字の合計値でフィルタリング、個別フィルターと排他制御）
- ✅ インポート進捗のリアルタイム表示
- ✅ 全データリセット機能（管理者専用）
- ✅ 一時ファイルの自動クリーンアップ
- ✅ GitHub Actionsによる自動デプロイ
- ✅ **ハイブリッド方式によるギャラリー管理**（2段階ドロップダウン、URL・localStorage同期、ギャラリー別削除）

### 6.2. 範囲内（実装中）

- ✅ **作品注釈機能（F-06）基本機能:** フリーハンド描画、選択・移動・削除、Firestore保存（Konva.jsベース、2025-10-23実装完了）
- 🔄 **作品注釈機能（F-06）拡張機能:** ズーム・パン連携、ツールバー拡張、注釈表示切り替え、自動保存（実装予定）

### 6.3. 範囲外（実装しない）

- ❌ **動画ファイルのストリーミング再生:** 動画ファイルはインポート対象外とする
- ❌ **学生間のピアレビュー機能:** 学生による「いいね」やコメント機能は実装しない
- ❌ **コメント削除機能:** コメントの削除は実装しない（作品ごと削除は可能）
- ❌ **リアルタイム共同編集機能:** 複数人が同時に一つのコメントを編集する機能は含めない
- ❌ **オフライン機能:** インターネット接続が必須となる
- ❌ **高度な管理者ダッシュボード:** 利用者アカウントの管理や利用状況の統計分析などの機能は本プロジェクトの範囲外とする

---

## 7. データ構造の詳細

### 7.1. Firestore コレクション構造

```
artworks (コレクション)
├── artwork_id (ドキュメント)
│   ├── id: string
│   ├── title: string （例: "山田太郎の提出物"）
│   ├── galleryId: string （どのギャラリーに属するか）
│   ├── files: SubmittedFile[] （提出された元ファイル情報の配列）
│   │   ├── id: string （Google Drive File ID）
│   │   ├── name: string （ファイル名）
│   │   ├── type: 'image' | 'pdf'
│   │   ├── originalFileUrl: string
│   │   └── mimeType: string
│   ├── images: ArtworkImage[] （変換済み画像の配列、全ファイルの全ページ統合）
│   │   ├── id: string
│   │   ├── url: string
│   │   ├── pageNumber: number （全ファイル通しのページ番号）
│   │   ├── width: number
│   │   ├── height: number
│   │   ├── thumbnailUrl?: string
│   │   ├── sourceFileId: string （どのファイルから生成されたか）
│   │   └── sourceFileName: string
│   ├── studentName: string
│   ├── studentEmail: string
│   ├── submittedAt: Timestamp
│   ├── isLate: boolean
│   ├── classroomId: string
│   ├── assignmentId: string
│   ├── likeCount: number
│   ├── labels: LabelType[]
│   ├── comments: Comment[]
│   ├── annotations?: ArtworkAnnotation[] （作品への注釈データ、実装予定）
│   ├── createdAt: Timestamp
│   └── importedBy: string

galleries (コレクション) ※ハイブリッド方式：メタデータとキャッシュを保存
├── gallery_id (ドキュメント)
│   ├── id: string
│   ├── courseName: string （授業名、例: "デザイン基礎"）
│   ├── assignmentName: string （課題名、例: "第1回課題：ロゴデザイン"）
│   ├── courseId: string （Google Classroom Course ID）
│   ├── assignmentId: string （Google Classroom Assignment ID）
│   ├── classroomId: string （courseIdと同じ、互換性のため）
│   ├── artworkCount: number （作品数キャッシュ）
│   ├── createdBy: string
│   ├── createdAt: Timestamp
│   ├── updatedAt: Timestamp
│   └── lastImportAt?: Timestamp

likes (コレクション)
├── like_id (ドキュメント)
│   ├── id: string
│   ├── artworkId: string
│   ├── userEmail: string
│   └── createdAt: Timestamp

importJobs (コレクション)
├── job_id (ドキュメント)
│   ├── id: string
│   ├── galleryId: string
│   ├── classroomId: string
│   ├── assignmentId: string
│   ├── status: 'pending' | 'processing' | 'completed' | 'error'
│   ├── progress: number (0-100)
│   ├── totalFiles: number （学生提出数）
│   ├── processedFiles: number
│   ├── errorFiles: string[]
│   ├── createdBy: string
│   └── createdAt: Timestamp

userRoles (コレクション)
├── user_email (ドキュメント)
│   ├── role: 'admin' | 'viewer'
│   └── createdAt: Timestamp
```

### 7.2. 注釈データ構造（実装予定）

```typescript
interface ArtworkAnnotation {
  imageId: string;        // どの画像（ArtworkImage.id）に対する注釈か
  pageNumber: number;     // 作品内のページ番号（1から開始）
  data: string;           // Fabric.jsのJSONデータ（文字列化）
  width: number;          // 注釈作成時のキャンバス幅
  height: number;         // 注釈作成時のキャンバス高さ
  createdBy: string;      // 注釈作成者のメールアドレス
  createdAt: Timestamp;   // 作成日時
  updatedAt: Timestamp;   // 更新日時
}
```

**設計方針:**
- 各ページごとに独立した注釈データを管理（`pageNumber`で識別）
- Fabric.jsのJSON形式でベクトルデータを保存（後から編集可能）
- キャンバスサイズ（`width`, `height`）を保存し、異なる画面サイズでの表示時にスケーリング可能
- 注釈データは`artworks`ドキュメント内の配列フィールド（`annotations`）として保存
- 1ページあたりの注釈データサイズ: 約5〜10KB（目安）
- Firestoreドキュメントサイズ上限（1MB）に対して十分な余裕あり

**使用ライブラリ:**
- **Konva.js**: キャンバス操作ライブラリ（60KB gzip）
  - フリーハンド描画（Line + Bezier曲線）
  - オブジェクトの選択・移動・削除
  - JSON形式でのシリアライズ/デシリアライズ
  - タッチデバイス対応
  - 背景画像のレイヤー管理が安定

**技術選定の経緯（2025-10-23）:**
- 当初はFabric.js v5.3.0を採用したが、以下の致命的な問題が発生:
  - `canvas.setWidth()` / `canvas.setHeight()` 呼び出し時に `Cannot read properties of null (reading 'clearRect')` エラー
  - Fabric.js内部でcanvas contextがnullになる実装上の問題
  - 背景画像のスケーリング時に描画した線が消える
  - CSS-only方式では内部サイズの不整合により正常動作せず
- Konva.jsへの移行を決定した理由:
  - よりシンプルで予測可能なAPI設計
  - 背景画像をLayerとして管理できるため、スケーリングが安定
  - React統合が容易（react-konva利用可能）
  - TypeScript型定義が完備
  - 移行コスト: 約2〜3時間（試験済みのFabric.js実装を参考に移行）

### 7.3. ハイブリッド方式の実装（2025-10-06実装済み）

**設計方針:**
- `galleries`コレクション：軽量なメタデータとキャッシュを保存
- `artworks`コレクション：全作品データを保存、`galleryId`フィールドでフィルタリング
- Google Classroom APIから授業名・課題名を自動取得してギャラリーを生成

**主な機能:**
1. **ギャラリー自動生成**: インポート時にGoogle Classroom APIから授業名・課題名を取得し、ギャラリードキュメントを自動作成
2. **作品数キャッシュ**: 作品追加時に`artworkCount`を自動インクリメント
3. **ギャラリー切り替えUI**: 2段階ドロップダウン（授業選択 → 課題選択）で直感的に切り替え
4. **URLパラメータ連携**: `?galleryId=xxx`形式でギャラリーを指定可能
5. **ギャラリー別削除**: 特定のギャラリーに紐づく全データ（作品、いいね、ファイル）を一括削除

**実装ファイル:**
- `functions/src/importController.ts`: `ensureGalleryExists`関数でギャラリー自動生成、既存ギャラリーのメタデータ更新
- `functions/src/fileProcessor.ts`: `processMultipleFiles`内で`artworkCount`インクリメント
- `functions/src/index.ts`: `deleteGalleryData`関数でギャラリー別削除
- `src/components/GallerySwitcher.tsx`: 2段階ドロップダウンUI、localStorage保存
- `src/app/gallery/page.tsx`: ギャラリー選択の初期化ロジック、URL・localStorage同期、削除されたギャラリーの検証
- `src/app/dashboard/page.tsx`: 2カラムレイアウト（課題削除・全データリセット）、localStorage連携
- `src/app/admin/import/page.tsx`: インポート後のリダイレクト先を`/gallery?galleryId=xxx`に変更

---

## 8. デプロイ情報

### 8.1. 本番環境

- **プロジェクトID:** online-review-gallery
- **リージョン:** asia-northeast1
- **Firebase Hosting URL:** https://online-review-gallery.web.app
- **Cloud Run URL:** https://processfiletask-816131605069.asia-northeast1.run.app

### 8.2. 環境変数

**開発環境 (`.env.local`)**
- Firebase設定（API Key、Project ID等）
- Functions Base URL（エミュレータ）

**本番環境 (`.env.production`)**
- Firebase設定（本番プロジェクト）
- Cloud Run URL
- Google Analytics Measurement ID

---

## 9. 開発履歴

詳細な変更履歴は [changelog.md](changelog.md) を参照してください。

### 主要マイルストーン

- **2025-09-30:** 主要機能の実装完了（認証、インポート、ギャラリー、いいね、コメント）
- **2025-10-02:** Cloud Run移行、PDF処理最適化、ラベル機能追加、データリセット機能追加
- **2025-10-04:** Firebase Hostingへの移行、SSR対応
- **2025-10-05:** GitHub Actions自動デプロイ設定、Google Analytics有効化
- **2025-10-06:** 複数ファイル提出の統合処理、ハイブリッドギャラリー管理システム、ギャラリー選択フロー改善
- **2025-10-07:** WebP形式対応、インポート待機UI改善、PDF変換最適化、サムネイル重複生成バグ修正
- **2025-10-21:** 合計ラベルフィルター機能実装
- **2025-10-22:** 作品注釈機能の要件定義追加（Fabric.jsベース、実装予定）
- **2025-10-23:** Fabric.js実装でDOM操作エラー発生、Konva.jsへの移行を決定、基本的な注釈機能の実装完了（フリーハンド描画、選択・移動・削除、Firestore保存）

---

## 10. 実装計画: 作品注釈機能（F-06）

### 10.1. 技術選定

**採用ライブラリ: Konva.js**

| 評価項目 | Konva.js | Fabric.js | Paper.js |
|:---------|:---------|:----------|:---------|
| **編集機能** | ⭐⭐⭐ 標準搭載 | ⭐⭐⭐ 標準搭載 | ⭐ 自前実装必要 |
| **JSON保存** | ⭐⭐⭐ toJSON/fromJSON | ⭐⭐⭐ ネイティブ対応 | ⭐ 複雑 |
| **React統合** | ⭐⭐⭐ react-konva | ⭐⭐ 可能 | ⭐ 困難 |
| **TypeScript** | ⭐⭐⭐ 型定義完備 | ⭐⭐⭐ 型定義完備 | ⭐ 不完全 |
| **タッチ対応** | ⭐⭐⭐ 優秀 | ⭐⭐⭐ 優秀 | ⭐⭐ 可能 |
| **バンドルサイズ** | ⭐⭐ 60KB (gzip) | ⭐⭐⭐ 26KB (gzip) | ⭐⭐ 中程度 |
| **背景画像管理** | ⭐⭐⭐ Layer方式で安定 | ⭐ DOM操作エラー | ⭐⭐ 可能 |
| **API安定性** | ⭐⭐⭐ 予測可能 | ⭐ DOM context問題 | ⭐⭐ 複雑 |

**総合評価:**
- **Konva.js**: シンプルで安定したAPI、背景画像管理が優秀、React統合が容易（採用理由）
- **Fabric.js**: `setWidth()/setHeight()`でDOM context nullエラー、背景画像とのスケーリング問題（不採用）
- **Paper.js**: 描画品質は最高だが、React統合が困難、実装コストが高い

**Fabric.jsからKonva.jsへの移行判断（2025-10-23）:**
- Fabric.js v5.3.0で以下の致命的な問題が発生し、解決不可能と判断:
  1. `canvas.setWidth()/setHeight()` 呼び出し時の `clearRect` エラー（Fabric.js内部実装の問題）
  2. 背景画像スケーリング時に描画した線が消失する問題
  3. CSS-only方式では内部キャンバスサイズの不整合により正常動作せず
- Konva.jsは背景画像をLayerとして管理できるため、スケーリングが安定
- React統合が優れており、`react-konva`を使用すればReactらしい実装が可能
- 移行コストは2〜3時間程度（Fabric.js実装の経験を活かせる）

### 10.2. 実装状況（2025-10-23時点）

#### Phase 1: Fabric.jsのクリーンアップと依存関係の更新 ✅ 完了
- ✅ Fabric.jsを削除
- ✅ Konva.js (v9.3.16) とreact-konva (v18.2.9) をインストール

#### Phase 2: AnnotationCanvasコンポーネントのKonva.js実装 ✅ 完了
実装ファイル: [src/components/AnnotationCanvas.tsx](src/components/AnnotationCanvas.tsx) (582行)

**実装済み機能:**
- ✅ react-konvaコンポーネント（Stage, Layer, Image, Line）を使用
- ✅ 背景画像をImageコンポーネントとしてbackgroundLayerに配置
- ✅ フリーハンド描画をLineコンポーネントで実装（tension: 0.5でBezier曲線）
- ✅ 描画モード/選択モードの切り替えボタン
- ✅ ブラシ設定（カラーピッカーで色選択、1-30pxで太さ調整）
- ✅ stage.toJSON() / Node.create()でJSON保存/復元
- ✅ 選択した線の移動（ドラッグ）
- ✅ 選択削除ボタン（選択中の線を削除）
- ✅ 全てクリアボタン（全ての注釈を削除）
- ✅ 線の選択時にシャドウエフェクトで視覚的にハイライト
- ✅ タッチデバイス対応（touchStart, touchMove, touchEnd）

**レイアウト:**
- 2層レイヤー構造: background-layer（画像）とdrawing-layer（注釈）
- コンテナの幅に合わせて自動スケーリング
- ResizeObserverでリサイズに対応

#### Phase 3: データ形式の検証 ✅ 完了
- ✅ JSON形式でのエクスポート/インポート動作確認済み
- ✅ 画像サイズ変更時のスケーリング処理実装済み
  - baseSize（元画像サイズ）とdisplaySize（表示サイズ）を管理
  - displayScaleで注釈の座標とストローク幅を自動調整
- ✅ ページ切り替え時の注釈データ保持確認済み
  - 各ページのpageNumberで注釈を識別
  - ページ切り替え時に該当ページの注釈を自動読み込み

#### Phase 4: Firestore統合とテスト ✅ 完了
実装ファイル:
- [src/components/ArtworkModal.tsx](src/components/ArtworkModal.tsx)
- [src/components/artwork-modal/ArtworkViewer.tsx](src/components/artwork-modal/ArtworkViewer.tsx)
- [src/app/gallery/page.tsx](src/app/gallery/page.tsx)

**実装済み機能:**
- ✅ Firestoreへの注釈データ保存処理（onSaveAnnotation）
- ✅ 注釈データ読み込み処理（initialAnnotation props経由）
- ✅ 権限制御（editable propsで管理者のみ編集可能）
- ✅ 保存中の状態表示（saving props）
- ✅ 未保存変更の検知（isDirty state + onDirtyChange callback）
- ✅ 注釈モード終了時の未保存警告ダイアログ

**データフロー:**
```
GalleryPage → ArtworkModal → ArtworkViewer → AnnotationCanvas
         ↓
    handleSaveAnnotation (Firestore updateDoc)
```

#### Phase 5: UX改善と最適化 ✅ 基本完了
- ✅ 未保存の変更がある場合の警告表示（注釈モード終了時）
- ✅ ローディング状態の表示（画像読み込み中スピナー）
- ✅ エラーハンドリングの実装（try-catch + アラート）
- ✅ 遅延読み込み（dynamic import with ssr: false）
- ✅ 保存中は操作を無効化（controlsDisabled状態）
- ✅ 閲覧専用モード時のメッセージ表示

### 10.3. 拡張機能実装ロードマップ

以下のロードマップに基づき、段階的に機能を実装していきます。

#### フェーズ1: 基本体験の改善（1-2日） - 優先度: 最高

**目標**: 注釈機能の使い勝手を劇的に向上させる

1. **自動保存機能（F-06-09）**
   - ページ切り替え時に未保存の注釈を自動保存
   - 10秒間操作がない場合にバックグラウンドで自動保存（debounce処理）
   - 注釈モード終了時に自動保存
   - 自動保存中は控えめなインジケーター表示
   - **実装方法**:
     - `useEffect`でdirtyフラグを監視し、10秒のタイマーを設定
     - `handlePageChange`をラップして自動保存を挿入
     - 保存中の状態を`isAutoSaving`フラグで管理

2. **ツールバーレイアウト刷新（F-06-07）**
   - 3セクション構造に再設計:
     ```
     [ツールボタン群]  [ブラシ設定群]  [アクション群]
     ・🖊️ 描画         ・色パレット    ・↶ 元に戻す
     ・↖️ 線を選択移動  ・細 中 太      ・↷ やり直し
     ・✋ 画像を移動                    ・🗑️ 全てクリア
     ・🧹 消しゴム                      ・💾 保存
     ```
   - 色パレット: 黒 `#000000`、赤 `#EF4444`、青 `#3B82F6`、緑 `#22C55E`、黄 `#FACC15`、白 `#FFFFFF`
   - 線の太さプリセット: 細 2px、中 6px、太 12px
   - アイコンを追加してビジュアル的に分かりやすく
   - **実装方法**:
     - 現在の`mode`を`'draw' | 'select' | 'pan' | 'erase'`に拡張
     - ボタンをグループ化してスタイリング改善
     - Heroiconsやlucide-reactからアイコン取得

3. **注釈の表示/非表示切り替え（F-06-10）**
   - 通常表示モード時に注釈をオーバーレイ表示（デフォルトON）
   - 「注釈を表示/非表示」トグルボタンを画像コントロールバーに追加
   - サムネイルに注釈アイコン（📝）を表示
   - **実装方法**:
     - ArtworkViewerに`showAnnotationOverlay`状態を追加
     - 注釈データがある場合のみアイコンを表示
     - AnnotationCanvasを`editable={false}`で読み取り専用モード表示

#### フェーズ2: 高度な操作性（2-3日） - 優先度: 高

**目標**: プロフェッショナルな描画体験を実現

4. **ズーム・パン連携（F-06-06）**
   - 注釈モード時も画像をズーム・パン可能
   - 画像移動ツール（手のひら）で画像とキャンバス全体を移動
   - 注釈は画像に追従して拡大縮小・移動
   - 注釈モード開始時に現在のズーム率・位置を維持
   - **実装方法**:
     - `initialZoom`と`initialPan`をpropsで受け取る
     - Konva.jsの`Stage.scale()`と`Stage.position()`を使用
     - `mode === 'pan'`時にStageのドラッグを有効化
     - マウスホイールでズーム（`onWheel`イベント）

5. **Undo/Redo機能（F-06-07）**
   - 元に戻す/やり直しボタン
   - 履歴スタック管理（最大50履歴）
   - 操作ごとにスナップショットを保存
   - **実装方法**:
     - `history: LineShape[][]`と`historyStep: number`を状態管理
     - 描画・移動・削除時に履歴を追加
     - Undo時は`historyStep`をデクリメント、Redo時はインクリメント

6. **消しゴムツール（F-06-07）**
   - 線を部分的に削除できる消しゴムモード
   - 消しゴムのサイズ調整可能
   - **実装方法**:
     - `mode === 'erase'`時に消しゴム専用レイヤーを作成
     - `globalCompositeOperation: 'destination-out'`を使用
     - または、線との交差判定で線を分割

#### フェーズ3: 効率化機能（1-2日） - 優先度: 高

**目標**: 講評会での作業効率を最大化

7. **キーボードショートカット（F-06-08）**
   - 全ショートカット実装（Ctrl+Z, Ctrl+Y, D, V, H, E, Delete, Esc, Ctrl+S）
   - macOS対応（Cmd修飾キー）
   - ツールチップで各ボタンにショートカットを表示
   - **実装方法**:
     - `useEffect`でkeydownイベントリスナーを登録
     - `navigator.platform`でmacOSを判定
     - 各ツールボタンの`title`属性にショートカットを表示

8. **パフォーマンス最適化**
   - 注釈データの差分更新（全体保存ではなく変更部分のみ）
   - 大量の線がある場合のレンダリング最適化（`perfectDrawEnabled: false`）
   - オフスクリーンキャンバスによる背景画像のキャッシュ
   - **実装方法**:
     - Firestoreへの保存時に前回の保存データと比較
     - Konva.jsのStageに`perfectDrawEnabled: false`を設定
     - 背景画像を一度描画したらキャッシュ

9. **エラーハンドリング強化**
   - ネットワークエラー時の自動リトライ（最大3回）
   - 保存失敗時にlocalStorageへの一時保存
   - オフライン検知と警告表示
   - **実装方法**:
     - `navigator.onLine`でオフライン検知
     - 保存失敗時に`localStorage.setItem('annotation_backup', JSON.stringify(payload))`
     - 次回起動時にバックアップを検知して復元提案

#### フェーズ4: 高度な描画ツール（2-3日） - 優先度: 中

**目標**: より表現力豊かな注釈を可能にする

10. **テキストツール（F-06-11）**
    - 文字入力機能
    - フォントサイズ選択（12px, 16px, 24px, 32px）
    - 色の選択（共通パレット使用）
    - **実装方法**:
      - Konva.js `Text`ノードを使用
      - ダブルクリックで編集モード（contenteditable div表示）
      - 入力完了後にTextノードに反映

11. **図形描画ツール（F-06-11）**
    - 矩形・円の描画
    - ドラッグ操作で図形のサイズを調整
    - 塗りつぶし/輪郭線のみ選択可能
    - **実装方法**:
      - Konva.js `Rect`, `Circle`ノードを使用
      - マウスダウン→ドラッグ→マウスアップで図形生成
      - TransformerでリサイズとRotation

12. **マルチタッチジェスチャー対応（F-06-11）**
    - ピンチイン/アウトでズーム
    - 2本指でパン
    - Apple Pencilの筆圧検知（strokeWidthに反映）
    - **実装方法**:
      - `onTouchMove`で`event.touches.length`判定
      - 2本指の距離変化でズーム倍率計算
      - `event.pressure`プロパティで筆圧取得

#### フェーズ5: 将来的な拡張（優先度: 低）

13. **注釈のエクスポート**
    - 注釈付き画像をPNG形式でダウンロード
    - **実装方法**: `stage.toDataURL({ pixelRatio: 2 })`

14. **複数人での協調注釈**
    - リアルタイム同期機能
    - **実装方法**: Firestore `onSnapshot`リスナー

15. **注釈テンプレート機能**
    - よく使う図形や記号を保存
    - ワンクリックで挿入

### 10.4. Konva.jsコンポーネント設計

```
ArtworkModal（モーダル本体）
├── 画像表示エリア
│   ├── 通常モード: <img> 要素
│   └── 注釈モード: <AnnotationCanvas>
│       ├── react-konva Stage
│       │   ├── backgroundLayer: 背景画像（Image）
│       │   └── drawingLayer: 注釈レイヤー（Line群）
│       ├── ツールバー（色・太さ・モード切替）
│       └── 保存ボタン
└── サイドバー
    ├── 作品情報
    ├── いいね・コメント
    ├── ラベル
    └── 注釈ボタン（トグル）
```

**Konva.js実装の主要コンポーネント:**
```tsx
<Stage width={width} height={height}>
  <Layer name="background">
    <Image image={backgroundImage} />
  </Layer>
  <Layer name="drawing">
    {lines.map(line => (
      <Line
        key={line.id}
        points={line.points}
        stroke={line.color}
        strokeWidth={line.width}
        tension={0.5}
        lineCap="round"
        lineJoin="round"
        draggable={!isDrawing}
      />
    ))}
  </Layer>
</Stage>
```

### 10.5. データフロー

```
1. ユーザーが注釈ボタンをクリック
   ↓
2. AnnotationCanvasを表示
   ↓
3. Firestoreから該当ページの注釈データ取得
   ↓
4. Node.create(jsonData) でKonva.jsオブジェクトを復元
   ↓
5. ユーザーが描画・編集
   ↓
6. 保存ボタンクリック
   ↓
7. stage.toJSON() でJSONエクスポート
   ↓
8. Firestoreに保存（updateDoc）
   ↓
9. 楽観的UI更新（ローカルステート更新）
```

### 10.6. パフォーマンス考慮事項

- **キャンバスサイズ**: 画像の元サイズを維持（高解像度対応）
- **遅延読み込み**: Konva.jsとreact-konvaは動的インポート（`lazy(() => import())`）で必要時のみ読み込み
- **メモリ管理**: モーダルを閉じる際に `stage.destroy()` で適切にクリーンアップ
- **データサイズ**: 1ページあたり5〜10KB程度、Firestoreドキュメント上限（1MB）に対して十分な余裕
- **Layer分離**: 背景画像と描画レイヤーを分離することで、再描画を最適化

### 10.7. セキュリティ考慮事項

- **権限チェック**: Firestore Security Rulesで管理者のみ注釈データの書き込みを許可
- **データ検証**: 注釈データのサイズ制限（最大100KB程度）
- **XSS対策**: Konva.jsのJSON形式は安全（scriptタグなどは含まれない、座標データと色情報のみ）

### 10.8. 開発見積もりと優先順位

#### 総開発時間見積もり

| フェーズ | 内容 | 優先度 | 見積もり工数 | 累計工数 |
|:---------|:-----|:-------|:-------------|:---------|
| フェーズ1 | 基本体験の改善 | 最高 | 1-2日 | 1-2日 |
| フェーズ2 | 高度な操作性 | 高 | 2-3日 | 3-5日 |
| フェーズ3 | 効率化機能 | 高 | 1-2日 | 4-7日 |
| フェーズ4 | 高度な描画ツール | 中 | 2-3日 | 6-10日 |
| フェーズ5 | 将来的な拡張 | 低 | 未定 | - |

**推奨実装順序**: フェーズ1 → フェーズ2 → フェーズ3 → フェーズ4

各フェーズ完了後にユーザーテストを実施し、フィードバックを次フェーズに反映します。

#### 技術的リスクと対策

**リスク1: ズーム・パン連携の複雑性**
- リスク: Konva.jsのStage座標系と注釈座標系の変換が複雑
- 対策: 段階的実装（まずズームのみ、次にパン）、十分なテスト時間確保

**リスク2: パフォーマンス劣化**
- リスク: 大量の注釈（100本以上の線）でレンダリングが重くなる
- 対策: `perfectDrawEnabled: false`、レイヤーキャッシング、仮想化

**リスク3: マルチタッチ対応のデバイス依存**
- リスク: 全てのタッチデバイスで筆圧検知できるわけではない
- 対策: 機能検出でフォールバック、テスト環境の充実

### 10.9. 既知の制約事項（現在の実装）

- ✅ 注釈モードでは画像のズーム・パン機能が無効化される → フェーズ2で対応予定
- ✅ カラーピッカーによる色選択 → フェーズ1でプリセットパレット方式に変更予定
- ✅ 線の太さは1-30pxのスライダー調整 → フェーズ1でプリセット（細・中・太）に変更予定
- ✅ Undo/Redo機能は未実装 → フェーズ2で対応予定
- ✅ 消しゴムツール（部分削除）は未実装 → フェーズ2で対応予定
- ✅ 自動保存機能なし（手動保存のみ） → フェーズ1で対応予定
- ✅ キーボードショートカットなし → フェーズ3で対応予定

### 10.10. アクセシビリティ考慮事項

注釈機能は視覚的な操作が中心ですが、以下の点でアクセシビリティを向上させます：

- **キーボード操作対応**: 全ての機能をキーボードショートカットでアクセス可能（フェーズ3）
- **ツールチップ**: 各ボタンにホバー時の説明を表示（aria-label付き）
- **高コントラスト対応**: 選択中の線は明確なシャドウエフェクトで強調
- **フォーカスインジケーター**: キーボードフォーカス時に視覚的に表示
- **スクリーンリーダー対応**: 主要な操作にaria-live領域で状態通知

### 10.11. 今後の検討事項

**UIパターンの参考**
- Adobe Photoshop: ツールパレット、レイヤー構造
- Figma: キーボードショートカット、ツール切り替え
- Procreate: タッチジェスチャー、ブラシプリセット

**競合サービス分析**
- Miro: 協調注釈、リアルタイム同期
- Notion: 軽量な注釈機能、シンプルなUI

**ユーザーフィードバック収集計画**
- フェーズ1完了後: 教員5名によるα版テスト
- フェーズ3完了後: 実際の講評会でβ版テスト（学生30名規模）
- フィードバック項目:
  - ツールの使いやすさ（5段階評価）
  - 不足している機能
  - パフォーマンス（描画の遅延感）
  - バグ報告
