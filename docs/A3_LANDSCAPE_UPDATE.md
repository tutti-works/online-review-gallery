# A3横向き対応への設定変更

## 問題の発見

**当初の設定（2400px）の問題点:**

A3横向き（420mm × 297mm）を200 DPIで計算すると：
```
幅: 420mm ÷ 25.4mm × 200 DPI = 3,307 px
高さ: 297mm ÷ 25.4mm × 200 DPI = 2,339 px
```

2400px制限では：
```
縮小後: 2,400px × 1,698px
不足: 907px（横幅の27%不足）
```

**結論: A3横向き全画面表示には不十分**

---

## 修正内容

### 新設定: 3400px

```typescript
// 修正前
const OPTIMIZED_IMAGE_SIZE = 2400;

// 修正後
const OPTIMIZED_IMAGE_SIZE = 3400;
```

**根拠:**
```
A3横向き: 420mm × 297mm
200 DPI: 3,307px × 2,339px
余裕を持って: 3,400px
```

**対応解像度:**
- ✅ A3横向き（420×297mm）: 完全対応
- ✅ A3縦向き（297×420mm）: 完全対応
- ✅ 4Kディスプレイ（3840×2160）: ほぼ対応
- ✅ 5Kディスプレイ（5120×2880）: 短辺は対応

---

## 影響の再評価

### 1. ファイルサイズ

#### 1ページあたり

| 設定 | サイズ | JPEG品質 | ファイルサイズ |
|------|--------|----------|--------------|
| 旧（1920px） | 1920×1920 | 85% | 800KB |
| 中（2400px） | 2400×2400 | 85% | 1.2MB |
| **新（3400px）** | **3400×2400** | **85%** | **1.8MB** |

**計算:**
```
3400px × 2400px = 8,160,000 ピクセル
JPEG 85%品質: 約0.22 bytes/pixel
ファイルサイズ: 8,160,000 × 0.22 = 1,795,200 bytes ≈ 1.8MB
```

#### 1ファイル（2.5ページPDF）

```
画像: 2.5ページ × 1.8MB = 4.5MB
サムネイル: 50KB
合計: 約4.55MB
```

**比較:**
- 旧（1920px）: 2MB
- 中（2400px）: 3MB
- **新（3400px）: 4.5MB (+125%)**

---

### 2. 処理時間

#### Sharp処理時間の変化

```
処理時間 ≈ ピクセル数^1.2

1920px: 1920² = 3,686,400 ピクセル → 基準
2400px: 2400² = 5,760,000 ピクセル → +40%
3400px: 3400×2400 = 8,160,000 ピクセル → +80%
```

#### 1ファイルあたりの処理時間

| 設定 | 処理時間 | 変化 |
|------|---------|------|
| 1920px、150 DPI | 15秒 | 基準 |
| 2400px、200 DPI | 25秒 | +67% |
| **3400px、200 DPI** | **35秒** | **+133%** |

**内訳:**
```
Storageダウンロード: 1秒
pdf2pic変換（200 DPI、2.5ページ）: 15秒
Sharp最適化（3400px、2.5ページ）: 12秒
サムネイル生成: 2秒
Storageアップロード: 3秒
一時ファイル削除: 1秒
---
合計: 約35秒
```

#### 70人分のインポート時間

```
importClassroomSubmissions: 4分40秒（変化なし）
processFileTask（10並列）:
  - 70ファイル ÷ 10 = 7バッチ
  - 7バッチ × 35秒 = 245秒（4分5秒）
---
合計: 約9分
```

**比較:**
- 旧（1920px）: 6分
- 中（2400px）: 8分
- **新（3400px）: 9分 (+50%)**

---

### 3. Cloud Functions無料枠への影響

#### GB秒の再計算

**processFileTask（70ファイル）:**
```
1ファイル: 2GB × 35秒 = 70 GB秒
70ファイル: 70 × 70 = 4,900 GB秒
```

**importClassroomSubmissions:**
```
1GB × 280秒 = 280 GB秒
```

**合計（1回のインポート）:**
```
4,900 + 280 = 5,180 GB秒/週
```

**月間（4週）:**
```
5,180 × 4 = 20,720 GB秒/月
```

**無料枠との比較:**
```
使用量: 20,720 GB秒/月
無料枠: 400,000 GB秒/月
使用率: 5.2%
```

**結果: ✅ まだ無料枠内（余裕）**

---

### 4. ネットワーク転送

#### 1回の講評会

```
1ファイル: 4.5MB
70ファイル: 315MB

学生70人閲覧: 315MB
教員閲覧: 315MB
複数回リロード（3回）: 945MB

合計: 約1,260MB/週 = 1.26GB/週
```

#### 月間（4週）

```
1.26GB × 4 = 5.04GB/月
```

**無料枠との比較:**
```
使用量: 5.04GB/月
無料枠: 5GB/月
使用率: 100.8%
```

**⚠️ わずかに超過（40MB）**
```
超過分: 0.04GB × $0.12 = $0.005/月（約¥0.75/月）
```

---

## コスト再計算（3400px設定）

### 月間コスト（70人 × 週1回）

| 項目 | 使用量 | 無料枠 | 超過分 | 料金 |
|------|--------|--------|--------|------|
| Cloud Functions（呼び出し） | 364回 | 200万回 | - | $0 |
| Cloud Functions（GB秒） | 20,720 | 40万 | - | $0 |
| Cloud Storage | 315MB/週 | - | - | $0.024/月 |
| ネットワーク | 5.04GB | 5GB | 0.04GB | $0.005/月 |
| Firestore | 少量 | 十分 | - | $0 |
| **合計** | - | - | - | **$0.029/月** |

### 年間コスト（40週）

```
Cloud Storage: 12.6GB × $0.023 = $0.29/年
ネットワーク超過: $0.005 × 10ヶ月 = $0.05/年

合計: $0.34/年（約¥51/年）
```

**比較:**
- 旧（1920px）: ¥30/年
- 中（2400px）: ¥30/年
- **新（3400px）: ¥51/年**

**評価: 依然として非常に安い**

---

## 代替案の検討

### オプション1: 現在の設定（3400px）をそのまま使用

**メリット:**
- ✅ A3横向き完全対応
- ✅ 4Kディスプレイでも綺麗
- ✅ プロジェクター全画面で鮮明
- ✅ コストは依然として安い（年¥51）

**デメリット:**
- ⚠️ インポート時間+50%（9分）
- ⚠️ ファイルサイズ+125%（4.5MB）
- ⚠️ ネットワーク無料枠わずかに超過

**推奨度: ★★★★☆（推奨）**

---

### オプション2: 2800pxに妥協

```typescript
const OPTIMIZED_IMAGE_SIZE = 2800;
```

**妥協点:**
```
A3横向き必要: 3,307px
設定: 2,800px
不足: 507px（-15%）
```

**4Kディスプレイ（3840×2160）での表示:**
- 横幅: 2,800px / 3,840px = 73%表示
- **まあまあ綺麗（許容範囲）**

**メリット:**
- ✅ ファイルサイズ: 3MB（中程度）
- ✅ 処理時間: 28秒（許容範囲）
- ✅ ネットワーク: 3.9GB/月（無料枠内）

**デメリット:**
- ⚠️ A3全画面表示で若干粗い

**推奨度: ★★★☆☆（妥協案）**

---

### オプション3: PDF DPIを下げる（150に戻す）

```typescript
const OPTIMIZED_IMAGE_SIZE = 3400;
density: 150; // 200から150に
```

**効果:**
```
処理時間: 35秒 → 28秒（-20%）
ファイルサイズ: 変化なし（Sharpで3400pxにするため）
```

**メリット:**
- ✅ 処理時間短縮

**デメリット:**
- ⚠️ PDF→画像変換時の品質低下
- ⚠️ 細かい文字が若干ぼやける

**推奨度: ★★☆☆☆（非推奨）**

---

## 推奨設定

### ✅ **現在の設定（3400px、200 DPI）を推奨**

```typescript
const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20MB
const OPTIMIZED_IMAGE_SIZE = 3400; // A3横向き完全対応
const IMAGE_QUALITY = 85;
const PDF_DPI = 200;
```

**理由:**
1. **A3横向き完全対応** - 大学講評会の主な用途
2. **コストは依然として安い** - 年¥51
3. **処理時間は許容範囲** - 9分で完了
4. **画質優先** - 作品の細部まで鮮明

---

## ネットワーク超過への対策

### 対策1: 気にしない（推奨）

```
超過分: 月¥0.75、年¥8
合計コスト: 年¥51

評価: 十分安い
```

### 対策2: Cloud CDN有効化

**効果:**
- キャッシュヒット率70%と仮定
- ネットワーク転送: 5.04GB → 1.51GB（-70%）
- 無料枠内に収まる

**コスト:**
```
CDNキャッシュ料金: $0.04/GB = $0.2/月（¥30/月）
ネットワーク超過分削減: -$0.06/月（-¥9/月）

差額: +¥21/月
```

**評価: 不要（超過分が安いため）**

---

## まとめ

### 最終設定

```typescript
const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20MB
const OPTIMIZED_IMAGE_SIZE = 3400; // A3横向き完全対応
const THUMBNAIL_SIZE = 400;
const IMAGE_QUALITY = 85;
const PDF_DPI = 200;
const MAX_PDF_PAGES = 50;
```

### パフォーマンス

| 項目 | 値 |
|------|-----|
| インポート時間（70人） | 9分 |
| 1ファイルサイズ（2.5ページ） | 4.5MB |
| 年間コスト | ¥51 |

### ディスプレイ対応

| ディスプレイ | 解像度 | 対応状況 |
|------------|--------|---------|
| フルHD | 1920×1080 | ✅ 完璧 |
| 4K | 3840×2160 | ✅ ほぼ完璧 |
| A3横向き | 3307×2339 | ✅ 完璧 |
| A3縦向き | 2339×3307 | ✅ 完璧 |
| プロジェクター | 様々 | ✅ 鮮明 |

**✅ A3横向き全画面表示に完全対応！**
