# テストシナリオ

このドキュメントは、Online Review Galleryの主要機能に関するテストシナリオを記載します。

---

## 1. 再インポートスキップ・上書き機能のテスト

### 1.1. ケース1: 初回インポート

**手順**:
1. 新しい課題を選択
2. インポートを実行

**期待結果**:
- 全ての提出済み学生の作品が生成される
- 未提出学生のプレースホルダーが生成される
- スキップ数は0
- 上書き数は0

---

### 1.2. ケース2: submitted作品の再インポート

**前提**: 70人全員が正常提出済み

**手順**:
1. 既にインポート済みの課題を再度インポート

**期待結果**:
- 全ての学生がスキップされる（status: 'submitted'）
- 新しい作品は生成されない
- スキップ数 = 70
- 上書き数 = 0

---

### 1.3. ケース3: not_submitted → submitted（後日提出）

**前提**: 初回インポート時に未提出だった学生Aが後日提出

**手順**:
1. 学生Aが課題を提出
2. 再度インポートを実行

**期待結果**:
- 既存のsubmitted作品はスキップされる
- 学生Aのnot_submitted作品が上書きされる
- 学生Aの作品が`status: 'submitted'`に更新される
- 既存ドキュメントIDは維持される
- スキップ数 = 69
- 上書き数 = 1

---

### 1.4. ケース4: error → submitted（ファイル修正後再提出）

**前提**: 学生Bがdocxファイルでエラーになっていたが、PDFで再提出

**手順**:
1. 学生BがPDFファイルで再提出
2. 再度インポートを実行

**期待結果**:
- 学生Bのerror作品が上書きされる
- 学生Bの作品が`status: 'submitted'`に更新される
- 画像が生成される
- スキップ数 = 69
- 上書き数 = 1

---

### 1.5. ケース5: submitted → not_submitted（提出取り消し）

**前提**: 学生CがClassroom上で提出を取り消した

**手順**:
1. Google Classroom上で学生Cの提出を削除
2. 再度インポートを実行

**期待結果**:
- 学生Cのsubmitted作品は**スキップされる**（submitted作品は保護）
- 提出取り消しは反映されない
- スキップ数 = 70
- 上書き数 = 0

**注意**: submitted作品は絶対に保護される仕様

---

### 1.6. ケース6: not_submitted → error（サポート外形式提出）

**前提**: 未提出だった学生Dがdocxファイルを提出

**手順**:
1. 学生Dが.docxファイルを提出
2. 再度インポートを実行

**期待結果**:
- 学生Dのnot_submitted作品が上書きされる
- 学生Dの作品が`status: 'error'`、`errorReason: 'unsupported_format'`に更新
- スキップ数 = 69
- 上書き数 = 1

---

### 1.7. ケース7: 処理エラー後の再インポート

**前提**: 初回インポート時、学生Eの作品でメモリエラーが発生（作品未生成）

**手順**:
1. 再度インポートを実行

**期待結果**:
- 学生Eの作品が再処理される（既存作品がないため新規作成）
- 他の学生はスキップされる

---

## 2. 未提出プレースホルダーのテスト

### 2.1. ケース8: 未提出学生の表示

**手順**:
1. Google Classroomで10人に課題を割り当て
2. 7人が提出
3. インポートを実行
4. ギャラリーを表示

**期待結果**:
- 7件の通常作品が表示される
- 3件のグレーサムネイル（未提出）が表示される
- 未提出作品には「未提出」テキストが中央表示される

---

### 2.2. ケース9: 未提出作品のモーダル表示

**手順**:
1. 未提出のグレーサムネイルをクリック

**期待結果**:
- モーダルが開く
- 学生名、メールアドレス、学籍番号が表示される
- 「この課題は未提出です」というメッセージが表示される
- いいね・コメント・ラベル機能は表示されない

---

## 3. エラー作品のテスト

### 3.1. ケース10: サポートされていないファイル形式

**手順**:
1. 学生Fが.docxファイルを提出
2. インポートを実行
3. ギャラリーを表示

**期待結果**:
- 学生Fの作品がグレーサムネイル（エラー）で表示される
- サムネイルに「エラー」テキストが中央表示される
- `errorReason: 'unsupported_format'`

---

### 3.2. ケース11: エラー作品のモーダル表示

**手順**:
1. エラー作品のグレーサムネイルをクリック

**期待結果**:
- モーダルが開く
- エラーメッセージ「サポートされていないファイル形式」が表示される
- 提出されたファイル一覧が表示される
- 対応形式の説明が表示される

---

## 4. 並び替えのテスト

### 4.1. ケース12: 提出日時順（早い順）

**手順**:
1. ギャラリーを表示
2. 「提出日時（早い順）」を選択

**期待結果**:
- 提出済み作品が提出日時の早い順に表示される
- 未提出・エラー作品が末尾に学籍番号順で表示される

---

### 4.2. ケース13: 学籍番号順

**手順**:
1. ギャラリーを表示
2. 「学籍番号（A→Z）」を選択

**期待結果**:
- 全作品（提出済み、未提出、エラー）が学籍番号順に混在表示される
- メールアドレスから抽出した学籍番号で正しくソート

---

## 5. フィルタリングのテスト

### 5.1. ケース14: 未提出/エラーを非表示

**手順**:
1. ギャラリーを表示（提出済み7件、未提出2件、エラー1件）
2. 「未提出/エラーを非表示」にチェックを入れる

**期待結果**:
- 提出済み作品7件のみ表示される
- 「(3件 非表示中)」というメッセージが表示される

---

### 5.2. ケース15: ラベルフィルターと併用

**手順**:
1. 「赤-5」ラベルでフィルター
2. 「未提出/エラーを非表示」にチェックを入れる

**期待結果**:
- 「赤-5」ラベルがついた提出済み作品のみ表示される
- 未提出・エラー作品は表示されない

---

## 6. 上書き時のartworkCount整合性テスト

### 6.1. ケース16: 上書き時のカウント維持

**前提**: ギャラリーに`artworkCount: 70`（all submitted）

**手順**:
1. 学生3人の作品を手動削除（submitted → 削除）
2. 同じ3人が未提出に戻る
3. インポート実行（not_submittedプレースホルダー生成）

**期待結果（現行仕様）**:
- 3つのnot_submittedプレースホルダーが上書きで作成される
- 既存ドキュメントIDは再利用されないため、新規ID生成
- `artworkCount: 70 + 3 = 73`

**⚠️ 注意**: 手動削除後は再インポートでカウントが増加する可能性あり

---

## 7. 重複インポート防止のテスト

### 7.1. ケース17: 大文字小文字の違い

**手順**:
1. `student@example.com`が提出済み
2. Classroom APIが`Student@Example.COM`を返す
3. 再インポート実行

**期待結果**:
- `normalizeIdentifier()`により正規化される
- 同一学生と判定され、スキップされる
- 重複作品は生成されない

---

### 7.2. ケース18: 前後の空白

**手順**:
1. ` student@example.com `（前後に空白）が初回インポートで登録
2. `student@example.com`で再インポート

**期待結果**:
- `trim()`により正規化される
- 同一学生と判定され、スキップされる

---

## 8. Firestore最適化のテスト（2025-11-06実装）

### 8.1. ケース19: ギャラリー切り替え時の読み取り

**手順**:
1. ギャラリーAを表示（70作品読み取り）
2. ギャラリーBに切り替え（70作品読み取り）
3. ギャラリーAに戻る

**期待結果（最適化後）**:
- ギャラリーAへの戻り時: 0回読み取り（キャッシュ使用）
- React Hooks依存配列最適化により再取得なし

**期待結果（最適化前）**:
- ギャラリーAへの戻り時: 70回読み取り（毎回再取得）

---

## 9. パフォーマンステスト

### 9.1. ケース20: 70人分のインポート時間

**手順**:
1. 70人分のPDF提出（平均5MB、2.5ページ）をインポート

**期待結果**:
- 処理時間: 8～10分以内
- Cloud Tasks並列処理が正常動作
- メモリエラーなし

---

### 9.2. ケース21: 大容量ファイル処理

**手順**:
1. 20MBのPDFを提出
2. インポート実行

**期待結果**:
- 正常に処理される
- メモリ2GBで収まる

---

### 9.3. ケース22: 50ページPDF処理

**手順**:
1. 50ページのPDFを提出
2. インポート実行

**期待結果**:
- 全50ページが画像変換される
- タイムアウトなし
- 処理時間: 約500秒以内

---

## 10. エッジケーステスト

### 10.1. ケース23: メールアドレスなしの学生

**手順**:
1. Classroom APIがメールアドレスを返さない学生がいる
2. インポート実行

**期待結果**:
- エラーログ出力
- その学生はスキップされる
- 他の学生は正常処理

---

### 10.2. ケース24: 0ページのPDF

**手順**:
1. 破損したPDF（0ページ）を提出
2. インポート実行

**期待結果**:
- `status: 'error'`、`errorReason: 'processing_error'`として記録
- エラー作品プレースホルダーが生成

---

## 関連ドキュメント

- [再インポート機能仕様](import-skip-and-placeholders.md)
- [要件定義](requirements.md)
- [変更履歴](changelog.md)

---

**ドキュメントバージョン**: 1.0
**最終更新**: 2025-11-20
**抽出元**: import-skip-and-placeholders.md セクション6
