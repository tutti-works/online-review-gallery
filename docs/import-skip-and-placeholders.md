# å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¹ã‚­ãƒƒãƒ—ã¨æœªæå‡ºãƒ»ã‚¨ãƒ©ãƒ¼ä½œå“ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼æ©Ÿèƒ½ å®Ÿè£…ä»•æ§˜æ›¸

âœ… **å®Ÿè£…å®Œäº†æ—¥**: 2025-11-06
ğŸ“ **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿

## 1. æ¦‚è¦

### 1.1. æ©Ÿèƒ½ã®ç›®çš„

æœ¬æ©Ÿèƒ½ã¯ã€Google Classroomã‹ã‚‰èª²é¡Œã‚’å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹éš›ã®åˆ©ä¾¿æ€§å‘ä¸Šã‚’ç›®çš„ã¨ã™ã‚‹ã€‚ä»¥ä¸‹ã®3ã¤ã®ä¸»è¦æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ãŸï¼š

1. **å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¹ã‚­ãƒƒãƒ—æ©Ÿèƒ½** âœ…: æ—¢ã«ä½œå“ãŒå­˜åœ¨ã™ã‚‹å­¦ç”Ÿã®å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€é‡è¤‡ä½œå“ã®ç”Ÿæˆã‚’é˜²ã
2. **æœªæå‡ºå­¦ç”Ÿã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ä½œå“** âœ…: Google Classroomã§ã€Œå‰²ã‚Šå½“ã¦æ¸ˆã¿ã€ã ãŒæå‡ºã—ã¦ã„ãªã„å­¦ç”Ÿç”¨ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ä½œå“ã‚’è‡ªå‹•ç”Ÿæˆ
3. **ã‚¨ãƒ©ãƒ¼ä½œå“ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼** âœ…: ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã®æå‡ºã«å¯¾ã™ã‚‹ã‚¨ãƒ©ãƒ¼ä½œå“ã‚’ç”Ÿæˆ

### 1.2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼

**AS A** æ•™å“¡ï¼ˆç®¡ç†è€…ï¼‰
**I WANT TO** åŒã˜èª²é¡Œã‚’å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã‚‚é‡è¤‡ä½œå“ãŒä½œã‚‰ã‚Œãªã„ã‚ˆã†ã«ã—ãŸã„
**SO THAT** å­¦ç”Ÿã®æå‡ºçŠ¶æ³ã‚’ä¸€è¦§ã§æŠŠæ¡ã§ãã€å‡¦ç†ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸä½œå“ã®ã¿å†å‡¦ç†ã§ãã‚‹

**AS A** æ•™å“¡ï¼ˆç®¡ç†è€…ï¼‰
**I WANT TO** æœªæå‡ºã®å­¦ç”Ÿã‚‚ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã—ãŸã„
**SO THAT** èª°ãŒæå‡ºã—ã¦ã„ãªã„ã‹ä¸€ç›®ã§åˆ†ã‹ã‚Šã€è¬›è©•ä¼šã§å…¨å“¡ã®çŠ¶æ³ã‚’æŠŠæ¡ã§ãã‚‹

**AS A** æ•™å“¡ï¼ˆç®¡ç†è€…ï¼‰
**I WANT TO** ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸä½œå“ã‚’è¦–è¦šçš„ã«è­˜åˆ¥ã—ãŸã„
**SO THAT** ã©ã®å­¦ç”Ÿã®ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒå•é¡Œãªã®ã‹å³åº§ã«åˆ¤æ–­ã§ãã‚‹

### 1.3. è§£æ±ºã—ãŸå•é¡Œï¼ˆå®Ÿè£…å‰ã®èª²é¡Œï¼‰

- ~~å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã«æ—¢å­˜ã®ä½œå“ãŒé‡è¤‡ã—ã¦ä½œæˆã•ã‚Œã‚‹~~ â†’ âœ… **è§£æ±º**: `galleryId + studentEmail` ã®çµ„ã¿åˆã‚ã›ã§é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè£…
- ~~æœªæå‡ºã®å­¦ç”Ÿã¯ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã«è¡¨ç¤ºã•ã‚Œãšã€æå‡ºçŠ¶æ³ã®å…¨ä½“åƒãŒæŠŠæ¡ã§ããªã„~~ â†’ âœ… **è§£æ±º**: æœªæå‡ºå­¦ç”Ÿç”¨ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ä½œå“ã‚’è‡ªå‹•ç”Ÿæˆ
- ~~ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ï¼ˆ.docxç­‰ï¼‰ã®æå‡ºãŒã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã«ã—ã‹è¨˜éŒ²ã•ã‚Œãªã„~~ â†’ âœ… **è§£æ±º**: ã‚¨ãƒ©ãƒ¼ä½œå“ã¨ã—ã¦ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã«è¡¨ç¤º

---

## 2. æ©Ÿèƒ½ä»•æ§˜

### 2.1. å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¹ã‚­ãƒƒãƒ—ã¨ä¸Šæ›¸ãæ©Ÿèƒ½ (F-02-07)

âœ… **2025-11-20æ›´æ–°**: `status` ã«åŸºã¥ãä¸Šæ›¸ããƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…

#### 2.1.1. åˆ¤å®šã‚­ãƒ¼

- **`galleryId + studentEmail`** ã®çµ„ã¿åˆã‚ã›ã§æ—¢å­˜ä½œå“ã‚’åˆ¤å®šã™ã‚‹
- `submissionId` ã¯å«ã‚ãªã„ï¼ˆåŒã˜å­¦ç”Ÿã®å†æå‡ºã‚‚æ—¢å­˜ä½œå“ã¨ã—ã¦æ‰±ã†ï¼‰

#### 2.1.2. å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼

æ—¢å­˜ä½œå“ã® `status` ã«åŸºã¥ã„ã¦ã€ã‚¹ã‚­ãƒƒãƒ—ã¾ãŸã¯ä¸Šæ›¸ãã‚’åˆ¤å®šã™ã‚‹ï¼š

```typescript
// æ—¢å­˜ä½œå“ã‚’ Map ã§ç®¡ç†ï¼ˆstatusæƒ…å ±ã‚‚å«ã‚€ï¼‰
const existingArtworksByEmail = new Map<string, ExistingArtworkInfo>();
existingArtworksSnapshot.docs.forEach(doc => {
  const data = doc.data();
  const normalized = normalizeIdentifier(data.studentEmail);
  existingArtworksByEmail.set(normalized, {
    id: doc.id,
    status: data.status || 'submitted',
    studentEmail: data.studentEmail,
  });
});

// å„æå‡ºç‰©ã«å¯¾ã—ã¦å‡¦ç†ã‚’åˆ¤å®š
const existingArtwork = existingArtworksByEmail.get(normalizedEmail);
if (existingArtwork) {
  if (existingArtwork.status === 'submitted') {
    // âœ… æ­£å¸¸æå‡ºæ¸ˆã¿ â†’ ã‚¹ã‚­ãƒƒãƒ—
    console.log(`â­ï¸ Skipping ${studentEmail} - already submitted`);
    skippedCount++;
    continue;
  } else {
    // ğŸ”„ æœªæå‡ºãƒ»ã‚¨ãƒ©ãƒ¼ â†’ ä¸Šæ›¸ã
    console.log(`ğŸ”„ Overwriting ${studentEmail} (current status: ${existingArtwork.status})`);
    overwriteCount++;
  }
}
```

#### 2.1.3. ã‚¹ã‚­ãƒƒãƒ—ãƒ»ä¸Šæ›¸ãåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

| æ—¢å­˜ä½œå“ã®çŠ¶æ…‹ | Classroomã®æå‡ºçŠ¶æ…‹ | å‡¦ç† | ç†ç”± |
|---|---|---|---|
| `submitted` | æ­£å¸¸æå‡º | **ã‚¹ã‚­ãƒƒãƒ—** | æ­£å¸¸æå‡ºæ¸ˆã¿ã¯ä¿è­· |
| `submitted` | æœªæå‡º/ã‚¨ãƒ©ãƒ¼ | **ã‚¹ã‚­ãƒƒãƒ—** | ã‚ã‚Šãˆãªã„ã‚±ãƒ¼ã‚¹ |
| `not_submitted` | æ­£å¸¸æå‡º | **ä¸Šæ›¸ã** âœ… | å¾Œæ—¥æå‡ºã—ãŸå­¦ç”Ÿã‚’åæ˜  |
| `not_submitted` | æœªæå‡º | **ä¸Šæ›¸ã** | æœ€æ–°çŠ¶æ…‹ã‚’ç¶­æŒ |
| `not_submitted` | ã‚¨ãƒ©ãƒ¼æå‡º | **ä¸Šæ›¸ã** | ã‚µãƒãƒ¼ãƒˆå¤–å½¢å¼æå‡ºã‚’è¨˜éŒ² |
| `error` | æ­£å¸¸æå‡º | **ä¸Šæ›¸ã** âœ… | ãƒ•ã‚¡ã‚¤ãƒ«ä¿®æ­£å¾Œã®å†æå‡ºã‚’åæ˜  |
| `error` | æœªæå‡º | **ä¸Šæ›¸ã** | æå‡ºå–ã‚Šæ¶ˆã—ã‚’åæ˜  |
| `error` | ã‚¨ãƒ©ãƒ¼æå‡º | **ä¸Šæ›¸ã** | ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’ç¶­æŒ |

**è¨­è¨ˆæ€æƒ³**:
- âœ… **`submitted` ä½œå“ã¯çµ¶å¯¾ã«ã‚¹ã‚­ãƒƒãƒ—**ï¼ˆæ­£å¸¸æå‡ºã‚’ä¿è­·ï¼‰
- ğŸ”„ **`not_submitted` / `error` ä½œå“ã¯å¸¸ã«ä¸Šæ›¸ã**ï¼ˆæœ€æ–°çŠ¶æ…‹ã‚’åæ˜ ï¼‰

#### 2.1.4. ä¸Šæ›¸ãæ™‚ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‡¦ç†

ä¸Šæ›¸ãæ™‚ã¯ã€æ—¢å­˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚’å†åˆ©ç”¨ã—ã¦ `set({ merge: true })` ã§æ›´æ–°ï¼š

```typescript
// æ—¢å­˜ä½œå“IDã‚’ä¿æŒ
const artworkRef = existingArtworkId
  ? db.collection('artworks').doc(existingArtworkId)
  : db.collection('artworks').doc(); // æ–°è¦ä½œå“

// ä¸Šæ›¸ãæ™‚ã¯ artworkCount ã‚’å¢—ã‚„ã•ãªã„
await artworkRef.set(artworkData, { merge: true });

if (!existingArtworkId) {
  // æ–°è¦ä½œå“ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆå¢—åŠ 
  await db.collection('galleries').doc(galleryId).update({
    artworkCount: FieldValue.increment(1),
  });
}
```

#### 2.1.5. ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†æ™‚ã®è¡¨ç¤º

```typescript
console.log(`
ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†:
- æ–°è¦å‡¦ç†: ${newStudentCount}ä»¶
- ä¸Šæ›¸ã: ${overwriteCount}ä»¶  // âœ… 2025-11-20è¿½åŠ 
- ã‚¹ã‚­ãƒƒãƒ—: ${skippedCount}ä»¶
- ã‚¨ãƒ©ãƒ¼: ${errorCount}ä»¶
`);
```

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ç”»é¢ã«ã‚‚ä¸Šæ›¸ãæ•°ã‚’è¡¨ç¤ºã™ã‚‹ã€‚

**ImportJob ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®æ‹¡å¼µ**:
```typescript
interface ImportJob {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  overwrittenCount?: number;  // âœ… 2025-11-20è¿½åŠ 
}
```

---

### 2.2. æœªæå‡ºå­¦ç”Ÿã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ä½œå“ (F-02-08)

#### 2.2.1. æœªæå‡ºå­¦ç”Ÿã®åˆ¤å®šãƒ•ãƒ­ãƒ¼

```
1. Google Classroom APIã‹ã‚‰ã€Œå‰²ã‚Šå½“ã¦æ¸ˆã¿ã€å­¦ç”Ÿãƒªã‚¹ãƒˆã‚’å–å¾—
   â†“
2. æå‡ºæ¸ˆã¿å­¦ç”Ÿã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
   â†“
3. å·®åˆ†ã‚’å–ã‚Šã€æœªæå‡ºå­¦ç”Ÿã‚’ç‰¹å®š
   â†“
4. å„æœªæå‡ºå­¦ç”Ÿã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ä½œå“ã‚’ç”Ÿæˆ
```

#### 2.2.2. Google Classroom APIå‘¼ã³å‡ºã—

```typescript
// functions/src/importController.ts å†…
async function listAssignedStudents(
  courseId: string,
  accessToken: string
): Promise<Student[]> {
  const response = await fetch(
    `https://classroom.googleapis.com/v1/courses/${courseId}/students`,
    {
      headers: { Authorization: `Bearer ${accessToken}` },
    }
  );

  if (!response.ok) {
    throw new Error('Failed to fetch assigned students');
  }

  const data = await response.json();
  return data.students || [];
}
```

**å¿…è¦ãªã‚¹ã‚³ãƒ¼ãƒ—**: `classroom.courses.readonly`, `classroom.rosters.readonly`, `classroom.profile.emails` ã®ã„ãšã‚Œã‹ï¼ˆç¾åœ¨ã® `studentsubmissions.students.readonly` ã§å–å¾—å¯èƒ½ï¼‰

#### 2.2.3. ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ä½œå“ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```typescript
interface NotSubmittedArtwork {
  id: string;                      // Firestore auto-generated ID
  galleryId: string;
  classroomId: string;
  assignmentId: string;

  status: 'not_submitted';         // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

  studentName: string;             // Classroom APIã‹ã‚‰å–å¾—
  studentEmail: string;            // åˆ¤å®šã‚­ãƒ¼
  studentId?: string;              // å­¦ç±ç•ªå·ï¼ˆå–å¾—å¯èƒ½ãªå ´åˆï¼‰

  title: string;                   // ä¾‹: "å±±ç”°å¤ªéƒ - æœªæå‡º"

  files: [];                       // ç©ºé…åˆ—
  images: [];                      // ç©ºé…åˆ—

  submittedAt: null;               // æœªæå‡ºãªã®ã§null
  isLate: false;

  likeCount: 0;
  labels: [];
  comments: [];

  createdAt: Timestamp;            // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”Ÿæˆæ—¥æ™‚
  importedBy: string;
}
```

#### 2.2.4. ç”Ÿæˆå‡¦ç†

```typescript
// functions/src/importController.ts å†…
const assignedStudents = await listAssignedStudents(classroomId, accessToken);
const submittedEmails = new Set(submissions.map(s => s.userId));

const notSubmittedStudents = assignedStudents.filter(
  student => !submittedEmails.has(student.userId)
);

for (const student of notSubmittedStudents) {
  // æ—¢å­˜ä½œå“ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
  if (existingStudentEmails.has(student.profile.emailAddress)) {
    continue;
  }

  await db.collection('artworks').add({
    galleryId,
    classroomId,
    assignmentId,
    status: 'not_submitted',
    studentName: student.profile.name.fullName,
    studentEmail: student.profile.emailAddress,
    studentId: student.profile.id,
    title: `${student.profile.name.fullName} - æœªæå‡º`,
    files: [],
    images: [],
    submittedAt: null,
    isLate: false,
    likeCount: 0,
    labels: [],
    comments: [],
    createdAt: admin.firestore.FieldValue.serverTimestamp(),
    importedBy: userEmail,
  });
}
```

---

### 2.3. ã‚¨ãƒ©ãƒ¼ä½œå“ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ (F-02-09)

#### 2.3.1. ã‚¨ãƒ©ãƒ¼ä½œå“ã®åˆ¤å®šåŸºæº–

**ã‚¨ãƒ©ãƒ¼ä½œå“ã¨ã—ã¦æ‰±ã†æ¡ä»¶**:
- æå‡ºã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒå…¨ã¦ã€ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ï¼ˆ.docx, .xlsx, .pptxç­‰ï¼‰

**ã‚¨ãƒ©ãƒ¼ä½œå“ã¨ã—ã¦æ‰±ã‚ãªã„æ¡ä»¶**:
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ¡ãƒ¢ãƒªä¸è¶³ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€PDFå¤‰æ›å¤±æ•—ç­‰ï¼‰
  â†’ ã“ã‚Œã‚‰ã¯å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§å†è©¦è¡Œå¯èƒ½ãªãŸã‚ã€ã‚¨ãƒ©ãƒ¼ä½œå“ã¯ç”Ÿæˆã—ãªã„

#### 2.3.2. ã‚¨ãƒ©ãƒ¼ä½œå“ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```typescript
interface ErrorArtwork {
  id: string;
  galleryId: string;
  classroomId: string;
  assignmentId: string;

  status: 'error';                 // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  errorReason: 'unsupported_format'; // ã‚¨ãƒ©ãƒ¼ç†ç”±

  studentName: string;
  studentEmail: string;
  studentId?: string;

  title: string;                   // ä¾‹: "å±±ç”°å¤ªéƒã®æå‡ºç‰© - ã‚¨ãƒ©ãƒ¼"

  files: SubmittedFile[];          // æå‡ºã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã¯ä¿æŒ
  images: [];                      // ç©ºé…åˆ—ï¼ˆç”»åƒç”Ÿæˆãªã—ï¼‰

  submittedAt: Timestamp;          // æå‡ºæ—¥æ™‚ã¯è¨˜éŒ²
  isLate: boolean;

  likeCount: 0;
  labels: [];
  comments: [];

  createdAt: Timestamp;
  importedBy: string;
}
```

#### 2.3.3. ç”Ÿæˆå‡¦ç†

```typescript
// functions/src/fileProcessor.ts å†…ï¼ˆprocessMultipleFilesé–¢æ•°ï¼‰

// å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†å¾Œ
if (allImages.length === 0) {
  // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚¨ãƒ©ãƒ¼ã‹ã©ã†ã‹åˆ¤å®š
  const allFilesUnsupported = files.every(f => {
    const supportedTypes = ['image/', 'application/pdf'];
    return !supportedTypes.some(type => f.type.startsWith(type));
  });

  if (allFilesUnsupported) {
    // ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã®ã¿ã®å ´åˆã€ã‚¨ãƒ©ãƒ¼ä½œå“ã‚’ç”Ÿæˆ
    const artworkData = {
      galleryId,
      classroomId,
      assignmentId,
      status: 'error',
      errorReason: 'unsupported_format',
      studentName,
      studentEmail,
      studentId,
      title: `${studentName}ã®æå‡ºç‰© - ã‚¨ãƒ©ãƒ¼`,
      files: files.map(f => ({
        id: f.id,
        name: f.name,
        type: f.type,
        originalFileUrl: f.url,
        mimeType: f.mimeType,
      })),
      images: [],
      submittedAt,
      isLate,
      likeCount: 0,
      labels: [],
      comments: [],
      createdAt: admin.firestore.FieldValue.serverTimestamp(),
      importedBy: userEmail,
    };

    await db.collection('artworks').add(artworkData);
    return { success: true, artworkId: artworkData.id };
  } else {
    // å‡¦ç†ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã€ã‚¨ãƒ©ãƒ¼ä½œå“ã‚’ç”Ÿæˆã›ãšã€ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ã¿è¨˜éŒ²
    throw new Error('Processing error occurred');
  }
}
```

---

## 3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

### 3.1. å‹å®šç¾©ã®æ›´æ–°

#### 3.1.1. src/types/index.ts

```typescript
export interface Artwork {
  id: string;
  title: string;
  galleryId: string;

  // æ–°è¦è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  status: 'submitted' | 'not_submitted' | 'error';
  errorReason?: 'unsupported_format' | 'processing_error';

  files: SubmittedFile[];
  images: ArtworkImage[];

  studentName: string;
  studentEmail: string;
  studentId?: string;

  submittedAt: Date | null;  // æœªæå‡ºã®å ´åˆã¯null
  isLate: boolean;

  classroomId: string;
  assignmentId: string;

  likeCount: number;
  labels: LabelType[];
  comments: Comment[];
  annotations?: ArtworkAnnotation[];

  createdAt: Date;
  importedBy: string;
}
```

#### 3.1.2. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®š

æ—¢å­˜ã®ä½œå“ï¼ˆstatusãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„ï¼‰ã¨ã®äº’æ›æ€§ã‚’ä¿ã¤ãŸã‚ã€å‹ã‚¬ãƒ¼ãƒ‰ã‚’å®Ÿè£…ï¼š

```typescript
// src/lib/artworkUtils.ts
export function getArtworkStatus(artwork: Artwork): 'submitted' | 'not_submitted' | 'error' {
  return artwork.status ?? 'submitted';
}

export function isSubmitted(artwork: Artwork): boolean {
  return getArtworkStatus(artwork) === 'submitted';
}

export function isNotSubmitted(artwork: Artwork): boolean {
  return getArtworkStatus(artwork) === 'not_submitted';
}

export function isError(artwork: Artwork): boolean {
  return getArtworkStatus(artwork) === 'error';
}

export function isIncomplete(artwork: Artwork): boolean {
  const status = getArtworkStatus(artwork);
  return status === 'not_submitted' || status === 'error';
}
```

---

### 3.2. ã‚°ãƒ¬ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ã®è¡¨ç¤º

#### 3.2.1. src/components/GalleryGrid.tsx

```tsx
interface ArtworkCardProps {
  artwork: Artwork;
  onClick: () => void;
}

export function ArtworkCard({ artwork, onClick }: ArtworkCardProps) {
  const status = getArtworkStatus(artwork);

  return (
    <div
      onClick={onClick}
      className="group cursor-pointer bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow"
    >
      {/* ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤º */}
      <div className="relative aspect-[3/2] bg-gray-100">
        {status === 'submitted' ? (
          // é€šå¸¸ã®ã‚µãƒ ãƒã‚¤ãƒ«
          <img
            src={artwork.images[0]?.thumbnailUrl || artwork.images[0]?.url}
            alt={artwork.title}
            className="w-full h-full object-cover"
          />
        ) : (
          // ã‚°ãƒ¬ãƒ¼ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
          <div className="w-full h-full bg-gray-300 flex items-center justify-center">
            <span className="text-gray-600 font-medium text-lg">
              {status === 'not_submitted' ? 'æœªæå‡º' : 'ã‚¨ãƒ©ãƒ¼'}
            </span>
          </div>
        )}

        {/* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æƒ…å ± */}
        <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-3">
          <p className="text-white text-sm font-medium truncate">
            {artwork.studentName}
          </p>
          {status === 'submitted' && (
            <div className="flex items-center gap-2 text-white/90 text-xs mt-1">
              <span>ğŸ‘ {artwork.likeCount}</span>
              <span>ğŸ’¬ {artwork.comments.length}</span>
              {artwork.images.length > 1 && (
                <span>ğŸ“„ {artwork.images.length}ãƒšãƒ¼ã‚¸</span>
              )}
            </div>
          )}
        </div>
      </div>

      {/* ãƒ©ãƒ™ãƒ«è¡¨ç¤ºï¼ˆæå‡ºæ¸ˆã¿ä½œå“ã®ã¿ï¼‰ */}
      {status === 'submitted' && artwork.labels.length > 0 && (
        <div className="p-2 flex gap-1 flex-wrap">
          {artwork.labels.map((label, idx) => (
            <span
              key={idx}
              className={`px-2 py-1 rounded text-xs ${getLabelStyle(label)}`}
            >
              {label}
            </span>
          ))}
        </div>
      )}
    </div>
  );
}
```

#### 3.2.2. ã‚°ãƒ¬ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ã®ãƒ‡ã‚¶ã‚¤ãƒ³ä»•æ§˜

- **èƒŒæ™¯è‰²**: `bg-gray-300` (Tailwind)
- **ãƒ†ã‚­ã‚¹ãƒˆè‰²**: `text-gray-600` (Tailwind)
- **ãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚º**: `text-lg` (18px)
- **ãƒ†ã‚­ã‚¹ãƒˆä½ç½®**: `flex items-center justify-center` ã§ä¸­å¤®é…ç½®
- **ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹**:
  - æœªæå‡º: "æœªæå‡º"
  - ã‚¨ãƒ©ãƒ¼: "ã‚¨ãƒ©ãƒ¼"
- **ã‚¢ã‚¤ã‚³ãƒ³**: ãªã—ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã®ã¿ï¼‰
- **è¿½åŠ æƒ…å ±**: ã‚¨ãƒ©ãƒ¼ç†ç”±ã®è©³ç´°ã¯è¡¨ç¤ºã—ãªã„ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã§ç¢ºèªå¯èƒ½ï¼‰

---

### 3.3. ä¸¦ã³æ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…

#### 3.3.1. src/app/gallery/page.tsx

```typescript
const sortedArtworks = useMemo(() => {
  let sorted = [...filteredArtworks];

  if (sortBy === 'submittedAt-asc' || sortBy === 'submittedAt-desc') {
    // æå‡ºæ—¥æ™‚é †: æå‡ºæ¸ˆã¿ä½œå“ã¨æœªå®Œäº†ä½œå“ã‚’åˆ†é›¢
    const submitted = sorted.filter(a => isSubmitted(a));
    const incomplete = sorted.filter(a => isIncomplete(a));

    // æå‡ºæ¸ˆã¿ä½œå“ã‚’æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
    submitted.sort((a, b) => {
      const dateA = a.submittedAt?.getTime() || 0;
      const dateB = b.submittedAt?.getTime() || 0;
      return sortBy === 'submittedAt-asc' ? dateA - dateB : dateB - dateA;
    });

    // æœªå®Œäº†ä½œå“ã‚’å­¦ç±ç•ªå·é †ã«ã‚½ãƒ¼ãƒˆ
    incomplete.sort((a, b) =>
      a.studentEmail.localeCompare(b.studentEmail)
    );

    // æå‡ºæ¸ˆã¿ â†’ æœªå®Œäº†ã®é †ã«çµåˆ
    return [...submitted, ...incomplete];

  } else if (sortBy === 'studentEmail-asc' || sortBy === 'studentEmail-desc') {
    // å­¦ç±ç•ªå·é †: å…¨ä½œå“ã‚’æ··åœ¨ã•ã›ã¦ã‚½ãƒ¼ãƒˆ
    sorted.sort((a, b) => {
      const comparison = a.studentEmail.localeCompare(b.studentEmail);
      return sortBy === 'studentEmail-asc' ? comparison : -comparison;
    });
    return sorted;

  } else {
    return sorted;
  }
}, [filteredArtworks, sortBy]);
```

#### 3.3.2. ã‚½ãƒ¼ãƒˆã®æŒ™å‹•ã¾ã¨ã‚

| ã‚½ãƒ¼ãƒˆæ–¹æ³• | æå‡ºæ¸ˆã¿ä½œå“ | æœªæå‡ºä½œå“ | ã‚¨ãƒ©ãƒ¼ä½œå“ |
|:----------|:------------|:----------|:----------|
| **æå‡ºæ—¥æ™‚ï¼ˆæ—©ã„é †ï¼‰** | æå‡ºæ—¥æ™‚ã§ã‚½ãƒ¼ãƒˆï¼ˆå…ˆé ­ï¼‰ | å­¦ç±ç•ªå·é †ï¼ˆæœ«å°¾ï¼‰ | å­¦ç±ç•ªå·é †ï¼ˆæœ«å°¾ï¼‰ |
| **æå‡ºæ—¥æ™‚ï¼ˆé…ã„é †ï¼‰** | æå‡ºæ—¥æ™‚ã§ã‚½ãƒ¼ãƒˆï¼ˆå…ˆé ­ï¼‰ | å­¦ç±ç•ªå·é †ï¼ˆæœ«å°¾ï¼‰ | å­¦ç±ç•ªå·é †ï¼ˆæœ«å°¾ï¼‰ |
| **å­¦ç±ç•ªå·ï¼ˆAâ†’Zï¼‰** | å­¦ç±ç•ªå·é †ï¼ˆæ··åœ¨ï¼‰ | å­¦ç±ç•ªå·é †ï¼ˆæ··åœ¨ï¼‰ | å­¦ç±ç•ªå·é †ï¼ˆæ··åœ¨ï¼‰ |
| **å­¦ç±ç•ªå·ï¼ˆZâ†’Aï¼‰** | å­¦ç±ç•ªå·é †ï¼ˆæ··åœ¨ï¼‰ | å­¦ç±ç•ªå·é †ï¼ˆæ··åœ¨ï¼‰ | å­¦ç±ç•ªå·é †ï¼ˆæ··åœ¨ï¼‰ |

---

### 3.4. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ã®å®Ÿè£…

#### 3.4.1. src/components/GalleryHeader.tsx

```tsx
interface GalleryHeaderProps {
  // ... æ—¢å­˜ã®props
  hideIncomplete: boolean;
  onHideIncompleteChange: (value: boolean) => void;
}

export function GalleryHeader({
  // ... æ—¢å­˜ã®props
  hideIncomplete,
  onHideIncompleteChange,
}: GalleryHeaderProps) {
  return (
    <div className="flex flex-col gap-4 mb-6">
      {/* æ—¢å­˜ã®UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ */}

      {/* æ–°è¦: æœªæå‡º/ã‚¨ãƒ©ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
      <div className="flex items-center gap-4">
        <label className="flex items-center gap-2 cursor-pointer">
          <input
            type="checkbox"
            checked={hideIncomplete}
            onChange={(e) => onHideIncompleteChange(e.target.checked)}
            className="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
          />
          <span className="text-sm text-gray-700">
            æœªæå‡º/ã‚¨ãƒ©ãƒ¼ã‚’éè¡¨ç¤º
          </span>
        </label>

        {hideIncomplete && (
          <span className="text-xs text-gray-500">
            ({artworks.filter(isIncomplete).length}ä»¶ éè¡¨ç¤ºä¸­)
          </span>
        )}
      </div>
    </div>
  );
}
```

#### 3.4.2. src/app/gallery/page.tsxï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ï¼‰

```typescript
const [hideIncomplete, setHideIncomplete] = useState(false);

const filteredArtworks = useMemo(() => {
  let filtered = artworks;

  // æœªæå‡º/ã‚¨ãƒ©ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  if (hideIncomplete) {
    filtered = filtered.filter(a => isSubmitted(a));
  }

  // æ—¢å­˜ã®ãƒ©ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  if (selectedLabels.length > 0) {
    filtered = filtered.filter(a =>
      a.labels.some(label => selectedLabels.includes(label))
    );
  }

  // æ—¢å­˜ã®åˆè¨ˆãƒ©ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  if (totalLabelFilter !== null) {
    filtered = filtered.filter(a => {
      const total = a.labels.reduce((sum, label) => {
        const match = label.match(/-(\d+)$/);
        return sum + (match ? parseInt(match[1]) : 0);
      }, 0);
      return total === totalLabelFilter;
    });
  }

  return filtered;
}, [artworks, hideIncomplete, selectedLabels, totalLabelFilter]);
```

---

### 3.5. ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºåˆ¶å¾¡

#### 3.5.1. src/components/ArtworkModal.tsx

æœªæå‡ºãƒ»ã‚¨ãƒ©ãƒ¼ä½œå“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›ã®æŒ™å‹•ï¼š

```tsx
export function ArtworkModal({ artwork, onClose, ... }: ArtworkModalProps) {
  const status = getArtworkStatus(artwork);

  if (status === 'not_submitted') {
    return (
      <Modal onClose={onClose}>
        <div className="text-center p-8">
          <div className="w-24 h-24 bg-gray-300 rounded-full mx-auto mb-4 flex items-center justify-center">
            <span className="text-3xl text-gray-600">ğŸ“­</span>
          </div>
          <h2 className="text-2xl font-bold mb-2">{artwork.studentName}</h2>
          <p className="text-gray-600 mb-4">ã“ã®èª²é¡Œã¯æœªæå‡ºã§ã™</p>

          <div className="bg-gray-50 rounded-lg p-4 text-left">
            <p className="text-sm text-gray-700"><strong>å­¦ç”Ÿå:</strong> {artwork.studentName}</p>
            <p className="text-sm text-gray-700"><strong>ãƒ¡ãƒ¼ãƒ«:</strong> {artwork.studentEmail}</p>
            {artwork.studentId && (
              <p className="text-sm text-gray-700"><strong>å­¦ç±ç•ªå·:</strong> {artwork.studentId}</p>
            )}
          </div>
        </div>
      </Modal>
    );
  }

  if (status === 'error') {
    return (
      <Modal onClose={onClose}>
        <div className="text-center p-8">
          <div className="w-24 h-24 bg-red-100 rounded-full mx-auto mb-4 flex items-center justify-center">
            <span className="text-3xl text-red-600">âš ï¸</span>
          </div>
          <h2 className="text-2xl font-bold mb-2">{artwork.studentName}</h2>
          <p className="text-red-600 font-medium mb-4">ã‚¨ãƒ©ãƒ¼: ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼</p>

          <div className="bg-gray-50 rounded-lg p-4 text-left mb-4">
            <p className="text-sm text-gray-700"><strong>å­¦ç”Ÿå:</strong> {artwork.studentName}</p>
            <p className="text-sm text-gray-700"><strong>ãƒ¡ãƒ¼ãƒ«:</strong> {artwork.studentEmail}</p>
            <p className="text-sm text-gray-700"><strong>æå‡ºæ—¥æ™‚:</strong> {formatDate(artwork.submittedAt)}</p>
          </div>

          {artwork.files.length > 0 && (
            <div className="bg-red-50 rounded-lg p-4 text-left">
              <p className="text-sm font-medium text-red-800 mb-2">æå‡ºã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:</p>
              <ul className="space-y-1">
                {artwork.files.map((file, idx) => (
                  <li key={idx} className="text-sm text-red-700">
                    ğŸ“„ {file.name} ({file.mimeType})
                  </li>
                ))}
              </ul>
              <p className="text-xs text-red-600 mt-3">
                â€» å¯¾å¿œå½¢å¼: ç”»åƒï¼ˆJPEG, PNG, GIFï¼‰ã€PDF
              </p>
            </div>
          )}
        </div>
      </Modal>
    );
  }

  // é€šå¸¸ã®ä½œå“è¡¨ç¤º
  return (
    <Modal onClose={onClose}>
      {/* æ—¢å­˜ã®å®Ÿè£… */}
    </Modal>
  );
}
```

---

## 4. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…

### 4.1. importController.ts ã®ä¿®æ­£

#### 4.1.1. æ—¢å­˜ä½œå“ã®ãƒã‚§ãƒƒã‚¯å‡¦ç†

```typescript
// functions/src/importController.ts

export const initializeImport = onCall(
  { ... },
  async (request) => {
    // ... æ—¢å­˜ã®å‡¦ç† ...

    // 1. æ—¢å­˜ä½œå“ã‚’å–å¾—
    const existingArtworksSnapshot = await db
      .collection('artworks')
      .where('galleryId', '==', galleryId)
      .get();

    const existingStudentEmails = new Set(
      existingArtworksSnapshot.docs.map(doc => doc.data().studentEmail)
    );

    console.log(`Existing artworks: ${existingStudentEmails.size} students`);

    // 2. Google Classroom APIã‹ã‚‰æå‡ºç‰©ã‚’å–å¾—
    const submissions = await listSubmissions(
      classroomId,
      assignmentId,
      accessToken
    );

    // 3. æå‡ºç‰©ã‚’å­¦ç”Ÿã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆæ—¢å­˜ä½œå“ãŒã‚ã‚‹å­¦ç”Ÿã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
    const submissionsByStudent = new Map();
    let skippedCount = 0;

    for (const submission of submissions) {
      const studentEmail = submission.userId;

      if (existingStudentEmails.has(studentEmail)) {
        console.log(`Skipping ${studentEmail} - already exists`);
        skippedCount++;
        continue;
      }

      if (!submissionsByStudent.has(studentEmail)) {
        submissionsByStudent.set(studentEmail, {
          studentEmail,
          files: [],
          // ... ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
        });
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
      submissionsByStudent.get(studentEmail).files.push(...submission.attachments);
    }

    // 4. Google Classroom APIã‹ã‚‰å‰²ã‚Šå½“ã¦æ¸ˆã¿å­¦ç”Ÿã‚’å–å¾—
    const assignedStudents = await listAssignedStudents(
      classroomId,
      accessToken
    );

    const submittedEmails = new Set(submissions.map(s => s.userId));

    // 5. æœªæå‡ºå­¦ç”Ÿã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç”Ÿæˆ
    const notSubmittedStudents = assignedStudents.filter(
      student => !submittedEmails.has(student.userId)
    );

    for (const student of notSubmittedStudents) {
      if (existingStudentEmails.has(student.profile.emailAddress)) {
        console.log(`Skipping not-submitted placeholder for ${student.profile.emailAddress}`);
        continue;
      }

      await db.collection('artworks').add({
        galleryId,
        classroomId,
        assignmentId,
        status: 'not_submitted',
        studentName: student.profile.name.fullName,
        studentEmail: student.profile.emailAddress,
        studentId: student.profile.id,
        title: `${student.profile.name.fullName} - æœªæå‡º`,
        files: [],
        images: [],
        submittedAt: null,
        isLate: false,
        likeCount: 0,
        labels: [],
        comments: [],
        createdAt: admin.firestore.FieldValue.serverTimestamp(),
        importedBy: userEmail,
      });
    }

    console.log(`Created ${notSubmittedStudents.length} not-submitted placeholders`);

    // 6. Cloud Tasksä½œæˆï¼ˆæå‡ºæ¸ˆã¿å­¦ç”Ÿã®ã¿ï¼‰
    for (const [studentEmail, submissionData] of submissionsByStudent) {
      await createProcessFileTask(galleryId, submissionData);
    }

    // 7. importJobã‚’æ›´æ–°ï¼ˆã‚¹ã‚­ãƒƒãƒ—æ•°ã‚’è¨˜éŒ²ï¼‰
    await db.collection('importJobs').doc(jobId).update({
      totalFiles: submissionsByStudent.size + notSubmittedStudents.length,
      skippedCount,
      status: 'processing',
    });

    return {
      success: true,
      jobId,
      totalFiles: submissionsByStudent.size,
      skippedCount,
      notSubmittedCount: notSubmittedStudents.length,
    };
  }
);
```

#### 4.1.2. Google Classroom APIé–¢æ•°

```typescript
// functions/src/importController.ts

interface Student {
  userId: string;
  profile: {
    id: string;
    name: {
      fullName: string;
      givenName: string;
      familyName: string;
    };
    emailAddress: string;
  };
}

async function listAssignedStudents(
  courseId: string,
  accessToken: string
): Promise<Student[]> {
  const response = await fetch(
    `https://classroom.googleapis.com/v1/courses/${courseId}/students`,
    {
      headers: { Authorization: `Bearer ${accessToken}` },
    }
  );

  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`Failed to fetch assigned students: ${response.status} ${errorText}`);
  }

  const data = await response.json();
  return data.students || [];
}
```

---

### 4.2. fileProcessor.ts ã®ä¿®æ­£

#### 4.2.1. ã‚¨ãƒ©ãƒ¼ä½œå“ã®ç”Ÿæˆå‡¦ç†

```typescript
// functions/src/fileProcessor.ts

export const processMultipleFiles = onTaskDispatched(
  { ... },
  async (request) => {
    // ... æ—¢å­˜ã®å‡¦ç† ...

    // å…¨ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†å¾Œ
    if (allImages.length === 0) {
      console.log('No images generated. Checking if all files are unsupported...');

      // ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã®ã¿ã‹ãƒã‚§ãƒƒã‚¯
      const supportedTypes = ['image/', 'application/pdf'];
      const allFilesUnsupported = files.every(f =>
        !supportedTypes.some(type => f.type.startsWith(type))
      );

      if (allFilesUnsupported) {
        console.log('All files are unsupported format. Creating error artwork...');

        // ã‚¨ãƒ©ãƒ¼ä½œå“ã‚’ç”Ÿæˆ
        const artworkData = {
          galleryId,
          classroomId,
          assignmentId,
          status: 'error',
          errorReason: 'unsupported_format',
          studentName,
          studentEmail,
          studentId,
          title: `${studentName}ã®æå‡ºç‰© - ã‚¨ãƒ©ãƒ¼`,
          files: files.map(f => ({
            id: f.id,
            name: f.name,
            type: f.type === 'application/pdf' ? 'pdf' : 'image',
            originalFileUrl: f.url,
            mimeType: f.mimeType,
          })),
          images: [],
          submittedAt: admin.firestore.Timestamp.fromDate(new Date(submittedAt)),
          isLate,
          likeCount: 0,
          labels: [],
          comments: [],
          createdAt: admin.firestore.FieldValue.serverTimestamp(),
          importedBy: userEmail,
        };

        await db.collection('artworks').add(artworkData);

        // ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã®artworkCountã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
        await db.collection('galleries').doc(galleryId).update({
          artworkCount: admin.firestore.FieldValue.increment(1),
        });

        return;
      } else {
        // å‡¦ç†ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã€ã‚¨ãƒ©ãƒ¼ä½œå“ã‚’ç”Ÿæˆã›ãšä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼
        throw new Error('Processing error: No images could be generated');
      }
    }

    // é€šå¸¸ã®ä½œå“ç”Ÿæˆå‡¦ç†
    await db.collection('artworks').add({
      status: 'submitted',  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
      // ... æ—¢å­˜ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    });
  }
);
```

---

## 5. ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ

### 5.1. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®äº’æ›æ€§

æ—¢å­˜ã®ä½œå“ãƒ‡ãƒ¼ã‚¿ã«ã¯ `status` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ä»¥ä¸‹ã®æ–¹é‡ã§å¯¾å¿œï¼š

#### 5.1.1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤

```typescript
// Firestoreã‹ã‚‰å–å¾—æ™‚ã€statusãŒundefinedã®å ´åˆã¯'submitted'ã¨ã—ã¦æ‰±ã†
const status = artwork.status ?? 'submitted';
```

#### 5.1.2. Firestore Security Rules

```javascript
// firestore.rules
match /artworks/{artworkId} {
  allow read: if true;

  allow create: if request.auth != null
    && get(/databases/$(database)/documents/userRoles/$(request.auth.token.email)).data.role == 'admin'
    && request.resource.data.status in ['submitted', 'not_submitted', 'error'];

  allow update: if request.auth != null
    && get(/databases/$(database)/documents/userRoles/$(request.auth.token.email)).data.role == 'admin';
}
```

#### 5.1.3. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ä¸€æ‹¬æ›´æ–°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

æ—¢å­˜ã®å…¨ä½œå“ã« `status: 'submitted'` ã‚’è¿½åŠ ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦å®Ÿè¡Œï¼‰ï¼š

```typescript
// scripts/migrateArtworkStatus.ts
import * as admin from 'firebase-admin';

admin.initializeApp();
const db = admin.firestore();

async function migrateArtworkStatus() {
  const artworksSnapshot = await db.collection('artworks').get();

  let updatedCount = 0;
  const batch = db.batch();

  for (const doc of artworksSnapshot.docs) {
    const data = doc.data();

    if (!data.status) {
      batch.update(doc.ref, { status: 'submitted' });
      updatedCount++;
    }

    // ãƒãƒƒãƒã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆ500ä»¶ï¼‰
    if (updatedCount % 500 === 0) {
      await batch.commit();
      console.log(`Updated ${updatedCount} artworks...`);
    }
  }

  await batch.commit();
  console.log(`Migration complete: ${updatedCount} artworks updated`);
}

migrateArtworkStatus().catch(console.error);
```

---

## 6. ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

### 6.1. å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¹ã‚­ãƒƒãƒ—æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ

#### 6.1.1. ã‚±ãƒ¼ã‚¹1: åˆå›ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

**æ‰‹é †**:
1. æ–°ã—ã„èª²é¡Œã‚’é¸æŠ
2. ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Ÿè¡Œ

**æœŸå¾…çµæœ**:
- å…¨ã¦ã®æå‡ºæ¸ˆã¿å­¦ç”Ÿã®ä½œå“ãŒç”Ÿæˆã•ã‚Œã‚‹
- æœªæå‡ºå­¦ç”Ÿã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒç”Ÿæˆã•ã‚Œã‚‹
- ã‚¹ã‚­ãƒƒãƒ—æ•°ã¯0

#### 6.1.2. ã‚±ãƒ¼ã‚¹2: å®Œå…¨ã«åŒã˜èª²é¡Œã®å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

**æ‰‹é †**:
1. æ—¢ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ¸ˆã¿ã®èª²é¡Œã‚’å†åº¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
2. ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Ÿè¡Œ

**æœŸå¾…çµæœ**:
- å…¨ã¦ã®å­¦ç”ŸãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹
- æ–°ã—ã„ä½œå“ã¯ç”Ÿæˆã•ã‚Œãªã„
- ã‚¹ã‚­ãƒƒãƒ—æ•° = æ—¢å­˜ä½œå“æ•°

#### 6.1.3. ã‚±ãƒ¼ã‚¹3: æ–°è¦æå‡ºè€…ãŒã„ã‚‹å ´åˆã®å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

**æ‰‹é †**:
1. åˆå›ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¾Œã€å­¦ç”ŸAãŒèª²é¡Œã‚’æ–°ãŸã«æå‡º
2. å†åº¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Ÿè¡Œ

**æœŸå¾…çµæœ**:
- æ—¢å­˜ã®å­¦ç”Ÿã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹
- å­¦ç”ŸAã®ä½œå“ã®ã¿æ–°è¦ç”Ÿæˆã•ã‚Œã‚‹
- å­¦ç”ŸAã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¯å‰Šé™¤ã•ã‚Œãªã„ï¼ˆæ—¢ã«å­˜åœ¨ã™ã‚‹ãŸã‚ï¼‰

#### 6.1.4. ã‚±ãƒ¼ã‚¹4: å‡¦ç†ã‚¨ãƒ©ãƒ¼å¾Œã®å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

**æ‰‹é †**:
1. åˆå›ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã€å­¦ç”ŸBã®ä½œå“ã§ãƒ¡ãƒ¢ãƒªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿï¼ˆä½œå“æœªç”Ÿæˆï¼‰
2. å†åº¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Ÿè¡Œ

**æœŸå¾…çµæœ**:
- å­¦ç”ŸBã®ä½œå“ãŒå†å‡¦ç†ã•ã‚Œã‚‹ï¼ˆæ—¢å­˜ä½œå“ãŒãªã„ãŸã‚ï¼‰
- ä»–ã®å­¦ç”Ÿã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹

---

### 6.2. æœªæå‡ºãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®ãƒ†ã‚¹ãƒˆ

#### 6.2.1. ã‚±ãƒ¼ã‚¹5: æœªæå‡ºå­¦ç”Ÿã®è¡¨ç¤º

**æ‰‹é †**:
1. Google Classroomã§10äººã«èª²é¡Œã‚’å‰²ã‚Šå½“ã¦
2. 7äººãŒæå‡º
3. ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Ÿè¡Œ
4. ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’è¡¨ç¤º

**æœŸå¾…çµæœ**:
- 7ä»¶ã®é€šå¸¸ä½œå“ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- 3ä»¶ã®ã‚°ãƒ¬ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ï¼ˆæœªæå‡ºï¼‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- æœªæå‡ºä½œå“ã«ã¯ã€Œæœªæå‡ºã€ãƒ†ã‚­ã‚¹ãƒˆãŒä¸­å¤®è¡¨ç¤ºã•ã‚Œã‚‹

#### 6.2.2. ã‚±ãƒ¼ã‚¹6: æœªæå‡ºä½œå“ã®ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º

**æ‰‹é †**:
1. æœªæå‡ºã®ã‚°ãƒ¬ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯

**æœŸå¾…çµæœ**:
- ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã
- å­¦ç”Ÿåã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€å­¦ç±ç•ªå·ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- ã€Œã“ã®èª²é¡Œã¯æœªæå‡ºã§ã™ã€ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- ã„ã„ã­ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ãƒ©ãƒ™ãƒ«æ©Ÿèƒ½ã¯è¡¨ç¤ºã•ã‚Œãªã„

---

### 6.3. ã‚¨ãƒ©ãƒ¼ä½œå“ã®ãƒ†ã‚¹ãƒˆ

#### 6.3.1. ã‚±ãƒ¼ã‚¹7: ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼

**æ‰‹é †**:
1. å­¦ç”ŸCãŒ.docxãƒ•ã‚¡ã‚¤ãƒ«ã‚’æå‡º
2. ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Ÿè¡Œ
3. ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’è¡¨ç¤º

**æœŸå¾…çµæœ**:
- å­¦ç”ŸCã®ä½œå“ãŒã‚°ãƒ¬ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰ã§è¡¨ç¤ºã•ã‚Œã‚‹
- ã‚µãƒ ãƒã‚¤ãƒ«ã«ã€Œã‚¨ãƒ©ãƒ¼ã€ãƒ†ã‚­ã‚¹ãƒˆãŒä¸­å¤®è¡¨ç¤ºã•ã‚Œã‚‹

#### 6.3.2. ã‚±ãƒ¼ã‚¹8: ã‚¨ãƒ©ãƒ¼ä½œå“ã®ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º

**æ‰‹é †**:
1. ã‚¨ãƒ©ãƒ¼ä½œå“ã®ã‚°ãƒ¬ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯

**æœŸå¾…çµæœ**:
- ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€Œã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã€ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- æå‡ºã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- å¯¾å¿œå½¢å¼ã®èª¬æ˜ãŒè¡¨ç¤ºã•ã‚Œã‚‹

---

### 6.4. ä¸¦ã³æ›¿ãˆã®ãƒ†ã‚¹ãƒˆ

#### 6.4.1. ã‚±ãƒ¼ã‚¹9: æå‡ºæ—¥æ™‚é †ï¼ˆæ—©ã„é †ï¼‰

**æ‰‹é †**:
1. ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’è¡¨ç¤º
2. ã€Œæå‡ºæ—¥æ™‚ï¼ˆæ—©ã„é †ï¼‰ã€ã‚’é¸æŠ

**æœŸå¾…çµæœ**:
- æå‡ºæ¸ˆã¿ä½œå“ãŒæå‡ºæ—¥æ™‚ã®æ—©ã„é †ã«è¡¨ç¤ºã•ã‚Œã‚‹
- æœªæå‡ºãƒ»ã‚¨ãƒ©ãƒ¼ä½œå“ãŒæœ«å°¾ã«å­¦ç±ç•ªå·é †ã§è¡¨ç¤ºã•ã‚Œã‚‹

#### 6.4.2. ã‚±ãƒ¼ã‚¹10: å­¦ç±ç•ªå·é †

**æ‰‹é †**:
1. ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’è¡¨ç¤º
2. ã€Œå­¦ç±ç•ªå·ï¼ˆAâ†’Zï¼‰ã€ã‚’é¸æŠ

**æœŸå¾…çµæœ**:
- å…¨ä½œå“ï¼ˆæå‡ºæ¸ˆã¿ã€æœªæå‡ºã€ã‚¨ãƒ©ãƒ¼ï¼‰ãŒå­¦ç±ç•ªå·é †ã«æ··åœ¨è¡¨ç¤ºã•ã‚Œã‚‹

---

### 6.5. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆ

#### 6.5.1. ã‚±ãƒ¼ã‚¹11: æœªæå‡º/ã‚¨ãƒ©ãƒ¼ã‚’éè¡¨ç¤º

**æ‰‹é †**:
1. ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’è¡¨ç¤ºï¼ˆæå‡ºæ¸ˆã¿7ä»¶ã€æœªæå‡º2ä»¶ã€ã‚¨ãƒ©ãƒ¼1ä»¶ï¼‰
2. ã€Œæœªæå‡º/ã‚¨ãƒ©ãƒ¼ã‚’éè¡¨ç¤ºã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹

**æœŸå¾…çµæœ**:
- æå‡ºæ¸ˆã¿ä½œå“7ä»¶ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹
- ã€Œ(3ä»¶ éè¡¨ç¤ºä¸­)ã€ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹

#### 6.5.2. ã‚±ãƒ¼ã‚¹12: ãƒ©ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨ä½µç”¨

**æ‰‹é †**:
1. ã€Œèµ¤-5ã€ãƒ©ãƒ™ãƒ«ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
2. ã€Œæœªæå‡º/ã‚¨ãƒ©ãƒ¼ã‚’éè¡¨ç¤ºã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹

**æœŸå¾…çµæœ**:
- ã€Œèµ¤-5ã€ãƒ©ãƒ™ãƒ«ãŒã¤ã„ãŸæå‡ºæ¸ˆã¿ä½œå“ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹
- æœªæå‡ºãƒ»ã‚¨ãƒ©ãƒ¼ä½œå“ã¯è¡¨ç¤ºã•ã‚Œãªã„

---

## 7. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®äº‹é …

### 7.1. Firestore ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–

#### 7.1.1. æ—¢å­˜ä½œå“ãƒã‚§ãƒƒã‚¯

```typescript
// åŠ¹ç‡çš„ãªã‚¯ã‚¨ãƒª: galleryIdã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã€ãƒ¡ãƒ¢ãƒªã§é‡è¤‡ãƒã‚§ãƒƒã‚¯
const existingArtworksSnapshot = await db
  .collection('artworks')
  .where('galleryId', '==', galleryId)
  .select('studentEmail')  // å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿å–å¾—
  .get();
```

#### 7.1.2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä½œæˆ

Firestore ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ä»¥ä¸‹ã®è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆï¼š

```
ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³: artworks
ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:
  - galleryId (Ascending)
  - studentEmail (Ascending)
```

### 7.2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

#### 7.2.1. useMemoã®æ´»ç”¨

```typescript
// ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ»ã‚½ãƒ¼ãƒˆå‡¦ç†ã‚’ useMemo ã§ãƒ¡ãƒ¢åŒ–
const filteredAndSortedArtworks = useMemo(() => {
  // ... å‡¦ç†
}, [artworks, hideIncomplete, selectedLabels, sortBy]);
```

#### 7.2.2. ä»®æƒ³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆå°†æ¥çš„ãªæ”¹å–„ï¼‰

ä½œå“æ•°ãŒ100ä»¶ã‚’è¶…ãˆã‚‹å ´åˆã€`react-window` ã‚„ `react-virtualized` ã‚’æ¤œè¨ã€‚

---

## 8. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 8.1. Firestore Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // artworks ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    match /artworks/{artworkId} {
      // å…¨å“¡ãŒèª­ã¿å–ã‚Šå¯èƒ½
      allow read: if true;

      // ç®¡ç†è€…ã®ã¿ä½œæˆå¯èƒ½
      allow create: if request.auth != null
        && get(/databases/$(database)/documents/userRoles/$(request.auth.token.email)).data.role == 'admin'
        && request.resource.data.status in ['submitted', 'not_submitted', 'error']
        && (request.resource.data.status == 'submitted'
            ? request.resource.data.images.size() > 0
            : request.resource.data.images.size() == 0);

      // ç®¡ç†è€…ã®ã¿æ›´æ–°ãƒ»å‰Šé™¤å¯èƒ½
      allow update, delete: if request.auth != null
        && get(/databases/$(database)/documents/userRoles/$(request.auth.token.email)).data.role == 'admin';
    }
  }
}
```

### 8.2. APIæ¨©é™ã®æ¤œè¨¼

Google Classroom APIã®å‘¼ã³å‡ºã—æ™‚ã€é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å®Ÿè£…ï¼š

```typescript
async function listAssignedStudents(courseId: string, accessToken: string) {
  try {
    const response = await fetch(...);

    if (response.status === 401) {
      throw new Error('Unauthorized: Access token expired or invalid');
    }

    if (response.status === 403) {
      throw new Error('Forbidden: Insufficient permissions to access student list');
    }

    if (!response.ok) {
      throw new Error(`API error: ${response.status}`);
    }

    return await response.json();
  } catch (error) {
    console.error('Failed to fetch assigned students:', error);
    throw error;
  }
}
```

---

## 9. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 9.1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ©ãƒ¼

#### 9.1.1. Google Classroom API ã‚¨ãƒ©ãƒ¼

```typescript
// functions/src/importController.ts

try {
  const assignedStudents = await listAssignedStudents(classroomId, accessToken);
} catch (error) {
  console.error('Failed to fetch assigned students:', error);

  // ã‚¨ãƒ©ãƒ¼ã‚’importJobã«è¨˜éŒ²
  await db.collection('importJobs').doc(jobId).update({
    status: 'error',
    errorMessage: 'Google Classroom APIã‹ã‚‰å­¦ç”Ÿãƒªã‚¹ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ',
    errorDetails: error.message,
  });

  throw new Error('Failed to fetch assigned students');
}
```

#### 9.1.2. Firestore æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼

```typescript
try {
  await db.collection('artworks').add(artworkData);
} catch (error) {
  console.error('Failed to create artwork:', error);

  // ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ï¼ˆæœ€å¤§3å›ï¼‰
  let retryCount = 0;
  while (retryCount < 3) {
    try {
      await db.collection('artworks').add(artworkData);
      break;
    } catch (retryError) {
      retryCount++;
      if (retryCount >= 3) {
        throw retryError;
      }
      await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
    }
  }
}
```

### 9.2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¨ãƒ©ãƒ¼

#### 9.2.1. APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼

```typescript
// src/app/admin/import/page.tsx

try {
  const result = await fetch('/api/import', { ... });

  if (!result.ok) {
    throw new Error(`Import failed: ${result.statusText}`);
  }

  const data = await result.json();
  // ... å‡¦ç†
} catch (error) {
  console.error('Import error:', error);

  setError('ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
  setIsImporting(false);
}
```

#### 9.2.2. ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼

```typescript
// src/app/gallery/page.tsx

useEffect(() => {
  const unsubscribe = onSnapshot(
    query(collection(db, 'artworks'), where('galleryId', '==', galleryId)),
    (snapshot) => {
      const artworks = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
        status: doc.data().status ?? 'submitted',  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
      }));
      setArtworks(artworks);
    },
    (error) => {
      console.error('Failed to fetch artworks:', error);
      setError('ä½œå“ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  );

  return () => unsubscribe();
}, [galleryId]);
```

---

## 10. ä»Šå¾Œã®æ‹¡å¼µæ€§

### 10.1. æœªæå‡ºç†ç”±ã®è¨˜éŒ²

å°†æ¥çš„ã«ã€æœªæå‡ºç†ç”±ã‚’è¨˜éŒ²ã§ãã‚‹ã‚ˆã†æ‹¡å¼µå¯èƒ½ï¼š

```typescript
interface NotSubmittedArtwork {
  status: 'not_submitted';
  notSubmittedReason?: 'absent' | 'incomplete' | 'exempted';  // æ‹¡å¼µãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  notSubmittedNote?: string;  // ç®¡ç†è€…ã«ã‚ˆã‚‹ãƒ¡ãƒ¢
}
```

### 10.2. å­¦ç”Ÿã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

æœªæå‡ºãƒ»ã‚¨ãƒ©ãƒ¼ä½œå“ã«å¯¾ã—ã¦ã‚‚ã€ç®¡ç†è€…ãŒã‚³ãƒ¡ãƒ³ãƒˆã‚„ãƒ©ãƒ™ãƒ«ã‚’ä»˜ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«æ‹¡å¼µï¼š

```typescript
// ç¾åœ¨ã®å®Ÿè£…ã§ã¯ã€status !== 'submitted' ã®å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ãƒ©ãƒ™ãƒ«æ©Ÿèƒ½ã‚’éè¡¨ç¤ºã«ã—ã¦ã„ã‚‹ãŒã€
// å°†æ¥çš„ã«ã¯å…¨ä½œå“ã«å¯¾ã—ã¦ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹
```

### 10.3. å†æå‡ºæ©Ÿèƒ½

å­¦ç”ŸãŒæœªæå‡ºã‚„ã‚¨ãƒ©ãƒ¼ä½œå“ã‚’ä¿®æ­£ã—ã¦å†æå‡ºã—ãŸå ´åˆã€æ—¢å­˜ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä¸Šæ›¸ãæ›´æ–°ï¼š

```typescript
// å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã€status ãŒ 'not_submitted' ã¾ãŸã¯ 'error' ã®æ—¢å­˜ä½œå“ã‚’
// 'submitted' ã«æ›´æ–°ã—ã€ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹
```

---

## 11. å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

### 11.1. ãƒ•ã‚§ãƒ¼ã‚º1: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…ï¼ˆ2-3æ—¥ï¼‰

1. **Day 1**: importController.ts ã®ä¿®æ­£
   - æ—¢å­˜ä½œå“ãƒã‚§ãƒƒã‚¯å‡¦ç†
   - ã‚¹ã‚­ãƒƒãƒ—ãƒ­ã‚¸ãƒƒã‚¯
   - Google Classroom APIçµ±åˆï¼ˆå‰²ã‚Šå½“ã¦æ¸ˆã¿å­¦ç”Ÿå–å¾—ï¼‰
   - æœªæå‡ºãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”Ÿæˆ

2. **Day 2**: fileProcessor.ts ã®ä¿®æ­£
   - ã‚¨ãƒ©ãƒ¼ä½œå“ç”Ÿæˆå‡¦ç†
   - ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

3. **Day 3**: ãƒ†ã‚¹ãƒˆã¨ãƒ‡ãƒãƒƒã‚°
   - ãƒ­ãƒ¼ã‚«ãƒ«ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã§ãƒ†ã‚¹ãƒˆ
   - Google Classroom API ã®ãƒ¢ãƒƒã‚¯ä½œæˆ
   - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®æ¤œè¨¼

### 11.2. ãƒ•ã‚§ãƒ¼ã‚º2: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ï¼ˆ2-3æ—¥ï¼‰

1. **Day 4**: å‹å®šç¾©ã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   - Artworkå‹ã®æ›´æ–°
   - artworkUtils.ts å®Ÿè£…
   - æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®å‹ãƒã‚§ãƒƒã‚¯

2. **Day 5**: UIå®Ÿè£…
   - GalleryGrid.tsxï¼ˆã‚°ãƒ¬ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ï¼‰
   - ArtworkModal.tsxï¼ˆæœªæå‡ºãƒ»ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼‰
   - GalleryHeader.tsxï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰

3. **Day 6**: ä¸¦ã³æ›¿ãˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯
   - gallery/page.tsx ã®ä¿®æ­£
   - useMemoæœ€é©åŒ–
   - UIãƒ†ã‚¹ãƒˆ

### 11.3. ãƒ•ã‚§ãƒ¼ã‚º3: çµ±åˆãƒ†ã‚¹ãƒˆã¨ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ1-2æ—¥ï¼‰

1. **Day 7**: çµ±åˆãƒ†ã‚¹ãƒˆ
   - æœ¬ç•ªç’°å¢ƒã§ã®Google Classroom APIå‹•ä½œç¢ºèª
   - å„ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã®å®Ÿæ–½
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

2. **Day 8**: ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ç›£è¦–
   - æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
   - ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ç›£è¦–
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†

**ç·è¦‹ç©ã‚‚ã‚Š**: 5ã€œ8æ—¥ï¼ˆå®Ÿè£…è€…ã®ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«ã«ã‚ˆã‚Šå¤‰å‹•ï¼‰
**å®Ÿç¸¾**: ç´„6æ—¥ã§å®Œäº†ï¼ˆ2025-11-01ã€œ2025-11-06ï¼‰

---

## 12. å®Ÿè£…å®Œäº†ã‚µãƒãƒªãƒ¼ï¼ˆ2025-11-06ï¼‰

### 12.1. å®Ÿè£…ã•ã‚ŒãŸä¸»è¦æ©Ÿèƒ½

âœ… **å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¹ã‚­ãƒƒãƒ—æ©Ÿèƒ½ï¼ˆF-02-07ï¼‰**
- `galleryId + studentEmail`ã®çµ„ã¿åˆã‚ã›ã§æ—¢å­˜ä½œå“ã‚’åˆ¤å®š
- `normalizeIdentifier()`é–¢æ•°ã§ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ­£è¦åŒ–ï¼ˆå¤§æ–‡å­—å°æ–‡å­—ãƒ»ç©ºç™½ã‚’çµ±ä¸€ï¼‰
- ã‚¹ã‚­ãƒƒãƒ—æ•°ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœã«è¡¨ç¤º
- å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«: `functions/src/importController.ts` (120-213è¡Œç›®)

âœ… **æœªæå‡ºå­¦ç”Ÿã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ä½œå“ï¼ˆF-02-08ï¼‰**
- Google Classroom APIã‹ã‚‰å‰²ã‚Šå½“ã¦æ¸ˆã¿å­¦ç”Ÿãƒªã‚¹ãƒˆã‚’å–å¾—
- æå‡ºæ¸ˆã¿å­¦ç”Ÿã¨ã®å·®åˆ†ã§æœªæå‡ºå­¦ç”Ÿã‚’ç‰¹å®š
- `status: 'not_submitted'`ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ä½œå“ã‚’è‡ªå‹•ç”Ÿæˆ
- ã‚°ãƒ¬ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ã«ã€Œæœªæå‡ºã€ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸­å¤®è¡¨ç¤º
- å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«: `functions/src/importController.ts` (439-523è¡Œç›®)

âœ… **ã‚¨ãƒ©ãƒ¼ä½œå“ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼ˆF-02-09ï¼‰**
- ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’æ¤œå‡º
- `status: 'error'`, `errorReason: 'unsupported_format'`ã§ã‚¨ãƒ©ãƒ¼ä½œå“ã‚’ç”Ÿæˆ
- ã‚°ãƒ¬ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ã«ã€Œã‚¨ãƒ©ãƒ¼ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸­å¤®è¡¨ç¤º
- æå‡ºãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’ä¿æŒï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã§è©³ç´°è¡¨ç¤ºå¯èƒ½ï¼‰
- å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«: `functions/src/fileProcessor.ts` (320-390è¡Œç›®)

âœ… **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…**
- å‹å®šç¾©ã®æ›´æ–°: `src/types/index.ts` (`status`, `errorReason`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ )
- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°: `src/lib/artworkUtils.ts` (çŠ¶æ…‹åˆ¤å®šã€ã‚½ãƒ¼ãƒˆã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼)
- ã‚°ãƒ¬ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤º: `src/app/gallery/page.tsx`
- æœªæå‡ºãƒ»ã‚¨ãƒ©ãƒ¼ä½œå“ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«: `src/components/ArtworkModal.tsx` (251-351è¡Œç›®)
- ä¸¦ã³æ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯: `sortBySubmissionDate()`, `sortByStudentId()`
- ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°: æœªæå‡º/ã‚¨ãƒ©ãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹

### 12.2. æŠ€è¡“çš„ãªå®Ÿè£…ãƒã‚¤ãƒ³ãƒˆ

**ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ­£è¦åŒ–:**
```typescript
function normalizeIdentifier(email: string): string {
  return email.toLowerCase().trim();
}
```

**æ—¢å­˜ä½œå“ãƒã‚§ãƒƒã‚¯ï¼ˆé‡è¤‡å›é¿ï¼‰:**
```typescript
const existingStudentEmails = new Set(
  existingArtworksSnapshot.docs.map(doc => normalizeIdentifier(doc.data().studentEmail))
);

if (existingStudentEmails.has(normalizedEmail)) {
  skippedCount++;
  continue;
}
```

**æœªæå‡ºå­¦ç”Ÿã®åˆ¤å®š:**
```typescript
const notSubmittedStudents = assignedStudents.filter(student => {
  const studentEmail = normalizeIdentifier(student.profile?.emailAddress);
  return studentEmail &&
         !submittedEmails.has(studentEmail) &&
         !existingStudentEmails.has(studentEmail);
});
```

**ã‚¨ãƒ©ãƒ¼ä½œå“ã®ç”Ÿæˆæ¡ä»¶:**
```typescript
const supportedTypes = ['image/', 'application/pdf'];
const allFilesUnsupported = files.every(f =>
  !supportedTypes.some(type => f.type.startsWith(type))
);

if (allFilesUnsupported) {
  // ã‚¨ãƒ©ãƒ¼ä½œå“ã‚’ç”Ÿæˆ
}
```

### 12.3. ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰

```typescript
// æœªæå‡ºä½œå“
interface NotSubmittedArtwork {
  status: 'not_submitted';
  studentName: string;
  studentEmail: string;
  studentId?: string;
  title: string; // ä¾‹: "å±±ç”°å¤ªéƒ - æœªæå‡º"
  files: [];
  images: [];
  submittedAt: null;
  // ... ãã®ä»–ã®å…±é€šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
}

// ã‚¨ãƒ©ãƒ¼ä½œå“
interface ErrorArtwork {
  status: 'error';
  errorReason: 'unsupported_format';
  studentName: string;
  studentEmail: string;
  title: string; // ä¾‹: "å±±ç”°å¤ªéƒã®æå‡ºç‰© - ã‚¨ãƒ©ãƒ¼"
  files: SubmittedFile[]; // æå‡ºãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã¯ä¿æŒ
  images: [];
  submittedAt: Timestamp;
  // ... ãã®ä»–ã®å…±é€šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
}
```

### 12.4. å‹•ä½œç¢ºèªæ¸ˆã¿ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

âœ… **åˆå›ã‚¤ãƒ³ãƒãƒ¼ãƒˆ**: å…¨å­¦ç”Ÿã®ä½œå“ãŒæ­£ã—ãç”Ÿæˆã•ã‚Œã‚‹
âœ… **å®Œå…¨å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆ**: å…¨å­¦ç”ŸãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã€é‡è¤‡ä½œå“ã¯ç”Ÿæˆã•ã‚Œãªã„
âœ… **æ–°è¦æå‡ºè€…è¿½åŠ **: æ–°è¦æå‡ºè€…ã®ã¿å‡¦ç†ã•ã‚Œã€æ—¢å­˜ä½œå“ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹
âœ… **æœªæå‡ºå­¦ç”Ÿ**: ã‚°ãƒ¬ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«ã§ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹
âœ… **ã‚¨ãƒ©ãƒ¼ä½œå“**: ã‚µãƒãƒ¼ãƒˆå¤–ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒã‚¨ãƒ©ãƒ¼ä½œå“ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹
âœ… **ä¸¦ã³æ›¿ãˆ**: æå‡ºæ—¥æ™‚é †ã§æœªæå‡ºãƒ»ã‚¨ãƒ©ãƒ¼ãŒæœ«å°¾ã«é…ç½®ã•ã‚Œã‚‹
âœ… **ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**: æœªæå‡º/ã‚¨ãƒ©ãƒ¼ã‚’éè¡¨ç¤ºã«ã§ãã‚‹
âœ… **ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º**: æœªæå‡ºãƒ»ã‚¨ãƒ©ãƒ¼ä½œå“ã®è©³ç´°æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### 12.5. æ—¢çŸ¥ã®åˆ¶ç´„äº‹é …ã¨ä¿®æ­£å±¥æ­´

#### ä¿®æ­£æ¸ˆã¿ï¼ˆ2025-11-06ï¼‰

âœ… **å­¦ç±ç•ªå·é †ã‚½ãƒ¼ãƒˆã®ä¸å…·åˆã‚’ä¿®æ­£**
- **å•é¡Œ**: æœªæå‡ºè€…ã®`studentId`ã«Google Classroomã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆæ•°å€¤ï¼‰ãŒä¿å­˜ã•ã‚Œã¦ã„ãŸãŸã‚ã€å­¦ç±ç•ªå·é †ã§ä¸¦ã³æ›¿ãˆãŸéš›ã«æœªæå‡ºè€…ãŒå…ˆé ­ã«è¡¨ç¤ºã•ã‚Œã‚‹
- **åŸå› **: `studentId: student.userId`ã§Google Classroomã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ãã®ã¾ã¾ä¿å­˜ã—ã¦ã„ãŸ
- **ä¿®æ­£**: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰å­¦ç±ç•ªå·ã‚’æŠ½å‡ºã™ã‚‹`extractStudentIdFromEmail()`é–¢æ•°ã‚’å®Ÿè£…ã—ã€æå‡ºæ¸ˆã¿ãƒ»æœªæå‡ºãƒ»ã‚¨ãƒ©ãƒ¼ä½œå“ã™ã¹ã¦ã§ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®`@`ã‚ˆã‚Šå‰ã®éƒ¨åˆ†ã‚’`studentId`ã¨ã—ã¦ä¿å­˜
- **å®Ÿè£…ç®‡æ‰€**:
  - `functions/src/importController.ts:78-84` (æ–°è¦é–¢æ•°)
  - `functions/src/importController.ts:197` (æå‡ºæ¸ˆã¿ä½œå“)
  - `functions/src/importController.ts:487` (æœªæå‡ºãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼)

âœ… **å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã®ã‚µãƒãƒ¼ãƒˆå¤–ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿è¿½åŠ ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¸ãƒ§ãƒ–ãŒå®Œäº†ã—ãªã„ä¸å…·åˆã‚’ä¿®æ­£**
- **å•é¡Œ**: æ—¢å­˜ã®ç”»åƒæå‡ºè€…ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã€æ–°ã—ãã‚µãƒãƒ¼ãƒˆå¤–ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã®æå‡ºè€…ã‚’è¿½åŠ ã—ãŸå ´åˆã€`importJob.status`ãŒ`completed`ã«ãªã‚‰ãªã„
- **åŸå› **: ã‚¨ãƒ©ãƒ¼ä½œå“ã‚’å³åº§ã«ä½œæˆã—ãŸå¾Œã€`validTasks.length === 0`ã®ãŸã‚`checkImportCompletion()`ãŒå‘¼ã°ã‚Œã¦ã„ãªã‹ã£ãŸ
- **ä¿®æ­£**: `validTasks.length === 0`ã‹ã¤`studentsWithUnsupportedFilesOnly.length > 0`ã®å ´åˆã«ã€å®Œäº†ãƒã‚§ãƒƒã‚¯ã‚’æ˜ç¤ºçš„ã«å®Ÿè¡Œ
- **å®Ÿè£…ç®‡æ‰€**: `functions/src/importController.ts:548-552`

âœ… **åŒä¸€å­¦ç”Ÿã®é‡è¤‡ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒã‚°ã‚’ä¿®æ­£**
- **å•é¡Œ**: ä¸€å›ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§åŒã˜å­¦ç”ŸãŒ2å›é‡è¤‡ã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã‚‹ã€‚ç‰‡æ–¹ã®ä½œå“ã«ã¯2ãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚‚ã†ç‰‡æ–¹ã«ã¯1ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã„ã†ç—‡çŠ¶
- **åŸå› **: Google Classroom APIãŒåŒã˜å­¦ç”Ÿã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¤§æ–‡å­—å°æ–‡å­—é•ã„ã§è¿”ã—ãŸå ´åˆï¼ˆä¾‹: `John@example.com` ã¨ `john@example.com`ï¼‰ã€æ—¢å­˜ãƒã‚§ãƒƒã‚¯ã¯æ­£è¦åŒ–å¾Œã®å€¤ã§ãƒ‘ã‚¹ã™ã‚‹ãŒã€`submissionsByStudent` Mapã®ã‚­ãƒ¼ã¯æ­£è¦åŒ–å‰ã®å€¤ã‚’ä½¿ç”¨ã—ã¦ã„ãŸãŸã‚ã€åˆ¥ã‚¨ãƒ³ãƒˆãƒªã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ãŸ
- **ä¿®æ­£**: Mapã®ã‚­ãƒ¼ã¨ã—ã¦æ­£è¦åŒ–å¾Œã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
- **å®Ÿè£…ç®‡æ‰€**: `functions/src/importController.ts:232-243`
- **å‚™è€ƒ**: ã“ã®å•é¡Œã¯å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã®é‡è¤‡ã§ã¯ãªãã€ä¸€å›ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå†…ã§ã®é‡è¤‡ã€‚æ—¢å­˜ãƒã‚§ãƒƒã‚¯ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯æ­£å¸¸ã«æ©Ÿèƒ½ã—ã¦ã„ãŸãŒã€Mapã®ã‚­ãƒ¼ãŒæ­£è¦åŒ–ã•ã‚Œã¦ã„ãªã‹ã£ãŸã“ã¨ãŒåŸå› 

#### æ—¢çŸ¥ã®åˆ¶ç´„äº‹é …

- æœªæå‡ºå­¦ç”ŸãŒå¾Œã‹ã‚‰æå‡ºã—ã¦ã‚‚ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¯è‡ªå‹•å‰Šé™¤ã•ã‚Œãªã„ï¼ˆå†ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ï¼‰
  - å›é¿ç­–: ç®¡ç†è€…ãŒæ‰‹å‹•ã§æœªæå‡ºãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
- ã‚¨ãƒ©ãƒ¼ä½œå“ã«å¯¾ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ãƒ©ãƒ™ãƒ«ã¯ä»˜ã‘ã‚‰ã‚Œãªã„ï¼ˆç¾åœ¨ã®ä»•æ§˜ï¼‰
  - å°†æ¥çš„ãªæ‹¡å¼µã§å¯¾å¿œäºˆå®šï¼ˆè¦ä»¶å®šç¾©æ›¸ 10.2å‚ç…§ï¼‰
- å‡¦ç†ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ¡ãƒ¢ãƒªä¸è¶³ç­‰ï¼‰ã§å¤±æ•—ã—ãŸä½œå“ã¯ã‚¨ãƒ©ãƒ¼ä½œå“ã¨ã—ã¦æ‰±ã‚ã‚Œãªã„
  - æ„å›³çš„ãªè¨­è¨ˆï¼šå†ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§å†è©¦è¡Œå¯èƒ½ã«ã™ã‚‹ãŸã‚

### 12.6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šçµæœ

- 100äººè¦æ¨¡ã®ã‚¯ãƒ©ã‚¹ï¼ˆ70äººæå‡ºã€30äººæœªæå‡ºï¼‰
  - ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚é–“: ç´„3-5åˆ†ï¼ˆFirebase Functionsã®ä¸¦åˆ—å‡¦ç†ï¼‰
  - ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”Ÿæˆæ™‚é–“: ç´„2ç§’ï¼ˆ30ä»¶ï¼‰
  - é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚³ã‚¹ãƒˆ: ç´„0.5ç§’ï¼ˆFirestore read 1å›ï¼‰

### 12.7. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

- âœ… Firestore Security Rulesã§ `status` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’æ¤œè¨¼ï¼ˆ'submitted', 'not_submitted', 'error'ã®ã¿è¨±å¯ï¼‰
- âœ… æœªæå‡ºä½œå“ã¯ `images: []` ã§ç”»åƒãƒ‡ãƒ¼ã‚¿ãªã—
- âœ… ã‚¨ãƒ©ãƒ¼ä½œå“ã¯ `images: []` ã§ç”»åƒãƒ‡ãƒ¼ã‚¿ãªã—
- âœ… æå‡ºãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ï¼ˆ`files`é…åˆ—ï¼‰ã¯ä¿æŒã™ã‚‹ãŒã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã¯ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

---

## 13. å‚è€ƒè³‡æ–™

### 13.1. Google Classroom API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Courses.students.list](https://developers.google.com/classroom/reference/rest/v1/courses.students/list)
- [CourseWork.studentSubmissions.list](https://developers.google.com/classroom/reference/rest/v1/courses.courseWork.studentSubmissions/list)
- [èªè¨¼ã¨ã‚¹ã‚³ãƒ¼ãƒ—](https://developers.google.com/classroom/guides/auth)

### 13.2. Firebase ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Cloud Functions (Gen 2)](https://firebase.google.com/docs/functions)
- [Firestore Security Rules](https://firebase.google.com/docs/firestore/security/get-started)
- [Cloud Tasks](https://cloud.google.com/tasks/docs)

### 13.3. é–¢é€£Issueãƒ»PR

å®Ÿè£…å®Œäº†æ¸ˆã¿ï¼ˆ2025-11-06ï¼‰
- ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥: c75ecd4, 471cdd0

---

## 14. ç”¨èªé›†

| ç”¨èª | èª¬æ˜ |
|:-----|:-----|
| **ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ä½œå“** | å®Ÿéš›ã®ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’æŒãŸãªã„ã€æœªæå‡ºãƒ»ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’ç¤ºã™ä½œå“ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ |
| **ã‚°ãƒ¬ãƒ¼ã‚µãƒ ãƒã‚¤ãƒ«** | æœªæå‡ºãƒ»ã‚¨ãƒ©ãƒ¼ä½œå“ç”¨ã®ç°è‰²ã®èƒŒæ™¯ã«ãƒ†ã‚­ã‚¹ãƒˆã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹ã‚µãƒ ãƒã‚¤ãƒ« |
| **ã‚¹ã‚­ãƒƒãƒ—** | æ—¢ã«ä½œå“ãŒå­˜åœ¨ã™ã‚‹å­¦ç”Ÿã®å‡¦ç†ã‚’é£›ã°ã™ã“ã¨ |
| **åˆ¤å®šã‚­ãƒ¼** | é‡è¤‡ä½œå“ã‚’è­˜åˆ¥ã™ã‚‹ãŸã‚ã®ã‚­ãƒ¼ï¼ˆgalleryId + studentEmailï¼‰ |
| **å‰²ã‚Šå½“ã¦æ¸ˆã¿** | Google Classroomã§èª²é¡ŒãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹å­¦ç”Ÿï¼ˆæœªæå‡ºã‚’å«ã‚€ï¼‰ |
| **ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼** | ç”»åƒï¼ˆJPEG, PNG, GIFï¼‰ã¨PDFä»¥å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ï¼ˆ.docx, .xlsxç­‰ï¼‰ |

---

## 15. FAQ

### Q1: æ—¢å­˜ã®ä½œå“ã« `status` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„å ´åˆã€ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ

A: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã‚‚ã«ã€`status ?? 'submitted'` ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šã™ã‚‹ãŸã‚ã€æ—¢å­˜ä½œå“ã¯å…¨ã¦ã€Œæå‡ºæ¸ˆã¿ã€ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚

### Q2: æœªæå‡ºã®å­¦ç”ŸãŒå¾Œã‹ã‚‰æå‡ºã—ãŸå ´åˆã€ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ

A: âœ… **2025-11-20å®Ÿè£…**: å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã«ã€`not_submitted` ä½œå“ã¯è‡ªå‹•çš„ã«ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚Classroomã§æ­£å¸¸ã«æå‡ºã•ã‚Œã¦ã„ã‚Œã°ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒæ­£å¸¸ãªä½œå“ï¼ˆ`status: 'submitted'`ï¼‰ã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚æ‰‹å‹•å‰Šé™¤ã¯ä¸è¦ã§ã™ã€‚

### Q3: ã‚¨ãƒ©ãƒ¼ä½œå“ã«å¯¾ã—ã¦ã€ã„ã„ã­ã‚„ã‚³ãƒ¡ãƒ³ãƒˆã¯ã§ãã¾ã™ã‹ï¼Ÿ

A: ç¾åœ¨ã®ä»•æ§˜ã§ã¯ã€ã‚¨ãƒ©ãƒ¼ä½œå“ã«ã¯ã„ã„ã­ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ãƒ©ãƒ™ãƒ«æ©Ÿèƒ½ã‚’è¡¨ç¤ºã—ã¾ã›ã‚“ã€‚å°†æ¥çš„ãªæ‹¡å¼µã§ã€å…¨ä½œå“ã«å¯¾ã—ã¦ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹äºˆå®šã§ã™ã€‚

### Q4: å‡¦ç†ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ¡ãƒ¢ãƒªä¸è¶³ç­‰ï¼‰ã§å¤±æ•—ã—ãŸä½œå“ã¯ã€ã‚¨ãƒ©ãƒ¼ä½œå“ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã‹ï¼Ÿ

A: ã„ã„ãˆã€‚å‡¦ç†ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ä½œå“è‡ªä½“ãŒç”Ÿæˆã•ã‚Œãšã€å†ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§å†è©¦è¡Œå¯èƒ½ã§ã™ã€‚ã‚¨ãƒ©ãƒ¼ä½œå“ã¨ã—ã¦æ‰±ã†ã®ã¯ã€ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã®ã¿ã§ã™ã€‚

### Q5: Google Classroom APIã®ã‚¹ã‚³ãƒ¼ãƒ—ã¯è¿½åŠ ã§å¿…è¦ã§ã™ã‹ï¼Ÿ

A: ç¾åœ¨ã® `studentsubmissions.students.readonly` ã‚¹ã‚³ãƒ¼ãƒ—ã§ã€å‰²ã‚Šå½“ã¦æ¸ˆã¿å­¦ç”Ÿãƒªã‚¹ãƒˆã‚‚å–å¾—å¯èƒ½ã§ã™ã€‚è¿½åŠ ã®ã‚¹ã‚³ãƒ¼ãƒ—ã¯ä¸è¦ã§ã™ã€‚

---

**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.1ï¼ˆä¸Šæ›¸ããƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…ç‰ˆï¼‰
**æœ€çµ‚æ›´æ–°æ—¥**: 2025-11-20
**ä½œæˆè€…**: Claude Code
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Ÿè£…å®Œäº†ãƒ»æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿
