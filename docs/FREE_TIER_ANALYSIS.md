# Cloud Functions無料枠の詳細分析

## Cloud Functions（第2世代）の無料枠

Google Cloud Functionsには以下の無料枠があります：

| 項目 | 無料枠 |
|------|--------|
| **呼び出し回数** | 200万回/月 |
| **コンピューティング時間** | 40万 GB秒/月 + 20万 GHz秒/月 |
| **ネットワーク（下り）** | 5GB/月 |

---

## 70人 × 週1回講評会での消費量

### 1. 呼び出し回数

#### 1回のインポート（70人分）
```
importClassroomSubmissions: 1回
processFileTask: 70回
getImportStatus: 約20回（3秒ごとにポーリング × 8分）
---
合計: 91回/週
```

#### 月間（4週）
```
91回/週 × 4週 = 364回/月
```

#### 年間（40週 = 10ヶ月）
```
91回/週 × 40週 = 3,640回/年
```

**結果: 364回/月 << 200万回/月 ✅ 余裕で無料枠内**

---

### 2. コンピューティング時間（GB秒）

#### importClassroomSubmissions（1回のインポート）
```
メモリ: 1GB
実行時間: 280秒（4分40秒）
GB秒: 1GB × 280秒 = 280 GB秒
```

#### processFileTask（70回実行）

**新設定での処理時間再計算:**

##### 画像処理時間の変化
```
旧設定（1920px、150 DPI）: 15秒/ファイル
新設定（2400px、200 DPI）: 約25秒/ファイル

理由:
- 画像サイズ増加: 1920px → 2400px (+56%面積)
- PDF DPI増加: 150 → 200 (+33%)
- Sharp処理時間: +40%
```

##### 新設定でのGB秒計算
```
1ファイル: 2GB × 25秒 = 50 GB秒
70ファイル: 50 × 70 = 3,500 GB秒
```

#### 1回のインポート合計
```
importClassroomSubmissions: 280 GB秒
processFileTask: 3,500 GB秒
---
合計: 3,780 GB秒/週
```

#### 月間（4週）
```
3,780 GB秒/週 × 4週 = 15,120 GB秒/月
```

**結果: 15,120 GB秒/月 << 40万 GB秒/月 ✅ 余裕で無料枠内（3.8%使用）**

---

### 3. ネットワーク（下り）

#### Storage → Functionsへの転送（無料）
```
一時ファイルのダウンロード: Google内部転送 = 無料
```

#### Functions → Storageへの転送（無料）
```
最適化画像のアップロード: Google内部転送 = 無料
```

#### Storage → ユーザーへの転送（課金対象）

**1ファイルあたりのサイズ（新設定）:**
```
2400px、JPEG 85%品質、2.5ページ平均

1ページあたり:
- 2400×2400 JPEG 85%: 約1.2MB
- サムネイル 400×400: 50KB

1ファイル合計:
- 画像: 2.5ページ × 1.2MB = 3MB
- サムネイル: 50KB
- 小計: 約3.05MB
```

**1回の講評会でのダウンロード:**
```
学生70人が自分の作品を閲覧: 70 × 3.05MB = 213.5MB
教員が全作品閲覧: 70 × 3.05MB = 213.5MB
複数回リロード（平均3回）: 213.5MB × 3 = 640.5MB

合計: 約850MB/週
```

**月間（4週）:**
```
850MB × 4週 = 3.4GB/月
```

**結果: 3.4GB/月 < 5GB/月 ✅ 無料枠内（68%使用）**

---

## 無料枠まとめ

| 項目 | 使用量/月 | 無料枠/月 | 使用率 | 状態 |
|------|----------|----------|--------|------|
| 呼び出し回数 | 364回 | 200万回 | 0.02% | ✅ 余裕 |
| GB秒 | 15,120 | 40万 | 3.8% | ✅ 余裕 |
| ネットワーク | 3.4GB | 5GB | 68% | ⚠️ 注意 |

---

## 無料枠を超える可能性のあるシナリオ

### ⚠️ ネットワーク転送が超過する場合

#### シナリオ1: 複数クラス（3クラス）
```
3.4GB × 3クラス = 10.2GB/月
→ 5GBの無料枠超過
超過分: 5.2GB × $0.12 = $0.62/月
```

#### シナリオ2: 学生が何度もアクセス
```
平均10回リロード: 3.4GB × (10÷3) = 11.3GB/月
→ 5GBの無料枠超過
超過分: 6.3GB × $0.12 = $0.76/月
```

### 💡 対策: Cloud CDN（オプション）

**Cloud CDNを有効化すると:**
- キャッシュヒット時はネットワーク転送にカウントされない
- 2回目以降のアクセスは無料
- 月額$0.08程度のキャッシュ料金のみ

**推奨: 無料枠超過が心配な場合はCDNを検討**

---

## 新設定（2400px、20MB）でのコスト再計算

### 1回のインポートコスト

#### Cloud Functions料金
```
importClassroomSubmissions: 280 GB秒 × $0.0000025 = $0.0007
processFileTask: 3,500 GB秒 × $0.0000025 = $0.00875

合計: $0.00945/週（約¥1.4/週）
```

**無料枠適用後: $0（無料枠内）**

#### Cloud Storage料金

**一時ファイル（削除済みのため実質0）:**
```
処理完了後に即座に削除されるため、課金なし
```

**変換後画像:**
```
1ファイル: 3.05MB
70ファイル/週: 213.5MB/週
年間40週: 8.54GB/年

料金: 8.54GB × $0.023 = $0.196/年
```

#### ネットワーク転送料金
```
3.4GB/月（無料枠5GB以内）: $0
超過時のみ: 超過分 × $0.12
```

#### Firestore料金
```
書き込み: 143回/週（無料枠20,000回/日以内）: $0
読み取り: 720回/週（無料枠50,000回/日以内）: $0
ストレージ: 14MB/年（無料枠1GB以内）: $0
```

---

## 総コスト（新設定）

### 無料枠内で運用可能な場合

| 項目 | 料金 |
|------|------|
| Cloud Functions | $0（無料枠内） |
| Cloud Storage | $0.196/年 |
| ネットワーク | $0（無料枠内） |
| Firestore | $0（無料枠内） |
| **年間合計** | **$0.196（約¥30/年）** |

### ネットワーク転送が無料枠超過する場合（例: 10GB/月使用）

| 項目 | 料金 |
|------|------|
| Cloud Functions | $0（無料枠内） |
| Cloud Storage | $0.196/年 |
| ネットワーク超過分 | (10-5)GB × $0.12 × 10ヶ月 = $6/年 |
| Firestore | $0（無料枠内） |
| **年間合計** | **$6.196（約¥930/年）** |

---

## 結論

### ✅ **ほぼ完全に無料枠内で運用可能！**

**70人 × 週1回の場合:**
- Cloud Functions: 完全無料（使用率3.8%）
- Firestore: 完全無料（使用率1%未満）
- Storage: 年¥30程度
- ネットワーク: 無料枠内（使用率68%）

**合計: 年間¥30～¥50程度**

### ⚠️ 注意すべきポイント

1. **ネットワーク転送が最も無料枠に近い**
   - 複数クラスや頻繁なアクセスで超過の可能性
   - 超過時は1GBあたり¥18程度

2. **新設定（2400px）の影響**
   - ファイルサイズ: 2MB → 3MB (+50%)
   - 処理時間: 15秒 → 25秒 (+67%)
   - ネットワーク転送: 2.3GB → 3.4GB (+48%)
   - **それでも無料枠内で収まる**

3. **一時データは完璧に削除される**
   - 処理成功時: 即座に削除
   - 処理失敗時: エラーハンドラーで削除
   - 24時間経過後: クリーンアップFunctionで削除

---

## 推奨設定

### 現在の設定で十分

```typescript
MAX_FILE_SIZE = 20MB        // ✅ 適切
OPTIMIZED_IMAGE_SIZE = 2400px // ✅ A3全画面対応
IMAGE_QUALITY = 85          // ✅ 高品質
PDF DPI = 200               // ✅ A3に最適
```

### 無料枠を最大限活用するコツ

1. **講評会後、不要になったギャラリーは削除**
   - 学期末に一括削除
   - Storageコスト削減

2. **プログレッシブJPEGを活用（既に実装済み）**
   - 初回表示が速い
   - ネットワーク体感速度向上

3. **サムネイルを積極活用（既に実装済み）**
   - ギャラリー一覧では小さい画像を表示
   - ネットワーク転送量削減

4. **Cloud CDNは様子見**
   - 無料枠超過が頻発する場合のみ検討
   - 通常は不要
