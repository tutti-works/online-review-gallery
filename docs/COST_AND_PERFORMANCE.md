# コストとパフォーマンス分析

**最終更新**: 2025-11-20
**対象構成**: 2400px画像、200 DPI PDF、20MB上限

---

## 📋 概要

このドキュメントは、Online Review Galleryアプリケーションの以下を統合的に分析します：
- Firebase/GCPサービスの利用料金
- 無料枠の活用状況
- 処理時間とパフォーマンス
- 設定変更の影響

**標準ユースケース**:
- 学生数: 70人/週
- ファイル: PDF 5MB/人、平均2.5ページ
- 頻度: 週1回 × 40週/年（学期制）

---

## 💰 コスト分析（2025-11-20現在）

### 年間コスト概算

| 項目 | 年間使用量 | 無料枠 | 料金 |
|------|-----------|--------|------|
| **Cloud Functions呼び出し** | 3,640回 | 200万回/月 | $0（無料） |
| **Cloud Functions処理時間** | 15,120 GB秒/月 | 40万 GB秒/月 | $0（無料） |
| **Cloud Storage保存** | 8.54GB | - | $0.196/年 |
| **ネットワーク転送** | 3.4GB/月 | 5GB/月 | $0（無料） |
| **Firestore** | 少量 | 十分 | $0（無料） |
| **Google APIs** | 8,520リクエスト/年 | Workspace無料 | $0（無料） |
| **合計** | - | - | **$0.20/年（約¥30/年）** |

### 結論

✅ **ほぼ完全に無料枠内で運用可能**

---

## 🔍 詳細分析

### 1. Cloud Functions（第2世代）

#### 無料枠
| 項目 | 無料枠/月 |
|------|----------|
| 呼び出し回数 | 200万回 |
| GB秒 | 40万 |
| GHz秒 | 20万 |
| ネットワーク（下り） | 5GB |

#### 使用量（70人 × 週1回 = 月4回）

**1回のインポート（70人分）:**
```
importClassroomSubmissions: 1回
processFileTask: 70回
getImportStatus: 約20回（ポーリング）
---
合計: 91回/週 = 364回/月
```

**処理時間（GB秒）:**
```
importClassroomSubmissions:
  メモリ: 1GB × 280秒 = 280 GB秒

processFileTask（70回）:
  メモリ: 2GB × 25秒/ファイル = 50 GB秒/ファイル
  合計: 50 × 70 = 3,500 GB秒

週次合計: 3,780 GB秒
月次合計: 15,120 GB秒（無料枠の3.8%）
```

**使用率:**
| 項目 | 使用量/月 | 使用率 |
|------|----------|--------|
| 呼び出し回数 | 364回 | **0.02%** ✅ |
| GB秒 | 15,120 | **3.8%** ✅ |

---

### 2. Cloud Storage

#### ストレージ料金

**一時ファイル（unprocessed/）:**
```
処理完了後に即座に削除 → 実質$0
削除メカニズム:
  1. 成功時: 処理完了直後に削除
  2. エラー時: エラーハンドラーで削除
  3. 定期: 24時間経過後クリーンアップ
```

**変換後画像（galleries/）:**
```
1ファイル（2.5ページ平均）:
  - 画像: 2.5ページ × 1.2MB = 3MB
  - サムネイル: 50KB
  - 小計: 3.05MB

70ファイル/週: 213.5MB
年間40週: 8.54GB

料金: 8.54GB × $0.023 = $0.196/年（約¥30/年）
```

#### ネットワーク転送料金

**課金される転送（Storage → ユーザー）:**
```
1回の講評会:
  - 学生70人が自作品閲覧: 70 × 3MB = 210MB
  - 教員が全作品閲覧: 70 × 3MB = 210MB
  - 複数回リロード（平均3回）: 640MB

  週次合計: 約850MB
  月次合計: 3.4GB（無料枠5GBの68%）
```

**課金されない転送（Google内部）:**
```
✅ Google Drive → Cloud Functions: 無料
✅ Cloud Functions → Cloud Storage: 無料
✅ Cloud Storage → Cloud Functions: 無料
```

**使用率:**
```
3.4GB/月 < 5GB/月 ✅ 無料枠内（68%使用）
```

**⚠️ 注意**: ネットワーク転送が最も無料枠に近い項目

---

### 3. Firestore

#### 使用量（1回のインポート）

**書き込み:**
```
artworks: 70ドキュメント
importJobs: 1 + 70回更新
galleries: 1 + 1回更新
---
合計: 143回/週 = 5,720回/年

無料枠: 20,000回/日 ✅ 余裕
```

**読み取り（最適化後）:**
```
ギャラリー表示: 70作品
進捗確認: 20回
再読み込み: 10回程度（最適化により削減）
---
合計: 約100回/週 = 4,000回/年

無料枠: 50,000回/日 ✅ 余裕
```

**ストレージ:**
```
1作品: 5KB
年間2,800作品: 14MB

無料枠: 1GB ✅ 余裕
```

**2025-11-06最適化の効果:**
- React Hooks依存配列の修正により、読み取り回数を85-90%削減
- 修正前: 8,000回/日 → 修正後: 800-1,200回/日
- 詳細: [changelog.md](changelog.md#2025-11-06-更新4-firestore読み取り回数の最適化)

---

### 4. Google APIs

**Classroom API（週1回インポート）:**
```
courses.list: 1回
courseWork.list: 1回
studentSubmissions.list: 1回
userProfiles.get: 70回
---
年間: 2,920リクエスト
```

**Drive API（週1回インポート）:**
```
files.get（メタデータ）: 70回
files.get（ダウンロード）: 70回
---
年間: 5,600リクエスト
```

**料金**: $0（Google Workspace for Education無料枠内）

---

## ⏱️ 処理時間分析

### 現在の設定（2025-11-20）

```typescript
MAX_FILE_SIZE = 20MB
OPTIMIZED_IMAGE_SIZE = 2400px  // A3全画面対応
IMAGE_QUALITY = 85             // 高品質
PDF_DPI = 200                  // 鮮明
```

### 1ファイルあたりの処理時間

```
フェーズ1: Google Drive → 一時Storage
  - Drive APIダウンロード: 3秒
  - Storage保存: 1秒
  小計: 4秒

フェーズ2: PDF → 画像変換（Cloud Tasks並列）
  - Storageダウンロード: 1秒
  - PDF変換（2.5ページ × 200 DPI）: 15秒
  - Sharp最適化: 2秒
  - サムネイル生成: 1秒
  - Storageアップロード: 2秒
  - 一時ファイル削除: 0.5秒
  小計: 21.5秒

合計: 約25秒/ファイル
```

### 70人分のインポート時間

```
シナリオA: 同時実行10並列（現実的）
  importClassroomSubmissions: 4分40秒
  processFileTask（10並列）: 7バッチ × 25秒 = 2分55秒
  ---
  合計: 約8分

シナリオB: 同時実行5並列（安全マージン）
  importClassroomSubmissions: 4分40秒
  processFileTask（5並列）: 14バッチ × 25秒 = 5分50秒
  ---
  合計: 約10分
```

**推定**: 8～10分で完了 ✅ 許容範囲

---

## 📊 設定変更の影響

### 旧設定 vs 新設定

| 項目 | 旧設定 | 新設定 | 変化率 |
|------|--------|--------|--------|
| 画像サイズ | 1920px | 2400px | +25%面積 |
| PDF DPI | 150 | 200 | +33% |
| 画像品質 | 85% | 85% | 変更なし |
| **ファイルサイズ** | 2MB/ファイル | 3MB/ファイル | **+50%** |
| **処理時間** | 15秒/ファイル | 25秒/ファイル | **+67%** |
| **年間Storage** | 5.74GB | 8.54GB | **+49%** |
| **ネットワーク** | 2.3GB/月 | 3.4GB/月 | **+48%** |

### 評価

**メリット**:
- ✅ A3プロジェクター全画面表示で鮮明
- ✅ 4Kディスプレイでも高画質
- ✅ 200 DPIで細かい文字も読みやすい

**デメリット**:
- ⚠️ 処理時間: 6分 → 8-10分（+67%）
- ⚠️ ネットワーク使用率: 46% → 68%（+22pt）

**結論**: 画質向上のメリットが処理時間増加を上回る ✅

---

## ⚠️ 無料枠超過の可能性

### シナリオ1: 複数クラス運用（3クラス）

```
ネットワーク転送: 3.4GB × 3 = 10.2GB/月
超過分: (10.2 - 5)GB × $0.12 = $0.62/月
年間: $7.44（約¥1,116/年）
```

### シナリオ2: 学生の頻繁なアクセス（平均10回/週）

```
ネットワーク転送: 3.4GB × (10÷3) = 11.3GB/月
超過分: (11.3 - 5)GB × $0.12 = $0.76/月
年間: $9.12（約¥1,368/年）
```

### 対策: Cloud CDN（オプション）

**メリット**:
- キャッシュヒット時はネットワーク転送にカウントされない
- 2回目以降のアクセスは無料
- 表示速度も向上

**コスト**:
- キャッシュ料金: 約$0.08/月
- ネットワーク超過を防げる場合は総コスト削減

**推奨**: 無料枠超過が頻発する場合のみ検討

---

## 💡 コスト最適化オプション

### オプション1: 画質調整（コスト重視）

```typescript
OPTIMIZED_IMAGE_SIZE = 1920px  // -30%ファイルサイズ
IMAGE_QUALITY = 75             // -20%ファイルサイズ
PDF_DPI = 150                  // -33%処理時間
```

**効果**:
- 年間Storage: $0.196 → $0.07（-64%）
- ネットワーク: 3.4GB → 1.5GB/月（-56%）
- 年間コスト: $0.20 → $0.07（約¥10/年）

**トレードオフ**: A3全画面表示時の画質低下

---

### オプション2: 古いデータ削除（推奨）

```
学期末（16週後）に古いギャラリーを削除
Storage使用量: 8.54GB → 4.27GB（-50%）
年間Storage料金: $0.196 → $0.098（-50%）
```

**効果**: コスト削減 + データ整理

---

### オプション3: DPI調整

```typescript
PDF_DPI = 150  // 200 → 150に変更
```

**効果**:
- 処理時間: 25秒 → 18秒（-28%）
- Functions料金: わずかに削減（無料枠内のため影響小）

**トレードオフ**: PDF内の細かい文字の鮮明度低下

---

## 🎯 推奨構成

### 現在の設定を維持（品質重視）

```typescript
MAX_FILE_SIZE = 20MB
OPTIMIZED_IMAGE_SIZE = 2400px
IMAGE_QUALITY = 85
PDF_DPI = 200
```

**理由**:
- ✅ 年間¥30で十分安い
- ✅ A3プロジェクター全画面表示で鮮明
- ✅ 処理時間8-10分は許容範囲
- ✅ ネットワーク使用率68%でまだ余裕

**推奨追加施策**:
1. 学期末に古いギャラリーを削除
2. 無料枠超過が頻発する場合はCloud CDN検討

---

## 📈 スケーラビリティ分析

### 複数クラス運用時のコスト

| クラス数 | 学生数 | 年間コスト | 備考 |
|---------|--------|-----------|------|
| 1クラス | 70人 | ¥30 | 無料枠内 |
| 2クラス | 140人 | ¥60 | 無料枠内 |
| 3クラス | 210人 | ¥90 + ネットワーク超過 | ネットワーク¥1,100/年 |
| 5クラス | 350人 | ¥150 + ネットワーク超過 | ネットワーク¥3,500/年 |

**結論**: 2クラスまでは完全無料、3クラス以上でネットワーク超過の可能性

---

## 📝 まとめ

### 70人 × 週1回講評会の場合

| 項目 | 値 |
|------|-----|
| **年間コスト** | ¥30/年 |
| **インポート時間** | 8～10分 |
| **必要プラン** | Blaze Plan（従量課金） |
| **無料枠使用率** | Cloud Functions: 3.8%<br>ネットワーク: 68%<br>Firestore: <1% |
| **画質** | A3全画面対応、4K対応 |
| **教員の作業時間** | 2分（授業・課題選択のみ） |

### ✅ 評価

**コストパフォーマンス**: 優秀
**実用性**: 十分
**スケーラビリティ**: 2クラスまで無料、それ以上も低コスト
**画質**: プロジェクター全画面表示でも鮮明

---

## 🔗 関連ドキュメント

- [変更履歴](changelog.md) - Firestore最適化の詳細
- [背景インポート機能](BACKGROUND_IMPORT.md) - 処理フローの詳細
- [PDF処理ガイド](PDF_PROCESSING_GUIDE.md) - PDF変換の技術詳細
- [要件定義](requirements.md) - システム要件

---

**ドキュメントバージョン**: 1.0
**統合元**:
- FREE_TIER_ANALYSIS.md
- COST_ESTIMATION.md
- SETTINGS_SUMMARY.md
