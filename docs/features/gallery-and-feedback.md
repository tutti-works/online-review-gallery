# ギャラリー表示・評価・フィードバック機能仕様書

📄 **機能ID**: F-03, F-04, F-05
📝 **ステータス**: 本番環境稼働中
✅ **実装完了日**: 2025-10-20（初版）、2025-11-06（プレースホルダー対応）

---

## 1. 概要

本ドキュメントは、ギャラリーの表示機能、評価・フィードバック機能、データ管理機能の仕様をまとめています。

### 1.1. 対象機能

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| F-03 | ギャラリー表示機能 | Masonryレイアウト、モーダル表示、ズーム、ソート、フィルター |
| F-04 | 評価・フィードバック機能 | いいね、コメント、ラベル、作品削除 |
| F-05 | データ管理機能 | 全データリセット、ギャラリー別削除、作品数同期 |

---

## 2. ギャラリー表示機能 (F-03)

### 2.1. Masonryレイアウト表示 (F-03-01)

**概要**: 異なるサイズ・アスペクト比の作品を美しく配置するレイアウト

**仕様**:
- 複数ページある作品（元がPDF）の場合は、1ページ目の画像がサムネイルとして表示される
- サムネイルには以下の情報を表示:
  - 学生名
  - いいね数
  - コメント数
  - ページ数
  - ラベル
  - 遅刻フラグ

**実装**: グリッド形式での自動配置

---

### 2.2. 作品の拡大・複数ページ表示 (F-03-02)

**概要**: サムネイルクリックで全画面モーダル表示

**仕様**:
- ギャラリー上のサムネイルをクリックすると、作品を全画面モーダルウィンドウで拡大表示
- 作品が複数ページで構成される場合（元がPDF）、モーダル内で「次へ」「前へ」といったナビゲーションを提供し、全ページを閲覧可能
- ページサムネイルを下部に表示し、クリックで該当ページにジャンプ
- モーダルのヘッダーに現在表示中のファイル名を表示し、ページ切り替え時に自動で更新

---

### 2.3. モーダル内作品間ナビゲーション (F-03-02a) ✅ 実装済み

**概要**: モーダルを開いたまま作品間を移動

**仕様**:
- 「前の作品」「次の作品」ボタンで別の作品に移動
- コントロールバー内に統合配置され、二重矢印アイコン（◄◄ / ►►）で視覚的に区別
- 「作品 X/総数」表示で現在位置を明示
- フィルタリング・ソート後の作品順序を反映
- 作品切り替え時に未保存の注釈があれば自動保存し、ページ番号とズーム状態をリセット
- 最初/最後の作品ではボタンを無効化、注釈保存中も操作不可

---

### 2.4. ズーム・パン機能 (F-03-03)

**概要**: モーダル内で画像の拡大・移動

**仕様**:
- ズームイン/ズームアウト（0.5〜3倍）
- ズーム時にドラッグ操作でパン（画像の移動）が可能

---

### 2.5. 並び替え・フィルタリング (F-03-04)

#### 2.5.1. 並び替え機能

**ソートオプション**:
- 提出日時順（早い/遅い）
- 学籍番号順（A→Z/Z→A）

**特殊な並び替えロジック** ✅ **実装完了（2025-11-06）**:
- **提出日時順**: 提出済み作品を日付順に表示し、未提出・エラー作品は末尾に学籍番号順で配置
- **学籍番号順**: 全ての作品（提出済み、未提出、エラー）を学籍番号順に混在表示
- **実装**: `src/lib/artworkUtils.ts`に`sortBySubmissionDate()`、`sortByStudentId()`を実装

#### 2.5.2. フィルタリング機能

**個別ラベルフィルタリング**:
- 赤（1〜5）、青（1〜5）の10種類のラベルボタンによるフィルタリング（OR条件）

**合計ラベルフィルタリング** ✅ **実装済み**:
- ラベル数字の合計値（1〜10）でフィルタリング
- プルダウン選択で合計値を指定（デフォルト: "合計で絞り込み"）
- 合計フィルター選択時は個別ラベルボタンを自動的に無効化（`opacity-50 cursor-not-allowed`スタイル適用）
- 合計フィルター解除時は個別ラベルボタンを再び有効化
- 正規表現（`/-(\d+)$/`）でラベルから数字を抽出し、`reduce`で合計値を計算
- 個別フィルターと合計フィルターは排他的に動作
- 実装方式: クライアント側での動的フィルタリング（シンプルで十分な性能）

**未提出/エラー作品フィルター** ✅ **実装完了（2025-11-06）**:
- チェックボックスで未提出・エラー作品を非表示にできる
- 詳細: [インポート機能仕様](import-feature.md#34-フィルタリング)

---

### 2.6. ギャラリー切り替え機能 (F-03-05)

**概要**: ドロップダウンで授業と課題を選択し、異なるギャラリーを切り替え

**仕様**:
- URLパラメータ（`galleryId`）で特定のギャラリーを表示

**初回訪問時の挙動**:
- ギャラリーが1つも存在しない場合：「まだギャラリーがありません」メッセージを表示
- ギャラリーが存在する場合：「課題を選択してください」メッセージを表示し、ドロップダウンで選択を促す

**再訪問時の挙動**:
- localStorageに保存された最後に閲覧したギャラリーを自動表示
- 保存されたギャラリーが削除されている場合は、選択画面を表示

**URL・localStorage同期**:
- URLパラメータとlocalStorageを自動同期し、ブックマークや直接アクセスに対応
- 削除されたギャラリーIDの場合は、URL・localStorageから自動削除して選択画面に遷移

---

## 3. 評価・フィードバック機能 (F-04)

### 3.1. いいね機能 (F-04-01)

**概要**: 管理者が各作品に「いいね」を付与

**仕様**:
- 一度のみクリック可能で、再度クリックすると解除される（トグル式）
- 「いいね」の総数は作品ごとにリアルタイムで表示
- 楽観的UI更新により、スムーズな操作感を実現

**実装**:
- Firestoreに`likes`サブコレクション
- `likeCount`フィールドで集計

---

### 3.2. コメント機能 (F-04-02)

**概要**: 管理者が各作品にテキストコメントを投稿

**仕様**:
- 投稿されたコメントは、投稿者名（Googleアカウント名）とタイムスタンプと共に時系列で表示

**実装**:
- Firestoreの`comments`配列フィールド
- リアルタイム更新対応

---

### 3.3. ラベル機能 (F-04-03)

**概要**: 管理者が各作品にラベルを付与

**仕様**:
- 赤（1〜5）、青（1〜5）の計10種類のラベル
- ラベルはトグル式で、クリックすると追加/削除
- 複数のラベルを同時に付けることが可能
- ラベルは作品サムネイルとモーダルに表示

**実装**:
- Firestoreの`labels`配列フィールド
- フロントエンドでのトグルUI

---

### 3.4. 作品削除機能 (F-04-04)

**概要**: 管理者が作品をギャラリーから削除

**仕様**:
- 削除時には確認ダイアログが表示
- Firestore上のドキュメントとStorage上の画像ファイルが同時に削除

**実装**:
- Cloud Functionsでカスケード削除
- トランザクション処理で整合性保証

---

## 4. データ管理機能 (F-05)

### 4.1. 全データリセット (F-05-01)

**概要**: 全ギャラリー、全作品、全画像ファイルを一括削除

**仕様**:
- 削除時には2回の確認ダイアログが表示
- 削除されるデータ:
  - Firestore: `artworks`, `likes`, `importJobs`, `galleries`コレクション
  - Storage: 全画像ファイル
- 削除実行時にlocalStorageもクリア

**実装**:
- Cloud Functions: `deleteAllData`関数
- バッチ処理で大量削除に対応

---

### 4.2. ギャラリー別データ削除 (F-05-02)

**概要**: 特定のギャラリーに紐づくデータのみを削除

**仕様**:
- 2段階ドロップダウン（授業選択 → 課題選択）で削除対象を選択
- 課題が選択されている場合のみ削除ボタンが有効
- 削除されるデータ:
  - 該当ギャラリーの作品
  - いいね
  - インポートジョブ
  - ギャラリードキュメント
  - Storage上の画像ファイル
- 削除時には2回の確認ダイアログが表示
- 削除されたギャラリーがlocalStorageに保存されている場合は自動的にクリア

**実装**:
- Cloud Functions: `deleteGalleryData`関数
- `galleryId`でフィルタリングして削除

---

### 4.3. ギャラリー作品数同期機能 (F-05-03) ✅ 実装完了（2025-11-06）

**概要**: 全ギャラリーの`artworkCount`を実際の作品数で同期

**背景**:
- `artworks`配列フィールドは非推奨
- `artworkCount`のみを信頼できる作品数として使用

**仕様**:
- ダッシュボードから同期実行ボタンをクリック
- 全ギャラリーの`artworkCount`を実際のFirestoreクエリ結果で更新
- 同期結果（ギャラリー名、旧カウント、新カウント、差分）を表形式で表示
- 作品の個別削除後に作品数が不整合になった場合に使用

**実装**:
- Cloud Functions: `syncGalleryArtworkCounts`関数
- エミュレーター環境と本番環境の両方に対応

---

## 5. UI/UX設計

### 5.1. レスポンシブデザイン

**対応デバイス**:
- デスクトップ（1920px以上）
- タブレット（768px〜1919px）
- モバイル（767px以下）

**ブレークポイント**:
- Tailwind CSSのデフォルトブレークポイントを使用

### 5.2. アクセシビリティ

**対応事項**:
- キーボードナビゲーション（矢印キー、Escキー）
- ARIAラベル（モーダル、ボタン）
- フォーカスインジケーター

---

## 6. パフォーマンス最適化

### 6.1. フロントエンド最適化

**実装済み**:
- React.useMemoでフィルタリング・ソート結果をメモ化
- 画像遅延読み込み（lazy loading）
- サムネイル最適化（420x297px WebP）

### 6.2. Firestore最適化 ✅ 2025-11-06実装

**実装済み**:
- React Hooks依存配列の最適化
- ギャラリー切り替え時のキャッシュ使用
- 読み取り回数: 8,000回/日 → 800-1,200回/日（**85-90%削減**）

**詳細**: [コストとパフォーマンス分析](../COST_AND_PERFORMANCE.md#3-firestore)

---

## 7. セキュリティ

### 7.1. Firestore Security Rules

```javascript
match /artworks/{artworkId} {
  // 全員が読み取り可能
  allow read: if true;

  // 管理者のみ作成・更新・削除可能
  allow write: if request.auth != null
    && get(/databases/$(database)/documents/userRoles/$(request.auth.token.email)).data.role == 'admin';
}
```

### 7.2. Storage Security Rules

```javascript
match /galleries/{galleryId}/{allPaths=**} {
  // 全員が読み取り可能
  allow read: if true;

  // 管理者のみ書き込み・削除可能
  allow write, delete: if request.auth != null
    && firestore.get(/databases/(default)/documents/userRoles/$(request.auth.token.email)).data.role == 'admin';
}
```

---

## 8. 関連ドキュメント

- [要件定義](../requirements.md) - システム全体の要件
- [インポート機能仕様](import-feature.md) - F-02の詳細
- [アノテーション機能仕様](ANNOTATION_FEATURE.md) - F-06の詳細
- [コストとパフォーマンス分析](../COST_AND_PERFORMANCE.md) - パフォーマンス最適化
- [テストシナリオ](../TESTING.md) - 機能テスト

---

**ドキュメントバージョン**: 1.0
**最終更新日**: 2025-11-20
**作成者**: Claude Code
