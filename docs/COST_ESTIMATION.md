# コスト・処理時間見積もり

## 使用ケース: 70人の学生、毎週講評会

### 前提条件
- **学生数**: 70人/週
- **ファイル**: PDF 5MB/人
- **ページ数**: 2～3ページ（平均2.5ページ）
- **頻度**: 週1回（年間40週 = 学期制）

---

## 📊 処理時間の見積もり

### 1. 1ファイルあたりの処理時間

#### フェーズ1: Google Driveからダウンロード + 一時Storage保存
```
Drive API呼び出し: 1秒
5MBダウンロード: 2秒
Storage一時保存: 1秒
---
合計: 約4秒/ファイル
```

#### フェーズ2: PDF → 画像変換（Cloud Tasks並列処理）
```
Storageダウンロード: 1秒
pdf2pic変換 (2.5ページ):
  - ページ1: 3秒
  - ページ2: 3秒
  - ページ3: 3秒
Sharp最適化 (2.5ページ): 2秒
サムネイル生成: 1秒
Storageアップロード: 2秒
一時ファイル削除: 0.5秒
---
合計: 約15秒/ファイル (2.5ページの場合)
```

**1ファイル総処理時間: 約19秒**

### 2. 70人分のインポート時間（並列処理）

#### シナリオA: 同時実行数制限なし（理論値）
```
importClassroomSubmissions: 70ファイル × 4秒 = 280秒 (4分40秒)
processFileTask（並列）: 15秒（最も遅いファイル1つ分）
---
合計: 約5分
```

#### シナリオB: 同時実行数10制限（現実的）
```
importClassroomSubmissions: 4分40秒
processFileTask（10並列）:
  - 70ファイル ÷ 10並列 = 7バッチ
  - 7バッチ × 15秒 = 105秒 (1分45秒)
---
合計: 約6分30秒
```

#### シナリオC: 同時実行数5制限（安全マージン）
```
importClassroomSubmissions: 4分40秒
processFileTask（5並列）:
  - 70ファイル ÷ 5並列 = 14バッチ
  - 14バッチ × 15秒 = 210秒 (3分30秒)
---
合計: 約8分
```

### 📌 **推奨: 6～8分で完了**

---

## 💰 コスト見積もり（Firebase料金）

### 1回のインポート（70人分）のコスト

#### Cloud Functions料金（第2世代）

**importClassroomSubmissions（1回実行）:**
```
メモリ: 1GB × 280秒 = 280 GB秒
料金: 280 × $0.0000025 = $0.0007
```

**processFileTask（70回実行、2.5ページ平均）:**
```
1ファイル: 2GB × 15秒 = 30 GB秒
70ファイル: 30 × 70 = 2,100 GB秒
料金: 2,100 × $0.0000025 = $0.00525
```

**合計Functions料金: $0.006/週（約¥0.9/週）**

---

#### Cloud Storageストレージ料金

**一時ファイル（unprocessed/）:**
```
70ファイル × 5MB × 1日保管 = 350MB × 1日
月間: 1.4GB（4週分重複なし）
料金: 1.4GB × $0.023 = $0.032/月
```

**変換後画像（galleries/）:**
```
1ファイル（2.5ページ）:
  - 画像: 2.5ページ × 800KB = 2MB
  - サムネイル: 1枚 × 50KB = 50KB
  - 小計: 約2.05MB

70ファイル/週: 70 × 2.05MB = 143.5MB/週
年間40週: 143.5MB × 40 = 5,740MB = 5.74GB/年

料金: 5.74GB × $0.023 = $0.132/年
```

**合計Storage料金: $0.032/月（一時） + $0.132/年（画像）**

---

#### Cloud Storage転送料金（ネットワーク）

**ダウンロード（閲覧時）:**
```
学生70人が各自の作品を閲覧: 70回
教員が全作品閲覧: 70作品 × 2.05MB = 143.5MB

1回の講評会: 143.5MB
年間40回: 143.5MB × 40 = 5,740MB = 5.74GB

料金（アジア地域）: 5.74GB × $0.12 = $0.69/年
```

**アップロード（無料）:** $0

---

#### Firestore料金

**書き込み（1回のインポート）:**
```
artworks: 70ドキュメント
importJobs: 1ドキュメント + 70回更新
galleries: 1ドキュメント + 1回更新

合計: 約143回書き込み/週
年間: 143 × 40 = 5,720回

料金: 5,720回（無料枠20,000回以内）
```

**読み取り（1回の講評会）:**
```
ギャラリー表示: 70作品読み取り × 10回リロード = 700回
進捗確認: 20回

合計: 約720回/週
年間: 720 × 40 = 28,800回

料金: 28,800回（無料枠50,000回以内）
```

**ストレージ:**
```
1作品: 約5KB
70作品/週 × 40週 = 2,800作品
2,800 × 5KB = 14MB

料金: 14MB（無料枠1GB以内）
```

---

#### Google APIs（Classroom + Drive）

**Classroom API:**
```
courses.list: 1回/インポート
courseWork.list: 1回/インポート
studentSubmissions.list: 1回/インポート
userProfiles.get: 70回/インポート

週1回 × 年40回: 2,920リクエスト/年
```

**Drive API:**
```
files.get（メタデータ）: 70回/インポート
files.get（ダウンロード）: 70回/インポート

週1回 × 年40回: 5,600リクエスト/年
```

**料金: 無料（Google Workspace for Educationの無料枠内）**

---

## 📊 **総コスト見積もり**

### 週次コスト
| 項目 | 料金 |
|------|------|
| Cloud Functions | $0.006 |
| Cloud Storage（一時） | $0.008 |
| Cloud Storage（画像） | $0.003 |
| Cloud Storage（転送） | $0.017 |
| Firestore | $0（無料枠内） |
| Google APIs | $0（無料枠内） |
| **合計** | **$0.034/週（約¥5/週）** |

### 月次コスト（4週）
| 項目 | 料金 |
|------|------|
| **合計** | **$0.136/月（約¥20/月）** |

### 年間コスト（40週）
| 項目 | 料金 |
|------|------|
| **合計** | **$1.36/年（約¥200/年）** |

---

## 🎯 Firebase無料枠との比較

### Spark Plan（無料プラン）の制限

| サービス | 無料枠 | 年間使用量 | 超過？ |
|---------|--------|-----------|--------|
| **Cloud Functions** | - | $0.24/年 | ✅ 有料プラン必須 |
| **Cloud Storage** | 5GB | 5.74GB | ⚠️ 年後半で超過 |
| **Firestore（書き込み）** | 20,000/日 | 143/日 | ✅ 余裕 |
| **Firestore（読み取り）** | 50,000/日 | 720/日 | ✅ 余裕 |
| **Firestore（ストレージ）** | 1GB | 14MB | ✅ 余裕 |

**結論: Blaze Plan（従量課金）が必要**

---

## 💡 コスト削減の提案

### 1. 画像品質を下げる（推奨）

**現在: 1920px、JPEG 85%品質**
```
1ページあたり: 800KB
```

**提案: 1280px、JPEG 75%品質**
```
1ページあたり: 300KB（-62.5%）

年間Storageコスト: $0.132 → $0.049（-63%）
年間転送コスト: $0.69 → $0.26（-62%）
```

### 2. DPIを下げる（推奨）

**現在: 150 DPI**
```
処理時間: 15秒/ファイル
```

**提案: 100 DPI**
```
処理時間: 10秒/ファイル（-33%）
Functions料金: $0.00525 → $0.0035（-33%）
```

### 3. サムネイルを後から生成（オプション）

**現在: インポート時に生成**
```
サムネイル: 全作品分生成
```

**提案: 閲覧時に動的生成**
```
サムネイル: 必要な分だけ生成
Storage削減: -20%
```

### 4. 古い講評会データを削除（推奨）

```
学期末（16週後）に古いギャラリーを削除
Storage使用量: 5.74GB → 2.87GB（-50%）
```

---

## 📈 最適化後のコスト

| 最適化内容 | 年間コスト削減 |
|-----------|--------------|
| 画像品質削減（1280px、75%） | -$0.61 |
| DPI削減（100 DPI） | -$0.07 |
| 古いデータ削除（学期末） | -$0.07 |
| **合計削減** | **-$0.75** |

### 最適化後の年間コスト
```
$1.36 → $0.61/年（約¥90/年）
```

**月額¥8程度で運用可能！**

---

## ⏱️ インポート時間の最適化

### 現在の推定時間
- **6～8分**（70人分）

### 体感速度の改善

#### 1. 進捗表示の改善
```typescript
// ページ単位の進捗を表示
`処理中... (ページ 175/175 完了 - 95%)`
```

#### 2. バックグラウンド処理の通知
```typescript
// インポート開始後、教員はページを離れてOK
// 完了時にメール通知（オプション）
```

#### 3. 段階的表示
```typescript
// 処理完了した作品から順次ギャラリーに表示
// 全体完了を待たなくても閲覧開始可能
```

---

## 🎓 結論

### 70人 × 毎週講評会の場合

| 項目 | 値 |
|------|-----|
| **インポート時間** | 6～8分 |
| **年間コスト** | ¥200/年（最適化後: ¥90/年） |
| **必要プラン** | Blaze Plan（従量課金） |
| **教員の作業** | 授業・課題選択のみ（2分） |
| **学生の作業** | Google Classroomに提出のみ |

**✅ 十分実用的で、コストも非常に安い！**

---

## 📝 補足: インポート中の挙動

### タイムライン（70人分）

```
0:00 - 教員がインポート開始ボタンをクリック
0:01 - importClassroomSubmissions開始
0:01～4:40 - Google Driveからファイルダウンロード中
       └─ 進捗: "インポート進行中... (10%)"
4:40～8:00 - Cloud Tasksで並列画像処理中
       └─ 進捗: "インポート進行中... (35/70ファイル処理済み - 60%)"
8:00 - 完了
       └─ "インポートが正常に完了しました！"
```

### ユーザー体験
- ✅ 教員は画面を見続ける必要なし（進捗表示あり）
- ✅ エラー発生時は該当ファイルをスキップ
- ✅ 部分的に成功した作品も表示される
- ✅ 完了後、即座にギャラリー閲覧可能
