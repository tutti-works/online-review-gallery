# オンライン講評会支援ギャラリーアプリ 要件定義書

## 1. 概要

### 1.1. プロジェクトの背景と目的

大学の設計課題などにおいて、従来は対面で行われていた作品の講評会がオンラインへ移行しつつある。しかし、ファイルの共有やフィードバックを一元的に、かつ効率的に行うための最適なツールが存在しない。
本プロジェクトは、Google Classroomに提出された学生の作品（画像、PDF等）を自動的に取得し、視覚的に優れたギャラリー形式で一覧表示するWebアプリケーションを開発することを目的とする。これにより、教員が行うオンライン講評会を円滑にし、インタラクティブなフィードバックの機会を創出する。

### 1.2. 開発するシステムの概要

本システムは、管理者（教員・TA）が操作するデータインポート機能を持つ。この機能はGoogle Classroom APIおよびGoogle Drive APIと連携し、指定された課題の提出物を取得する。取得されたファイルはWeb表示に最適化された画像（WebP）に変換され、Firebase Storageにアップロードされる。
利用者は、Firebase Storage上の画像をPinterestのようなMasonryレイアウトのギャラリーで閲覧し、管理者は各作品に対して「いいね」やコメント形式でのフィードバックを行える。

---

## 2. システムの利用者と役割

本システムの利用者は以下の通りとし、役割（ロール）に応じて利用できる機能を制限する。

| 役割 | 利用者 | 主な操作 |
|:-----|:-------|:---------|
| **管理者 (Admin)** | 教員, TA | Googleアカウントでログイン。データインポート機能の実行、作品の閲覧、全作品への「いいね」・コメント・ラベルの付与、作品の削除、全データリセット。 |
| **閲覧者 (Viewer)** | 学生 | Googleアカウントでログイン。ギャラリーの閲覧のみ。 |
| **ゲスト (Guest)** | 未認証ユーザー | ログインなしでギャラリーの閲覧のみ可能。 |

---

## 3. 機能要件

### 3.1. ユーザー認証機能 (F-01)

- **F-01-01: Googleサインイン**
  - 利用者は自身のGoogleアカウントを使用してシステムにサインインできる。
- **F-01-02: 役割（ロール）判定**
  - サインインしたGoogleアカウントが、事前にFirestoreに登録されたリストに基づき、「管理者」か「閲覧者」かを自動的に判定する。
- **F-01-03: アクセス制御**
  - 役割に応じて、操作可能な機能へのアクセスを制限する。閲覧者は閲覧以外の操作（いいね、コメント投稿など）は行えない。

### 3.2. データインポート機能 (F-02)

- **F-02-01: インポート対象の選択**
  - 管理者は、Google Classroom上のクラスと特定の課題を選択し、インポート対象として指定できる。
- **F-02-02: 複数ファイル提出の統合処理**
  - 同じ学生が複数ファイルを提出した場合、自動的に1つの作品（artwork）としてまとめる。
  - 学生ごとにファイルをグループ化し、全ファイルの全ページを統合して表示する。
  - ページ番号は全ファイル通しで採番される（例: file1.pdf 3ページ + file2.jpg 1ページ = 全4ページ）。
  - サムネイルは全体の1ページ目のみ生成（複数ファイルでも1つのサムネイル）。
- **F-02-03: 提出物の変換とアップロード**
  - 管理者がインポートを実行すると、Firebase Functionsが起動する。
  - 指定された課題の全提出物ファイル（画像、PDF）をGoogle Driveからダウンロードする。
  - **画像ファイルの場合:** Web表示に適したサイズにリサイズ・最適化し、WebP形式に直接変換する（Sharp使用）。
  - **PDFファイルの場合:** PDFの各ページを一旦JPEG（3400x2404px）に変換し、SharpでWebP形式に再変換する。Cloud Runを使用してGraphicsMagick/Ghostscriptでの高品質変換を行う。
  - JPEG経由の2段階変換により、メモリ使用量を抑えてSegmentation Faultを回避。
  - サムネイル画像（420x297px、WebP形式）を自動生成し、アスペクト比を維持する。
  - 変換・最適化して生成された全てのWebP画像をFirebase Storageにアップロードする。
  - WebP形式により、JPEG比で約30%のファイルサイズ削減を実現。
- **F-02-04: メタデータの保存**
  - 作品のメタデータ（提出ファイル情報、作成者、提出日時など）をFirestoreに保存する。
  - 提出された全ファイルの情報（ファイル名、種類、元URL）を`files`配列に保存する。
  - 各画像には元ファイル情報（`sourceFileId`, `sourceFileName`）を紐付ける。
  - エラーが発生したファイルは`errorFiles`（ファイル名）と`errorDetails`（詳細情報）に記録され、処理を継続する。
- **F-02-05: インポート進捗表示**
  - インポート処理の進捗状況（処理済み学生提出数/総学生提出数）をリアルタイムで表示する。
  - Cloud Tasksを使用した非同期分散処理により、大量ファイルのインポートでもタイムアウトを回避する。
- **F-02-06: インポート待機中のユーザー誘導**
  - インポート開始時に黄色の警告ボックスを表示し、ページを閉じないよう注意喚起する。
  - ブラウザを閉じようとした際に確認ダイアログを表示（beforeunload）。
  - 段階的にステータスメッセージを変更し（「データ取得中」→「ファイル確認中」→「処理キュー準備中」）、処理が進行中であることを視覚的に示す。
  - ローディングスピナーアニメーションで処理中であることを強調。
- **F-02-07: 再インポートスキップ機能** ✅ **実装完了（2025-11-06）**
  - 同一課題の再インポート時、既に作品が存在する学生の処理をスキップする。
  - 判定キーは `galleryId + studentEmail` の組み合わせ（`normalizeIdentifier()`で正規化）。
  - スキップされた学生数をインポート完了時に表示する。
  - 処理エラーで失敗した学生は、再インポートで再処理される。
- **F-02-08: 未提出学生のプレースホルダー作品** ✅ **実装完了（2025-11-06）**
  - Google Classroomの「割り当て済み」学生リストを取得し、未提出者を判定する。
  - 未提出学生用のプレースホルダー作品（`status: 'not_submitted'`）を自動生成する。
  - グレーのサムネイルに「未提出」テキストを中央表示する。
  - 学生の基本情報（名前、メールアドレス、学籍番号）のみ保存する。
  - モーダル表示で学生情報を確認可能。
- **F-02-09: エラー作品のプレースホルダー** ✅ **実装完了（2025-11-06）**
  - サポートされていないファイル形式（.docx等）の場合、エラー作品（`status: 'error'`）を生成する。
  - グレーのサムネイルに「エラー」テキストを中央表示する。
  - エラー理由（`errorReason: 'unsupported_format'`）を記録する。
  - 提出ファイル情報を保持し、モーダルで詳細表示可能。
  - バックエンド処理エラー（メモリ不足等）は対象外（再インポートで再試行可能）。

### 3.3. ギャラリー表示機能 (F-03)

- **F-03-01: Masonryレイアウト表示**
  - 異なるサイズ・アスペクト比の作品を、隙間なく美しく配置するMasonryレイアウト（グリッド形式）で表示する。
  - 複数ページある作品（元がPDF）の場合は、1ページ目の画像がサムネイルとして表示される。
  - サムネイルには学生名、いいね数、コメント数、ページ数、ラベル、遅刻フラグを表示する。
- **F-03-02: 作品の拡大・複数ページ表示**
  - ギャラリー上のサムネイルをクリックすると、作品を全画面モーダルウィンドウで拡大表示する。
  - 作品が複数ページで構成される場合（元がPDF）、モーダル内で「次へ」「前へ」といったナビゲーションを提供し、全ページを閲覧できるようにする。
  - ページサムネイルを下部に表示し、クリックで該当ページにジャンプできる。
  - モーダルのヘッダーに現在表示中のファイル名を表示し、ページ切り替え時に自動で更新する。
- **F-03-02a: モーダル内作品間ナビゲーション（実装済み）**
  - モーダルを開いたまま「前の作品」「次の作品」ボタンで別の作品に移動できる。
  - コントロールバー内に統合配置され、二重矢印アイコン（◄◄ / ►►）で視覚的に区別。
  - 「作品 X/総数」表示で現在位置を明示。
  - フィルタリング・ソート後の作品順序を反映。
  - 作品切り替え時に未保存の注釈があれば自動保存し、ページ番号とズーム状態をリセット。
  - 最初/最後の作品ではボタンを無効化、注釈保存中も操作不可。
- **F-03-03: ズーム・パン機能**
  - モーダル内で画像をズームイン/ズームアウト（0.5〜3倍）できる。
  - ズーム時にドラッグ操作でパン（画像の移動）が可能。
- **F-03-04: 並び替え・フィルタリング**
  - 提出日時順（早い/遅い）、学籍番号順（A→Z/Z→A）で並び替えが可能。
  - **個別ラベルフィルタリング:** 赤（1〜5）、青（1〜5）の10種類のラベルボタンによるフィルタリング（OR条件）
  - **合計ラベルフィルタリング（実装済み）:** ラベル数字の合計値（1〜10）でフィルタリング
    - プルダウン選択で合計値を指定（デフォルト: "合計で絞り込み"）
    - 合計フィルター選択時は個別ラベルボタンを自動的に無効化（`opacity-50 cursor-not-allowed`スタイル適用）
    - 合計フィルター解除時は個別ラベルボタンを再び有効化
    - 正規表現（`/-(\d+)$/`）でラベルから数字を抽出し、`reduce`で合計値を計算
    - 個別フィルターと合計フィルターは排他的に動作
    - 実装方式: クライアント側での動的フィルタリング（シンプルで十分な性能）
  - **未提出/エラー作品フィルター** ✅ **実装完了（2025-11-06）**: チェックボックスで未提出・エラー作品を非表示にできる
  - **特殊な並び替えロジック** ✅ **実装完了（2025-11-06）**:
    - 提出日時順: 提出済み作品を日付順に表示し、未提出・エラー作品は末尾に学籍番号順で配置
    - 学籍番号順: 全ての作品（提出済み、未提出、エラー）を学籍番号順に混在表示
    - `src/lib/artworkUtils.ts`に`sortBySubmissionDate()`、`sortByStudentId()`を実装
- **F-03-05: ギャラリー切り替え機能**
  - ドロップダウンで授業と課題を選択し、異なるギャラリーを切り替えることができる。
  - URLパラメータ（`galleryId`）で特定のギャラリーを表示する。
  - **初回訪問時の挙動:**
    - ギャラリーが1つも存在しない場合：「まだギャラリーがありません」メッセージを表示
    - ギャラリーが存在する場合：「課題を選択してください」メッセージを表示し、ドロップダウンで選択を促す
  - **再訪問時の挙動:**
    - localStorageに保存された最後に閲覧したギャラリーを自動表示
    - 保存されたギャラリーが削除されている場合は、選択画面を表示
  - **URL・localStorage同期:**
    - URLパラメータとlocalStorageを自動同期し、ブックマークや直接アクセスに対応
    - 削除されたギャラリーIDの場合は、URL・localStorageから自動削除して選択画面に遷移

### 3.4. 評価・フィードバック機能 (F-04)

- **F-04-01: いいね機能**
  - 管理者は、各作品に対して「いいね」を付けることができる。一度のみクリック可能で、再度クリックすると解除される（トグル式）。
  - 「いいね」の総数は作品ごとにリアルタイムで表示される。
  - 楽観的UI更新により、スムーズな操作感を実現する。
- **F-04-02: コメント機能**
  - 管理者は、各作品に対してテキストコメントを投稿できる。
  - 投稿されたコメントは、投稿者名（Googleアカウント名）とタイムスタンプと共に時系列で表示される。
- **F-04-03: ラベル機能**
  - 管理者は、各作品に対して赤（1〜5）、青（1〜5）の計10種類のラベルを付けることができる。
  - ラベルはトグル式で、クリックすると追加/削除される。
  - 複数のラベルを同時に付けることが可能。
  - ラベルは作品サムネイルとモーダルに表示される。
- **F-04-04: 作品削除機能**
  - 管理者は、作品をギャラリーから削除できる。
  - 削除時には確認ダイアログが表示される。
  - Firestore上のドキュメントとStorage上の画像ファイルが同時に削除される。

### 3.5. データ管理機能 (F-05)

- **F-05-01: 全データリセット**
  - 管理者は、ダッシュボードから全ギャラリー、全作品、全画像ファイルを一括削除できる。
  - 削除時には2回の確認ダイアログが表示される。
  - Firestore上の全コレクション（artworks, likes, importJobs, galleries）とStorage上の全画像が削除される。
  - 削除実行時にlocalStorageもクリアされる。
- **F-05-02: ギャラリー別データ削除**
  - 管理者は、ダッシュボードから特定のギャラリーに紐づくデータのみを削除できる。
  - 2段階ドロップダウン（授業選択 → 課題選択）で削除対象を選択する。
  - 課題が選択されている場合のみ削除ボタンが有効になる。
  - 削除されるデータ：該当ギャラリーの作品、いいね、インポートジョブ、ギャラリードキュメント、Storage上の画像ファイル。
  - 削除時には2回の確認ダイアログが表示される。
  - 削除されたギャラリーがlocalStorageに保存されている場合は自動的にクリアされる。
- **F-05-03: ギャラリー作品数同期機能** ✅ **実装完了（2025-11-06）**
  - 管理者は、ダッシュボードから全ギャラリーの`artworkCount`を実際の作品数で同期できる。
  - `artworks`配列フィールドは非推奨とし、`artworkCount`のみを信頼できる作品数として使用する。
  - 同期実行ボタンをクリックすると、全ギャラリーの`artworkCount`を実際のFirestoreクエリ結果で更新する。
  - 同期結果（ギャラリー名、旧カウント、新カウント、差分）を表形式で表示する。
  - 作品の個別削除後に作品数が不整合になった場合に使用する。
  - エミュレーター環境と本番環境の両方に対応（エミュレーター環境では認証チェックを簡易化）。

### 3.6. 作品注釈機能 (F-06) ✅ **完全実装（2025-11-05）**

- **F-06-01: フリーハンド描画**
  - ✅ 管理者は、作品画像の上にフリーハンドで線を描画できる（Konva.js Line + Bezier曲線、tension: 0.5）。
  - ✅ 指やペンによるタッチ操作に対応し、滑らかな線の描画が可能（touchStart, touchMove, touchEnd対応）。
  - ✅ 描画時にブラシの色（プリセットカラーパレット）と太さ（複数プリセット）を選択できる。
  - ✅ 2層レイヤー構造（background-layer、drawing-layer）でレンダリング最適化。
- **F-06-02: 注釈の編集**
  - ✅ 描画モードと選択モードを切り替えることができる。
  - ✅ 選択モードでは、描画した線をクリックして選択し、ドラッグで移動が可能。
  - ✅ 選択した線を個別に削除、または全ての注釈を一括クリアできる。
  - ✅ 選択中の線はシャドウエフェクト（shadowColor: #2b6cb0、shadowBlur: 10）で視覚的にハイライト。
  - ✅ hitStrokeWidth調整により、細い線でもタップしやすい。
  - ✅ **消しゴムツール実装完了**（部分削除機能）
  - ✅ **元に戻す/やり直し機能実装完了**（履歴管理）
- **F-06-03: 注釈データの保存**
  - ✅ 注釈データはベクトルデータ（Konva.js JSON形式）としてFirestoreに保存される。
  - ✅ 各ページ（画像）ごとに独立した注釈データを持つ（pageNumberで識別）。
  - ✅ 注釈の更新日時と更新者を記録する（updatedAt、updatedBy）。
  - ✅ 未保存の変更がある場合は警告を表示する（isDirtyフラグ管理）。
  - ✅ stage.toJSON()でエクスポート、Node.create()でインポート。
- **F-06-04: 注釈の表示**
  - ✅ モーダル内で「注釈」ボタンをクリックすると、注釈モードに切り替わる。
  - ✅ 管理者は注釈の編集が可能、閲覧者は注釈の表示のみ可能（editable propsで制御）。
  - ✅ 保存済みの注釈データを読み込んで、キャンバス上に復元する。
  - ✅ 画面サイズ変更時の自動スケーリング対応（ResizeObserver使用）。
  - ✅ 注釈モード終了時に未保存変更がある場合の確認ダイアログ。
  - ✅ **注釈の表示/非表示切り替え機能実装完了**
- **F-06-05: ページ間での注釈管理**
  - ✅ 複数ページの作品では、各ページごとに独立した注釈を管理する。
  - ✅ ページを切り替えると、該当ページの注釈が自動的に読み込まれる。
  - ✅ **ドラフト自動保存機能実装完了**（ページ切り替え時・作品切り替え時に自動保存）
- **F-06-06: ズーム・パン連携** ✅ **実装完了（2025-11-05）**
  - ✅ 注釈モードでも通常表示と同様に画像をズーム（拡大/縮小）できる
  - ✅ 注釈モードでも手のひらツールで画像位置を移動できる
  - ✅ 注釈は画像のズーム・パンに追従して表示される
  - ✅ 注釈モード開始時に、現在のズーム率と表示位置を維持する
- **F-06-07: ツールバー拡張** ✅ **実装完了（2025-11-05）**
  - ✅ 描画ツールボタン（ペンアイコン）
  - ✅ 線の選択・移動ツールボタン（矢印アイコン）
  - ✅ 画像移動ツールボタン（手のひらアイコン）
  - ✅ 消しゴムツールボタン（部分削除機能）
  - ✅ 線の太さプリセット（複数オプション）
  - ✅ 色パレット（プリセットカラー対応）
  - ✅ 元に戻す/やり直しボタン（Undo/Redo、履歴管理）
  - ✅ 全消去（クリア）ボタン
  - ✅ 保存ボタン
- **F-06-08: キーボードショートカット** 🔄 **一部実装済み**
  - ✅ `Ctrl+Z` / `Cmd+Z`: 元に戻す
  - ✅ `Ctrl+Y` / `Cmd+Y` / `Ctrl+Shift+Z`: やり直し
  - ✅ `Delete` / `Backspace`: 選択中の線を削除
  - ✅ `Esc`: 注釈モード終了（未保存の場合は確認）
  - 🔄 `D`, `V`, `H`, `E`: ツール切り替え（予定）
  - 🔄 `Ctrl+S` / `Cmd+S`: 注釈を保存（予定）
- **F-06-09: 自動保存機能** ✅ **実装完了（2025-11-05）**
  - ✅ ページ切り替え時に未保存の注釈を自動保存（ドラフト保存）
  - ✅ 作品切り替え時に未保存の注釈を自動保存
  - ✅ 注釈モード終了時に自動保存（未保存の場合）
  - ✅ 保存中は控えめなインジケーターを表示
- **F-06-10: 注釈のプレビュー表示** ✅ **実装完了（2025-11-05）**
  - ✅ 注釈がある作品のサムネイルに注釈アイコンを表示
  - ✅ 通常表示モード時に注釈をオーバーレイ表示（デフォルトON）
  - ✅ 注釈の表示/非表示を切り替えるボタン
- **F-06-11: 高度な描画ツール（予定、優先度: 低）**
  - 🔄 テキストツール（文字入力、フォントサイズ・色の選択）
  - 🔄 図形ツール（矩形・円の描画）
  - 🔄 マルチタッチジェスチャー対応（ピンチイン/アウト、2本指パン、筆圧検知）

---

## 4. 非機能要件

| 項目 | 要件 |
|:-----|:-----|
| **パフォーマンス** | ・ギャラリーの初回表示（主要コンテンツの描画完了）が3秒以内であること。<br>・「いいね」やコメントの反映は非同期で行い、ユーザー操作を妨げないこと。<br>・データインポート処理は、100件程度のファイル数をタイムアウトせずに安定して処理できること。 |
| **UI/UX** | ・直感的で学習コストの低いインターフェースであること。<br>・レスポンシブデザインに対応し、PCおよびタブレットのブラウザで最適に表示されること。 |
| **セキュリティ** | ・Firebase AuthenticationとFirestoreのセキュリティルールを適切に設定し、権限のない利用者によるデータの読み書きを完全に防止すること。<br>・APIキーなどの機密情報は適切に管理すること。 |
| **可用性** | ・VercelおよびFirebaseのSLAに準拠し、安定したサービス稼働を目指す。 |
| **動作環境** | ・**対応ブラウザ:** 最新バージョンのGoogle Chrome, Safari, Firefox, Microsoft Edge。 |

---

## 5. システム構成

- **フロントエンド:** Next.js 14 (React, TypeScript)
  - Tailwind CSS 3.4 を使用したスタイリング
  - レスポンシブデザイン対応（モバイル・タブレット・デスクトップ）
  - Konva.js v9.3.16 / react-konva v18.2.9 による注釈機能
  - Lucide React v0.552.0 によるアイコンライブラリ
  - react-masonry-css v1.0.16 による Masonry レイアウト
- **バックエンド:**
  - **Firebase Functions (第2世代):** インポート制御、データ取得、作品削除などの主要機能
  - **Cloud Run:** PDF処理専用（GraphicsMagick/Ghostscript使用）
  - Cloud Tasksを使用した非同期分散処理（ファンアウト）アーキテクチャで、タイムアウトを回避
  - メモリ: Functions 1GB〜2GB、Cloud Run 2GB
- **データベース:** Firestore
  - コレクション: artworks, galleries, importJobs, likes, userRoles
  - Security Rulesによる役割ベースのアクセス制御
- **ファイルストレージ:** Firebase Storage
  - 作品画像、サムネイル、一時ファイルのホスティング
  - 自動クリーンアップ機能（毎日午前3時）
- **認証:** Firebase Authentication (Google Sign-In)
- **外部API連携:** Google Drive API, Google Classroom API（データインポート機能でのみ利用）
- **ホスティング/デプロイ:**
  - **Firebase Hosting:** SSR対応、asia-northeast1リージョン
  - **GitHub Actions:** 自動デプロイパイプライン
- **モニタリング:** Google Analytics（有効化済み）

---

## 6. 開発スコープ

### 6.1. 範囲内（実装済み）

- ✅ 上記の機能要件（F-01〜F-05）に記載された全ての機能の実装
- ✅ PDFファイルの各ページを高品質画像（3400x2404px、A3横向き比率）に変換
- ✅ 複数ページの作品をページめくり形式で閲覧できる機能
- ✅ 画像（JPEG, PNG, GIF）ファイルの最適化と表示対応
- ✅ サムネイル自動生成（420x297px、アスペクト比維持）
- ✅ **複数ファイル提出の統合処理**（同じ学生の複数ファイルを1つのartworkにまとめる）
- ✅ ズーム・パン機能による詳細な作品閲覧
- ✅ ラベル機能による作品の分類
- ✅ 並び替え・個別ラベルフィルタリング機能
- ✅ **合計ラベルフィルター機能**（ラベル数字の合計値でフィルタリング、個別フィルターと排他制御）
- ✅ インポート進捗のリアルタイム表示
- ✅ 全データリセット機能（管理者専用）
- ✅ ギャラリー別データ削除機能
- ✅ **ギャラリー作品数同期機能**（artworkCount修正、artworks配列非推奨化、エミュレーター対応）
- ✅ **再インポートスキップ機能**（既存学生の重複作品生成を防止）
- ✅ **未提出学生のプレースホルダー作品**（グレーサムネイル、モーダル表示）
- ✅ **エラー作品のプレースホルダー**（サポート外ファイル形式の視覚的識別）
- ✅ **未提出/エラー作品フィルター**（チェックボックスで非表示切り替え）
- ✅ **特殊な並び替えロジック**（提出日時順・学籍番号順で未提出/エラーを適切に配置）
- ✅ 一時ファイルの自動クリーンアップ
- ✅ GitHub Actionsによる自動デプロイ
- ✅ **ハイブリッド方式によるギャラリー管理**（2段階ドロップダウン、URL・localStorage同期）

### 6.2. 範囲内（実装済み）

- ✅ **作品注釈機能（F-06）完全実装:** フリーハンド描画、選択・移動・削除、消しゴム、Undo/Redo、Firestore保存（Konva.jsベース、2025-11-05完全実装）
  - react-konva v18.2.9を使用した宣言的実装
  - 2層レイヤー構造（background-layer、drawing-layer）
  - ResizeObserverによる自動リサイズ対応
  - タッチデバイス対応（touchStart, touchMove, touchEnd）
  - ドラフト自動保存機能（ページ切り替え・作品切り替え時）
  - Undo/Redo履歴管理
  - 消しゴムツール（部分削除）
  - ズーム・パン連携（注釈モード中も画像操作可能）
  - 注釈オーバーレイ表示（通常モード時）
  - 権限制御（管理者のみ編集可能、閲覧者は表示のみ）
  - プリセットカラーパレット・ブラシサイズ
  - 新しい注釈データスキーマ（annotationsMap形式、旧スキーマとの互換性維持）

### 6.3. 範囲内（拡張機能として実装予定）

- 🔄 **作品注釈機能（F-06）追加拡張機能:** キーボードショートカット拡張（ツール切り替え等）、高度な描画ツール（テキスト・図形）
  - 詳細は「10. 実装計画: 作品注釈機能（F-06）」を参照

### 6.4. 範囲外（実装しない）

- ❌ **動画ファイルのストリーミング再生:** 動画ファイルはインポート対象外とする
- ❌ **学生間のピアレビュー機能:** 学生による「いいね」やコメント機能は実装しない
- ❌ **コメント削除機能:** コメントの削除は実装しない（作品ごと削除は可能）
- ❌ **リアルタイム共同編集機能:** 複数人が同時に一つのコメントを編集する機能は含めない
- ❌ **オフライン機能:** インターネット接続が必須となる
- ❌ **高度な管理者ダッシュボード:** 利用者アカウントの管理や利用状況の統計分析などの機能は本プロジェクトの範囲外とする

---

## 7. データ構造の詳細

### 7.1. Firestore コレクション構造

```
artworks (コレクション)
├── artwork_id (ドキュメント)
│   ├── id: string
│   ├── title: string （例: "山田太郎の提出物"）
│   ├── galleryId: string （どのギャラリーに属するか）
│   ├── status: 'submitted' | 'not_submitted' | 'error' （作品の状態、実装予定）
│   ├── errorReason?: 'unsupported_format' | 'processing_error' （エラー理由、実装予定）
│   ├── files: SubmittedFile[] （提出された元ファイル情報の配列）
│   │   ├── id: string （Google Drive File ID）
│   │   ├── name: string （ファイル名）
│   │   ├── type: 'image' | 'pdf'
│   │   ├── originalFileUrl: string
│   │   └── mimeType: string
│   ├── images: ArtworkImage[] （変換済み画像の配列、全ファイルの全ページ統合）
│   │   ├── id: string
│   │   ├── url: string
│   │   ├── pageNumber: number （全ファイル通しのページ番号）
│   │   ├── width: number
│   │   ├── height: number
│   │   ├── thumbnailUrl?: string
│   │   ├── sourceFileId: string （どのファイルから生成されたか）
│   │   └── sourceFileName: string
│   ├── studentName: string
│   ├── studentEmail: string
│   ├── studentId?: string （学籍番号、実装予定）
│   ├── submittedAt?: Timestamp （未提出の場合はnull）
│   ├── isLate: boolean
│   ├── classroomId: string
│   ├── assignmentId: string
│   ├── likeCount: number
│   ├── labels: LabelType[]
│   ├── comments: Comment[]
│   ├── annotations?: ArtworkAnnotation[] （作品への注釈データ、実装予定）
│   ├── createdAt: Timestamp
│   └── importedBy: string

galleries (コレクション) ※ハイブリッド方式：メタデータとキャッシュを保存
├── gallery_id (ドキュメント)
│   ├── id: string
│   ├── courseName: string （授業名、例: "デザイン基礎"）
│   ├── assignmentName: string （課題名、例: "第1回課題：ロゴデザイン"）
│   ├── courseId: string （Google Classroom Course ID）
│   ├── assignmentId: string （Google Classroom Assignment ID）
│   ├── classroomId: string （courseIdと同じ、互換性のため）
│   ├── artworkCount: number （作品数キャッシュ、同期機能で修正可能）
│   ├── createdBy: string
│   ├── createdAt: Timestamp
│   ├── updatedAt: Timestamp
│   └── lastImportAt?: Timestamp
│
│   注: `artworks`配列フィールドは非推奨（2025-11-06以降は作成・更新しない）

likes (コレクション)
├── like_id (ドキュメント)
│   ├── id: string
│   ├── artworkId: string
│   ├── userEmail: string
│   └── createdAt: Timestamp

importJobs (コレクション)
├── job_id (ドキュメント)
│   ├── id: string
│   ├── galleryId: string
│   ├── classroomId: string
│   ├── assignmentId: string
│   ├── status: 'pending' | 'processing' | 'completed' | 'error'
│   ├── progress: number (0-100)
│   ├── totalFiles: number （学生提出数）
│   ├── processedFiles: number
│   ├── errorFiles: string[]
│   ├── createdBy: string
│   └── createdAt: Timestamp

userRoles (コレクション)
├── user_email (ドキュメント)
│   ├── role: 'admin' | 'viewer'
│   └── createdAt: Timestamp
```

### 7.2. 注釈データ構造（実装済み - 2025-11-05更新）

**新スキーマ（annotationsMap）** - 現在採用中:
```typescript
interface ArtworkAnnotationPage {
  lines: ArtworkAnnotationLine[];
  width: number;          // 注釈作成時のキャンバス幅
  height: number;         // 注釈作成時のキャンバス高さ
  updatedAt: Date | string;
  updatedBy?: string;
}

interface ArtworkAnnotationLine {
  id: string;
  tool: 'draw' | 'erase';  // 描画ツール種別
  points: number[];        // 座標配列 [x1, y1, x2, y2, ...]
  stroke: string;          // 線の色
  strokeWidth: number;     // 線の太さ
  x?: number;              // 線のオフセット位置
  y?: number;
}

// artworksドキュメント内のフィールド
annotationsMap?: Record<string, ArtworkAnnotationPage>  // ページ番号をキーとするマップ
```

**旧スキーマ（annotations）** - 下位互換性のため保持:
```typescript
interface ArtworkAnnotation {
  pageNumber: number;
  data: string;           // Fabric.js/Konva.jsのJSONデータ（文字列化）
  width: number;
  height: number;
  updatedAt: Date | string;
  updatedBy?: string;
}

// artworksドキュメント内のフィールド
annotations?: ArtworkAnnotation[]  // 配列形式
```

**設計方針:**
- 各ページごとに独立した注釈データを管理（ページ番号をキーとするマップ構造）
- 新スキーマでは線データを直接配列で保存（より軽量・効率的）
- 旧スキーマとの互換性を維持（自動変換機能実装済み）
- キャンバスサイズ（`width`, `height`）を保存し、異なる画面サイズでの表示時にスケーリング可能
- 1ページあたりの注釈データサイズ: 約2〜5KB（新スキーマでさらに軽量化）
- Firestoreドキュメントサイズ上限（1MB）に対して十分な余裕あり

**使用ライブラリ:**
- **Konva.js v9.3.16**: キャンバス操作ライブラリ（60KB gzip）
  - フリーハンド描画（Line + Bezier曲線、tension: 0.5）
  - オブジェクトの選択・移動・削除
  - 消しゴムツール（globalCompositeOperation: 'destination-out'）
  - タッチデバイス対応（touchStart, touchMove, touchEnd）
  - 2層レイヤー構造（background-layer、drawing-layer）で最適化
- **react-konva v18.2.9**: React統合ライブラリ
  - Stage, Layer, Image, Lineコンポーネント
  - 宣言的なKonva.js操作
  - React Hooksとの統合

**実装の特徴（2025-11-05最新版）:**
- **ドラフト自動保存**: ページ切り替え・作品切り替え時に未保存データを自動保存
- **Undo/Redo履歴管理**: 最大50操作の履歴を保持
- **ズーム・パン連携**: 注釈モード中も画像のズーム・パン操作が可能
- **スケーリング処理**: baseSize（元画像サイズ）とdisplaySize（表示サイズ）を分離管理し、displayScaleで自動調整
- **ResizeObserver**: コンテナサイズ変更を検知して自動リサイズ
- **状態管理**: isDirtyフラグで未保存変更を追跡、onDirtyChangeコールバックで親コンポーネントへ通知
- **権限制御**: editable propsで管理者のみ編集可能、閲覧者は表示のみ
- **保存処理**: 楽観的UI更新でスムーズな操作感を実現
- **エラーハンドリング**: 画像読み込み失敗時のフォールバック、JSONパースエラー時の安全な処理
- **パフォーマンス最適化**: perfectDrawEnabledの動的切り替え、画像キャッシング

**技術選定の経緯:**
- 当初はFabric.js v5.3.0を採用したが、以下の致命的な問題が発生（2025-10-23）:
  - `canvas.setWidth()` / `canvas.setHeight()` 呼び出し時に `Cannot read properties of null (reading 'clearRect')` エラー
  - Fabric.js内部でcanvas contextがnullになる実装上の問題
  - 背景画像のスケーリング時に描画した線が消える
  - CSS-only方式では内部サイズの不整合により正常動作せず
- Konva.jsへの移行を決定した理由:
  - よりシンプルで予測可能なAPI設計
  - 背景画像をLayerとして管理できるため、スケーリングが安定
  - React統合が容易（react-konva利用可能）
  - TypeScript型定義が完備
  - 移行コスト: 約2〜3時間（試験済みのFabric.js実装を参考に移行）

### 7.3. ハイブリッド方式の実装（2025-10-06実装済み）

**設計方針:**
- `galleries`コレクション：軽量なメタデータとキャッシュを保存
- `artworks`コレクション：全作品データを保存、`galleryId`フィールドでフィルタリング
- Google Classroom APIから授業名・課題名を自動取得してギャラリーを生成

**主な機能:**
1. **ギャラリー自動生成**: インポート時にGoogle Classroom APIから授業名・課題名を取得し、ギャラリードキュメントを自動作成
2. **作品数キャッシュ**: 作品追加時に`artworkCount`を自動インクリメント
3. **ギャラリー切り替えUI**: 2段階ドロップダウン（授業選択 → 課題選択）で直感的に切り替え
4. **URLパラメータ連携**: `?galleryId=xxx`形式でギャラリーを指定可能
5. **ギャラリー別削除**: 特定のギャラリーに紐づく全データ（作品、いいね、ファイル）を一括削除

**実装ファイル:**
- `functions/src/importController.ts`: `ensureGalleryExists`関数でギャラリー自動生成、既存ギャラリーのメタデータ更新
- `functions/src/fileProcessor.ts`: `processMultipleFiles`内で`artworkCount`インクリメント
- `functions/src/index.ts`: `deleteGalleryData`関数でギャラリー別削除
- `src/components/GallerySwitcher.tsx`: 2段階ドロップダウンUI、localStorage保存
- `src/app/gallery/page.tsx`: ギャラリー選択の初期化ロジック、URL・localStorage同期、削除されたギャラリーの検証
- `src/app/dashboard/page.tsx`: 2カラムレイアウト（課題削除・全データリセット）、localStorage連携
- `src/app/admin/import/page.tsx`: インポート後のリダイレクト先を`/gallery?galleryId=xxx`に変更

---

## 8. デプロイ情報

### 8.1. 本番環境

- **プロジェクトID:** online-review-gallery
- **リージョン:** asia-northeast1
- **Firebase Hosting URL:** https://online-review-gallery.web.app
- **Cloud Run URL:** https://processfiletask-816131605069.asia-northeast1.run.app

### 8.2. 環境変数

**開発環境 (`.env.local`)**
- Firebase設定（API Key、Project ID等）
- Functions Base URL（エミュレータ）

**本番環境 (`.env.production`)**
- Firebase設定（本番プロジェクト）
- Cloud Run URL
- Google Analytics Measurement ID

---

## 9. 開発履歴

詳細な変更履歴は [changelog.md](changelog.md) を参照してください。

### 主要マイルストーン

- **2025-09-30:** 主要機能の実装完了（認証、インポート、ギャラリー、いいね、コメント）
- **2025-10-02:** Cloud Run移行、PDF処理最適化、ラベル機能追加、データリセット機能追加
- **2025-10-04:** Firebase Hostingへの移行、SSR対応
- **2025-10-05:** GitHub Actions自動デプロイ設定、Google Analytics有効化
- **2025-10-06:** 複数ファイル提出の統合処理、ハイブリッドギャラリー管理システム、ギャラリー選択フロー改善
- **2025-10-07:** WebP形式対応、インポート待機UI改善、PDF変換最適化、サムネイル重複生成バグ修正
- **2025-10-21:** 合計ラベルフィルター機能実装
- **2025-10-22:** 作品注釈機能の要件定義追加（Fabric.jsベース、実装予定）
- **2025-10-23:** Fabric.js実装でDOM操作エラー発生、Konva.jsへの移行を決定、基本的な注釈機能の実装完了（フリーハンド描画、選択・移動・削除、Firestore保存）
- **2025-11-01:** 注釈機能の実装状況をドキュメントに反映、拡張機能のロードマップを整理
- **2025-11-05:** 注釈機能の完全実装完了（Undo/Redo、消しゴム、ズーム・パン連携、ドラフト自動保存、注釈オーバーレイ表示、新データスキーマ）
- **2025-11-06:** ギャラリー作品数同期機能実装、artworks配列フィールド非推奨化、再インポートスキップ・未提出/エラープレースホルダー機能実装

---

## 10. 実装計画: 作品注釈機能（F-06）

### 10.1. 技術選定

**採用ライブラリ: Konva.js**

| 評価項目 | Konva.js | Fabric.js | Paper.js |
|:---------|:---------|:----------|:---------|
| **編集機能** | ⭐⭐⭐ 標準搭載 | ⭐⭐⭐ 標準搭載 | ⭐ 自前実装必要 |
| **JSON保存** | ⭐⭐⭐ toJSON/fromJSON | ⭐⭐⭐ ネイティブ対応 | ⭐ 複雑 |
| **React統合** | ⭐⭐⭐ react-konva | ⭐⭐ 可能 | ⭐ 困難 |
| **TypeScript** | ⭐⭐⭐ 型定義完備 | ⭐⭐⭐ 型定義完備 | ⭐ 不完全 |
| **タッチ対応** | ⭐⭐⭐ 優秀 | ⭐⭐⭐ 優秀 | ⭐⭐ 可能 |
| **バンドルサイズ** | ⭐⭐ 60KB (gzip) | ⭐⭐⭐ 26KB (gzip) | ⭐⭐ 中程度 |
| **背景画像管理** | ⭐⭐⭐ Layer方式で安定 | ⭐ DOM操作エラー | ⭐⭐ 可能 |
| **API安定性** | ⭐⭐⭐ 予測可能 | ⭐ DOM context問題 | ⭐⭐ 複雑 |

**総合評価:**
- **Konva.js**: シンプルで安定したAPI、背景画像管理が優秀、React統合が容易（採用理由）
- **Fabric.js**: `setWidth()/setHeight()`でDOM context nullエラー、背景画像とのスケーリング問題（不採用）
- **Paper.js**: 描画品質は最高だが、React統合が困難、実装コストが高い

**Fabric.jsからKonva.jsへの移行判断（2025-10-23）:**
- Fabric.js v5.3.0で以下の致命的な問題が発生し、解決不可能と判断:
  1. `canvas.setWidth()/setHeight()` 呼び出し時の `clearRect` エラー（Fabric.js内部実装の問題）
  2. 背景画像スケーリング時に描画した線が消失する問題
  3. CSS-only方式では内部キャンバスサイズの不整合により正常動作せず
- Konva.jsは背景画像をLayerとして管理できるため、スケーリングが安定
- React統合が優れており、`react-konva`を使用すればReactらしい実装が可能
- 移行コストは2〜3時間程度（Fabric.js実装の経験を活かせる）

### 10.2. 実装状況（2025-11-05時点）

#### Phase 1: Fabric.jsのクリーンアップと依存関係の更新 ✅ 完了
- ✅ Fabric.jsを削除
- ✅ Konva.js (v9.3.16) とreact-konva (v18.2.9) をインストール

#### Phase 2: AnnotationCanvasコンポーネントのKonva.js実装 ✅ 完了
実装ファイル:
- [src/components/AnnotationCanvas.tsx](../src/components/AnnotationCanvas.tsx)
- [src/components/annotation-canvas/](../src/components/annotation-canvas/) - サブコンポーネント群

**実装済み機能:**
- ✅ react-konvaコンポーネント（Stage, Layer, Image, Line）を使用
- ✅ 背景画像をImageコンポーネントとしてbackground-layerに配置
- ✅ フリーハンド描画をLineコンポーネントで実装（tension: 0.5でBezier曲線）
- ✅ **描画/選択/パン/消しゴムモードの切り替え**
- ✅ **ブラシ設定（プリセットカラーパレット、複数ブラシサイズオプション）**
- ✅ **Undo/Redo履歴管理（最大50操作）**
- ✅ **消しゴムツール（部分削除機能）**
- ✅ 選択した線の移動（ドラッグ）
- ✅ 選択削除ボタン（選択中の線を削除）
- ✅ 全てクリアボタン（全ての注釈を削除）
- ✅ 線の選択時にシャドウエフェクト（shadowColor: #2b6cb0、shadowBlur: 10）で視覚的にハイライト
- ✅ hitStrokeWidth調整により細い線でもタップしやすい
- ✅ タッチデバイス対応（touchStart, touchMove, touchEnd）

**レイアウトと最適化:**
- 2層レイヤー構造: background-layer（画像）とdrawing-layer（注釈）
- コンテナの幅に合わせて自動スケーリング（displayScale管理）
- ResizeObserverでリサイズに対応
- baseSize（元画像サイズ）とdisplaySize（表示サイズ）を分離管理
- 保存時は操作を無効化し、操作競合を防止
- **パフォーマンス最適化: perfectDrawEnabledの動的切り替え**

#### Phase 3: データ形式の検証 ✅ 完了
- ✅ JSON形式でのエクスポート/インポート動作確認済み
- ✅ **新データスキーマ（annotationsMap）への移行完了**
- ✅ **旧データスキーマ（annotations配列）との互換性維持**
- ✅ 画像サイズ変更時のスケーリング処理実装済み
  - baseSize（元画像サイズ）とdisplaySize（表示サイズ）を管理
  - displayScaleで注釈の座標とストローク幅を自動調整
  - 正規化処理により、異なる画面サイズでも正確に表示
- ✅ ページ切り替え時の注釈データ保持確認済み
  - 各ページ番号をキーとするマップ構造で注釈を管理
  - ページ切り替え時に該当ページの注釈を自動読み込み

#### Phase 4: Firestore統合とテスト ✅ 完了
実装ファイル:
- [src/components/ArtworkModal.tsx](../src/components/ArtworkModal.tsx)
- [src/components/artwork-modal/ArtworkViewer.tsx](../src/components/artwork-modal/ArtworkViewer.tsx)
- [src/app/gallery/page.tsx](../src/app/gallery/page.tsx)
- [src/lib/annotations.ts](../src/lib/annotations.ts) - データ変換ユーティリティ

**実装済み機能:**
- ✅ Firestoreへの注釈データ保存処理（新スキーマ対応）
- ✅ **ドラフト自動保存機能（ページ切り替え・作品切り替え時）**
- ✅ 注釈データ読み込み処理（旧スキーマからの自動変換対応）
- ✅ 権限制御（editable propsで管理者のみ編集可能）
- ✅ 保存中の状態表示（saving props）
- ✅ 未保存変更の検知（isDirty state + onDirtyChange callback）
- ✅ 注釈モード終了時の未保存警告ダイアログ

**データフロー:**
```
GalleryPage → ArtworkModal → ArtworkViewer → AnnotationCanvas
         ↓
    handleSaveAnnotation (Firestore updateDoc)
         ↓
    楽観的UI更新（localのartworks状態更新）
         ↓
    新スキーマ（annotationsMap）で保存
```

#### Phase 5: UX改善と最適化 ✅ 完全実装
- ✅ 未保存の変更がある場合の警告表示（注釈モード終了時）
- ✅ ローディング状態の表示（画像読み込み中スピナー）
- ✅ エラーハンドリングの実装（try-catch + アラート）
- ✅ 遅延読み込み（dynamic import with ssr: false）
- ✅ 保存中は操作を無効化
- ✅ 閲覧専用モード時のメッセージ表示
- ✅ カーソル表示の切り替え（各ツールに対応したカーソル）
- ✅ ボタンの状態管理（disabled時の視覚的フィードバック）
- ✅ **ズーム・パン連携実装（注釈モード中も画像操作可能）**
- ✅ **注釈オーバーレイ表示（通常モード時、表示/非表示切り替え可能）**
- ✅ **サムネイルへの注釈アイコン表示**

### 10.3. 拡張機能実装ロードマップ（更新版 - 2025-11-05）

以下のロードマップに基づき、段階的に機能を実装していきます。

#### ~~フェーズ1: 基本体験の改善~~ ✅ **完全実装済み**

1. ✅ **自動保存機能（F-06-09）** - 実装完了
   - ページ切り替え時に未保存の注釈を自動保存（ドラフト保存）
   - 作品切り替え時に自動保存
   - 注釈モード終了時に自動保存
   - 保存中は控えめなインジケーター表示

2. ✅ **ツールバーレイアウト刷新（F-06-07）** - 実装完了
   - 描画/選択/パン/消しゴムツールボタン
   - プリセットカラーパレット
   - 複数ブラシサイズオプション
   - Undo/Redo/クリア/保存ボタン
   - アイコン付きで視覚的に分かりやすいUI

3. ✅ **注釈の表示/非表示切り替え（F-06-10）** - 実装完了
   - 通常表示モード時に注釈をオーバーレイ表示（デフォルトON）
   - 「注釈を表示/非表示」トグルボタン実装
   - サムネイルに注釈アイコン表示

#### ~~フェーズ2: 高度な操作性~~ ✅ **完全実装済み**

4. ✅ **ズーム・パン連携（F-06-06）** - 実装完了
   - 注釈モード時も画像をズーム・パン可能
   - 画像移動ツール（手のひら）で操作
   - 注釈は画像に追従して拡大縮小・移動
   - 注釈モード開始時に現在のズーム率・位置を維持

5. ✅ **Undo/Redo機能（F-06-07）** - 実装完了
   - 元に戻す/やり直しボタン実装
   - 履歴スタック管理（最大50履歴）
   - 操作ごとにスナップショットを保存

6. ✅ **消しゴムツール（F-06-07）** - 実装完了
   - 線を部分的に削除できる消しゴムモード実装
   - `globalCompositeOperation: 'destination-out'`使用

#### フェーズ3: 効率化機能（一部実装済み） - 優先度: 高

7. **キーボードショートカット（F-06-08）** - 🔄 **一部実装済み**
   - ✅ Ctrl+Z / Cmd+Z: 元に戻す
   - ✅ Ctrl+Y / Cmd+Y: やり直し
   - ✅ Delete / Backspace: 選択中の線を削除
   - ✅ Esc: 注釈モード終了
   - 🔄 D, V, H, E: ツール切り替え（未実装）
   - 🔄 Ctrl+S / Cmd+S: 注釈を保存（未実装）
   - 🔄 ツールチップでショートカット表示（未実装）

8. **パフォーマンス最適化** - ✅ **実装完了**
   - ✅ perfectDrawEnabledの動的切り替え実装
   - ✅ 画像キャッシング実装
   - ✅ 新データスキーマによる軽量化
   - 🔄 注釈データの差分更新（現在は全体保存）

9. **エラーハンドリング強化** - 🔄 **一部実装済み**
   - ✅ 基本的なエラーハンドリング実装
   - 🔄 ネットワークエラー時の自動リトライ（未実装）
   - 🔄 保存失敗時にlocalStorageへの一時保存（未実装）
   - 🔄 オフライン検知と警告表示（未実装）

#### フェーズ4: 高度な描画ツール（2-3日） - 優先度: 中

**目標**: より表現力豊かな注釈を可能にする

10. **テキストツール（F-06-11）**
    - 文字入力機能
    - フォントサイズ選択（12px, 16px, 24px, 32px）
    - 色の選択（共通パレット使用）
    - **実装方法**:
      - Konva.js `Text`ノードを使用
      - ダブルクリックで編集モード（contenteditable div表示）
      - 入力完了後にTextノードに反映

11. **図形描画ツール（F-06-11）**
    - 矩形・円の描画
    - ドラッグ操作で図形のサイズを調整
    - 塗りつぶし/輪郭線のみ選択可能
    - **実装方法**:
      - Konva.js `Rect`, `Circle`ノードを使用
      - マウスダウン→ドラッグ→マウスアップで図形生成
      - TransformerでリサイズとRotation

12. **マルチタッチジェスチャー対応（F-06-11）**
    - ピンチイン/アウトでズーム
    - 2本指でパン
    - Apple Pencilの筆圧検知（strokeWidthに反映）
    - **実装方法**:
      - `onTouchMove`で`event.touches.length`判定
      - 2本指の距離変化でズーム倍率計算
      - `event.pressure`プロパティで筆圧取得

#### フェーズ5: 将来的な拡張（優先度: 低）

13. **注釈のエクスポート**
    - 注釈付き画像をPNG形式でダウンロード
    - **実装方法**: `stage.toDataURL({ pixelRatio: 2 })`

14. **複数人での協調注釈**
    - リアルタイム同期機能
    - **実装方法**: Firestore `onSnapshot`リスナー

15. **注釈テンプレート機能**
    - よく使う図形や記号を保存
    - ワンクリックで挿入

### 10.4. Konva.jsコンポーネント設計

```
ArtworkModal（モーダル本体）
├── 画像表示エリア
│   ├── 通常モード: <img> 要素
│   └── 注釈モード: <AnnotationCanvas>
│       ├── react-konva Stage
│       │   ├── backgroundLayer: 背景画像（Image）
│       │   └── drawingLayer: 注釈レイヤー（Line群）
│       ├── ツールバー（色・太さ・モード切替）
│       └── 保存ボタン
└── サイドバー
    ├── 作品情報
    ├── いいね・コメント
    ├── ラベル
    └── 注釈ボタン（トグル）
```

**Konva.js実装の主要コンポーネント:**
```tsx
<Stage width={width} height={height}>
  <Layer name="background">
    <Image image={backgroundImage} />
  </Layer>
  <Layer name="drawing">
    {lines.map(line => (
      <Line
        key={line.id}
        points={line.points}
        stroke={line.color}
        strokeWidth={line.width}
        tension={0.5}
        lineCap="round"
        lineJoin="round"
        draggable={!isDrawing}
      />
    ))}
  </Layer>
</Stage>
```

### 10.5. データフロー

```
1. ユーザーが注釈ボタンをクリック
   ↓
2. AnnotationCanvasを表示
   ↓
3. Firestoreから該当ページの注釈データ取得
   ↓
4. Node.create(jsonData) でKonva.jsオブジェクトを復元
   ↓
5. ユーザーが描画・編集
   ↓
6. 保存ボタンクリック
   ↓
7. stage.toJSON() でJSONエクスポート
   ↓
8. Firestoreに保存（updateDoc）
   ↓
9. 楽観的UI更新（ローカルステート更新）
```

### 10.6. パフォーマンス考慮事項

- **キャンバスサイズ**: 画像の元サイズを維持（高解像度対応）
- **遅延読み込み**: Konva.jsとreact-konvaは動的インポート（`lazy(() => import())`）で必要時のみ読み込み
- **メモリ管理**: モーダルを閉じる際に `stage.destroy()` で適切にクリーンアップ
- **データサイズ**: 1ページあたり5〜10KB程度、Firestoreドキュメント上限（1MB）に対して十分な余裕
- **Layer分離**: 背景画像と描画レイヤーを分離することで、再描画を最適化

### 10.7. セキュリティ考慮事項

- **権限チェック**: Firestore Security Rulesで管理者のみ注釈データの書き込みを許可
- **データ検証**: 注釈データのサイズ制限（最大100KB程度）
- **XSS対策**: Konva.jsのJSON形式は安全（scriptタグなどは含まれない、座標データと色情報のみ）

### 10.8. 開発見積もりと優先順位（更新版 - 2025-11-05）

#### 総開発時間見積もり

| フェーズ | 内容 | 優先度 | 見積もり工数 | 実績工数 | ステータス |
|:---------|:-----|:-------|:-------------|:---------|:-----------|
| フェーズ1 | 基本体験の改善 | 最高 | 1-2日 | 約2日 | ✅ 完了 |
| フェーズ2 | 高度な操作性 | 高 | 2-3日 | 約3日 | ✅ 完了 |
| フェーズ3 | 効率化機能 | 高 | 1-2日 | 約1日（一部） | 🔄 一部完了 |
| フェーズ4 | 高度な描画ツール | 中 | 2-3日 | 未着手 | 🔄 予定 |
| フェーズ5 | 将来的な拡張 | 低 | 未定 | 未着手 | 🔄 予定 |

**次の実装優先順位**:
1. フェーズ3の残作業（キーボードショートカット拡張、エラーハンドリング強化）
2. フェーズ4（テキストツール、図形ツール）
3. フェーズ5（協調注釈、テンプレート機能）

各フェーズ完了後にユーザーテストを実施し、フィードバックを次フェーズに反映します。

#### 技術的リスクと対策

**リスク1: ズーム・パン連携の複雑性**
- リスク: Konva.jsのStage座標系と注釈座標系の変換が複雑
- 対策: 段階的実装（まずズームのみ、次にパン）、十分なテスト時間確保

**リスク2: パフォーマンス劣化**
- リスク: 大量の注釈（100本以上の線）でレンダリングが重くなる
- 対策: `perfectDrawEnabled: false`、レイヤーキャッシング、仮想化

**リスク3: マルチタッチ対応のデバイス依存**
- リスク: 全てのタッチデバイスで筆圧検知できるわけではない
- 対策: 機能検出でフォールバック、テスト環境の充実

### 10.9. 既知の制約事項・今後の改善予定

- 🔄 キーボードショートカット（D, V, H, E, Ctrl+S）が未実装
- 🔄 ツールボタンへのショートカット表示（ツールチップ）が未実装
- 🔄 注釈データの差分更新（現在は全体保存）
- 🔄 ネットワークエラー時の自動リトライ機能
- 🔄 保存失敗時のlocalStorageバックアップ
- 🔄 オフライン検知と警告表示
- 🔄 テキストツール（文字入力）
- 🔄 図形ツール（矩形・円の描画）
- 🔄 マルチタッチジェスチャー対応（ピンチイン/アウト等）

### 10.10. アクセシビリティ考慮事項

注釈機能は視覚的な操作が中心ですが、以下の点でアクセシビリティを向上させます：

- **キーボード操作対応**: 全ての機能をキーボードショートカットでアクセス可能（フェーズ3）
- **ツールチップ**: 各ボタンにホバー時の説明を表示（aria-label付き）
- **高コントラスト対応**: 選択中の線は明確なシャドウエフェクトで強調
- **フォーカスインジケーター**: キーボードフォーカス時に視覚的に表示
- **スクリーンリーダー対応**: 主要な操作にaria-live領域で状態通知

### 10.11. 今後の検討事項

**UIパターンの参考**
- Adobe Photoshop: ツールパレット、レイヤー構造
- Figma: キーボードショートカット、ツール切り替え
- Procreate: タッチジェスチャー、ブラシプリセット

**競合サービス分析**
- Miro: 協調注釈、リアルタイム同期
- Notion: 軽量な注釈機能、シンプルなUI

**ユーザーフィードバック収集計画**
- フェーズ1完了後: 教員5名によるα版テスト
- フェーズ3完了後: 実際の講評会でβ版テスト（学生30名規模）
- フィードバック項目:
  - ツールの使いやすさ（5段階評価）
  - 不足している機能
  - パフォーマンス（描画の遅延感）
  - バグ報告

---

## 📚 関連ドキュメント

### 機能仕様
- [アノテーション機能](ANNOTATION_FEATURE.md) - F-06の詳細仕様・実装状況
- [再インポート機能](import-skip-and-placeholders.md) - F-02-07, F-02-08, F-02-09の詳細
- [背景インポート機能](BACKGROUND_IMPORT.md) - F-02の処理フロー

### 技術分析
- [コストとパフォーマンス](COST_AND_PERFORMANCE.md) - 料金試算・処理時間分析
- [PDF処理ガイド](PDF_PROCESSING_GUIDE.md) - PDF変換最適化

### セットアップ
- [ローカル開発環境](setup/local-development.md)
- [Cloud Runデプロイ](setup/cloud-run-deployment.md)
- [本番環境デプロイ](setup/production-deployment.md)

### テスト
- [テストシナリオ](TESTING.md) - 主要機能のテストケース

### その他
- [変更履歴](changelog.md) - 開発履歴
