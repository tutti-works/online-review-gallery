rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // ギャラリー画像: 誰でも読み取り可能（開発環境用）、管理者のみ書き込み可能
    match /galleries/{galleryId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null
        && firestore.get(/databases/(default)/documents/userRoles/$(request.auth.token.email)).data.role == 'admin';
    }

    // 専用ギャラリー用の概要画像など
    match /showcase/{galleryId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null
        && firestore.get(/databases/(default)/documents/userRoles/$(request.auth.token.email)).data.role == 'admin';
    }

    // 一時ファイル: Cloud Functionsのみアクセス可能
    // 注意: Storage Rulesにはファイル自動削除機能がないため、
    // 定期的なクリーンアップFunctionを別途実装することを推奨
    match /unprocessed/{importJobId}/{fileName} {
      // Cloud Functionsからのアクセスのみ許可（認証なしのリクエストを想定）
      allow read, write: if request.auth == null; // Service Accountからのアクセス
    }

    // その他のパスは拒否
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
