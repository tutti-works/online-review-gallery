## **オンライン講評会支援ギャラリーアプリ 要件定義書**

### **1\. 概要**

#### **1.1. プロジェクトの背景と目的**

大学の設計課題などにおいて、従来は対面で行われていた作品の講評会がオンラインへ移行しつつある。しかし、ファイルの共有やフィードバックを一元的に、かつ効率的に行うための最適なツールが存在しない。  
本プロジェクトは、Google Classroomに提出された学生の作品（画像、PDF等）を自動的に取得し、視覚的に優れたギャラリー形式で一覧表示するWebアプリケーションを開発することを目的とする。これにより、教員が行うオンライン講評会を円滑にし、インタラクティブなフィードバックの機会を創出する。

#### **1.2. 開発するシステムの概要**

本システムは、管理者（教員・TA）が操作するデータインポート機能を持つ。この機能はGoogle Classroom APIおよびGoogle Drive APIと連携し、指定された課題の提出物を取得する。取得されたファイルはWeb表示に最適化された画像（JPG）に変換され、Firebase Storageにアップロードされる。  
利用者は、Firebase Storage上の画像をPinterestのようなMasonryレイアウトのギャラリーで閲覧し、管理者は各作品に対して「いいね」やコメント形式でのフィードバックを行える。

---

### **2\. システムの利用者と役割**

本システムの利用者は以下の通りとし、役割（ロール）に応じて利用できる機能を制限する。

| 役割 | 利用者 | 主な操作 |
| :---- | :---- | :---- |
| **管理者 (Admin)** | 教員, TA | Googleアカウントでログイン。データインポート機能の実行、作品の閲覧、全作品への「いいね」・コメント・ラベルの付与、作品の削除、全データリセット。 |
| **閲覧者 (Viewer)** | 学生 | Googleアカウントでログイン。ギャラリーの閲覧のみ。 |
| **ゲスト (Guest)** | 未認証ユーザー | ログインなしでギャラリーの閲覧のみ可能。 |

---

### **3\. 機能要件**

#### **3.1. ユーザー認証機能 (F-01)**

* **F-01-01: Googleサインイン**  
  * 利用者は自身のGoogleアカウントを使用してシステムにサインインできる。  
* **F-01-02: 役割（ロール）判定**  
  * サインインしたGoogleアカウントが、事前にFirestoreに登録されたリストに基づき、「管理者」か「閲覧者」かを自動的に判定する。  
* **F-01-03: アクセス制御**  
  * 役割に応じて、操作可能な機能へのアクセスを制限する。閲覧者は閲覧以外の操作（いいね、コメント投稿など）は行えない。

#### **3.2. データインポート機能 (F-02)**

* **F-02-01: インポート対象の選択**
  * 管理者は、Google Classroom上のクラスと特定の課題を選択し、インポート対象として指定できる。
* **F-02-02: 複数ファイル提出の統合処理**
  * 同じ学生が複数ファイルを提出した場合、自動的に1つの作品（artwork）としてまとめる。
  * 学生ごとにファイルをグループ化し、全ファイルの全ページを統合して表示する。
  * ページ番号は全ファイル通しで採番される（例: file1.pdf 3ページ + file2.jpg 1ページ = 全4ページ）。
* **F-02-03: 提出物の変換とアップロード**
  * 管理者がインポートを実行すると、Firebase Functionsが起動する。
  * 指定された課題の全提出物ファイル（画像、PDF）をGoogle Driveからダウンロードする。
  * **画像ファイルの場合:** Web表示に適したサイズにリサイズ・最適化し、WebP形式に変換する。
  * **PDFファイルの場合:** PDFの各ページを、それぞれ個別のWebP画像（3400x2404px、A3横向き比率）に変換する。Cloud Runを使用してGraphicsMagick/Ghostscriptでの高品質変換を行う。
  * サムネイル画像（420x297px、WebP形式）を自動生成し、アスペクト比を維持する。
  * 変換・最適化して生成された全てのWebP画像をFirebase Storageにアップロードする。
  * WebP形式により、JPEG比で約30%のファイルサイズ削減を実現。
* **F-02-04: メタデータの保存**
  * 作品のメタデータ（提出ファイル情報、作成者、提出日時など）をFirestoreに保存する。
  * 提出された全ファイルの情報（ファイル名、種類、元URL）を`files`配列に保存する。
  * 各画像には元ファイル情報（`sourceFileId`, `sourceFileName`）を紐付ける。
* **F-02-05: インポート進捗表示**
  * インポート処理の進捗状況（処理済み学生提出数/総学生提出数）をリアルタイムで表示する。
  * Cloud Tasksを使用した非同期分散処理により、大量ファイルのインポートでもタイムアウトを回避する。
* **F-02-06: インポート待機中のユーザー誘導**
  * インポート開始時に黄色の警告ボックスを表示し、ページを閉じないよう注意喚起する。
  * ブラウザを閉じようとした際に確認ダイアログを表示（beforeunload）。
  * 段階的にステータスメッセージを変更し（「データ取得中」→「ファイル確認中」→「処理キュー準備中」）、処理が進行中であることを視覚的に示す。
  * ローディングスピナーアニメーションで処理中であることを強調。

#### **3.3. ギャラリー表示機能 (F-03)**

* **F-03-01: Masonryレイアウト表示**
  * 異なるサイズ・アスペクト比の作品を、隙間なく美しく配置するMasonryレイアウト（グリッド形式）で表示する。
  * 複数ページある作品（元がPDF）の場合は、1ページ目の画像がサムネイルとして表示される。
  * サムネイルには学生名、いいね数、コメント数、ページ数、ラベル、遅刻フラグを表示する。
* **F-03-02: 作品の拡大・複数ページ表示**
  * ギャラリー上のサムネイルをクリックすると、作品を全画面モーダルウィンドウで拡大表示する。
  * 作品が複数ページで構成される場合（元がPDF）、モーダル内で「次へ」「前へ」といったナビゲーションを提供し、全ページを閲覧できるようにする。
  * ページサムネイルを下部に表示し、クリックで該当ページにジャンプできる。
* **F-03-03: ズーム・パン機能**
  * モーダル内で画像をズームイン/ズームアウト（0.5〜3倍）できる。
  * ズーム時にドラッグ操作でパン（画像の移動）が可能。
* **F-03-04: 並び替え・フィルタリング**
  * 提出日時順（早い/遅い）、学籍番号順（A→Z/Z→A）で並び替えが可能。
  * ラベルによるフィルタリング（OR条件）が可能。
* **F-03-05: ギャラリー切り替え機能**
  * ドロップダウンで授業と課題を選択し、異なるギャラリーを切り替えることができる。
  * URLパラメータ（`galleryId`）で特定のギャラリーを表示する。
  * **初回訪問時の挙動:**
    * ギャラリーが1つも存在しない場合：「まだギャラリーがありません」メッセージを表示
    * ギャラリーが存在する場合：「課題を選択してください」メッセージを表示し、ドロップダウンで選択を促す
  * **再訪問時の挙動:**
    * localStorageに保存された最後に閲覧したギャラリーを自動表示
    * 保存されたギャラリーが削除されている場合は、選択画面を表示
  * **URL・localStorage同期:**
    * URLパラメータとlocalStorageを自動同期し、ブックマークや直接アクセスに対応
    * 削除されたギャラリーIDの場合は、URL・localStorageから自動削除して選択画面に遷移

#### **3.4. 評価・フィードバック機能 (F-04)**

* **F-04-01: いいね機能**
  * 管理者は、各作品に対して「いいね」を付けることができる。一度のみクリック可能で、再度クリックすると解除される（トグル式）。
  * 「いいね」の総数は作品ごとにリアルタイムで表示される。
  * 楽観的UI更新により、スムーズな操作感を実現する。
* **F-04-02: コメント機能**
  * 管理者は、各作品に対してテキストコメントを投稿できる。
  * 投稿されたコメントは、投稿者名（Googleアカウント名）とタイムスタンプと共に時系列で表示される。
* **F-04-03: ラベル機能**
  * 管理者は、各作品に対して赤（1〜5）、青（1〜5）の計10種類のラベルを付けることができる。
  * ラベルはトグル式で、クリックすると追加/削除される。
  * 複数のラベルを同時に付けることが可能。
  * ラベルは作品サムネイルとモーダルに表示される。
* **F-04-04: 作品削除機能**
  * 管理者は、作品をギャラリーから削除できる。
  * 削除時には確認ダイアログが表示される。
  * Firestore上のドキュメントとStorage上の画像ファイルが同時に削除される。

#### **3.5. データ管理機能 (F-05)**

* **F-05-01: 全データリセット**
  * 管理者は、ダッシュボードから全ギャラリー、全作品、全画像ファイルを一括削除できる。
  * 削除時には2回の確認ダイアログが表示される。
  * Firestore上の全コレクション（artworks, likes, importJobs, galleries）とStorage上の全画像が削除される。
  * 削除実行時にlocalStorageもクリアされる。
* **F-05-02: ギャラリー別データ削除**
  * 管理者は、ダッシュボードから特定のギャラリーに紐づくデータのみを削除できる。
  * 2段階ドロップダウン（授業選択 → 課題選択）で削除対象を選択する。
  * 課題が選択されている場合のみ削除ボタンが有効になる。
  * 削除されるデータ：該当ギャラリーの作品、いいね、インポートジョブ、ギャラリードキュメント、Storage上の画像ファイル。
  * 削除時には2回の確認ダイアログが表示される。
  * 削除されたギャラリーがlocalStorageに保存されている場合は自動的にクリアされる。

---

### **4\. 非機能要件**

| 項目 | 要件 |
| :---- | :---- |
| **パフォーマンス** | ・ギャラリーの初回表示（主要コンテンツの描画完了）が3秒以内であること。<br>・「いいね」やコメントの反映は非同期で行い、ユーザー操作を妨げないこと。<br>・データインポート処理は、100件程度のファイル数をタイムアウトせずに安定して処理できること。 |
| **UI/UX** | ・直感的で学習コストの低いインターフェースであること。 ・レスポンシブデザインに対応し、PCおよびタブレットのブラウザで最適に表示されること。 |
| **セキュリティ** | ・Firebase AuthenticationとFirestoreのセキュリティルールを適切に設定し、権限のない利用者によるデータの読み書きを完全に防止すること。 ・APIキーなどの機密情報は適切に管理すること。 |
| **可用性** | ・VercelおよびFirebaseのSLAに準拠し、安定したサービス稼働を目指す。 |
| **動作環境** | ・**対応ブラウザ:** 最新バージョンのGoogle Chrome, Safari, Firefox, Microsoft Edge。 |

---

### **5\. システム構成**

* **フロントエンド:** Next.js 14 (React, TypeScript)
  * Tailwind CSS を使用したスタイリング
  * レスポンシブデザイン対応
* **バックエンド:**
  * **Firebase Functions (第2世代):** インポート制御、データ取得、作品削除などの主要機能
  * **Cloud Run:** PDF処理専用（GraphicsMagick/Ghostscript使用）
  * Cloud Tasksを使用した非同期分散処理（ファンアウト）アーキテクチャで、タイムアウトを回避
  * メモリ: Functions 1GB〜2GB、Cloud Run 2GB
* **データベース:** Firestore
  * コレクション: artworks, galleries, importJobs, likes, userRoles
  * Security Rulesによる役割ベースのアクセス制御
* **ファイルストレージ:** Firebase Storage
  * 作品画像、サムネイル、一時ファイルのホスティング
  * 自動クリーンアップ機能（毎日午前3時）
* **認証:** Firebase Authentication (Google Sign-In)
* **外部API連携:** Google Drive API, Google Classroom API（データインポート機能でのみ利用）
* **ホスティング/デプロイ:**
  * **Firebase Hosting:** SSR対応、asia-northeast1リージョン
  * **GitHub Actions:** 自動デプロイパイプライン
* **モニタリング:** Google Analytics（有効化済み）

---

### **6\. 開発スコープ**

#### **6.1. 範囲内（実装済み）**

* ✅ 上記の機能要件（F-01〜F-04）に記載された全ての機能の実装
* ✅ PDFファイルの各ページを高品質画像（3400x2404px、A3横向き比率）に変換
* ✅ 複数ページの作品をページめくり形式で閲覧できる機能
* ✅ 画像（JPEG, PNG, GIF）ファイルの最適化と表示対応
* ✅ サムネイル自動生成（420x297px、アスペクト比維持）
* ✅ **複数ファイル提出の統合処理**（同じ学生の複数ファイルを1つのartworkにまとめる）
* ✅ ズーム・パン機能による詳細な作品閲覧
* ✅ ラベル機能による作品の分類
* ✅ 並び替え・フィルタリング機能
* ✅ インポート進捗のリアルタイム表示
* ✅ 全データリセット機能（管理者専用）
* ✅ 一時ファイルの自動クリーンアップ
* ✅ GitHub Actionsによる自動デプロイ
* ✅ **ハイブリッド方式によるギャラリー管理**（2段階ドロップダウン、URL・localStorage同期、ギャラリー別削除）

#### **6.2. 範囲内（実装予定）**

* （現在、実装予定の項目はありません）

#### **6.3. 範囲外（実装しない）**

* ❌ **動画ファイルのストリーミング再生:** 動画ファイルはインポート対象外とする
* ❌ **学生間のピアレビュー機能:** 学生による「いいね」やコメント機能は実装しない
* ❌ **コメント削除機能:** コメントの削除は実装しない（作品ごと削除は可能）
* ❌ **リアルタイム共同編集機能:** 複数人が同時に一つのコメントを編集する機能は含めない
* ❌ **オフライン機能:** インターネット接続が必須となる
* ❌ **高度な管理者ダッシュボード:** 利用者アカウントの管理や利用状況の統計分析などの機能は本プロジェクトの範囲外とする

---

### **7\. デプロイ情報**

#### **7.1. 本番環境**

* **プロジェクトID:** online-review-gallery
* **リージョン:** asia-northeast1
* **Firebase Hosting URL:** https://online-review-gallery.web.app
* **Cloud Run URL:** https://processfiletask-816131605069.asia-northeast1.run.app

#### **7.2. デプロイ手順**

```bash
# 1. Cloud Run（PDF処理）のデプロイ
cd functions
npm run build
gcloud builds submit --tag gcr.io/online-review-gallery/processfiletask
gcloud run deploy processfiletask --image gcr.io/online-review-gallery/processfiletask ...

# 2. Firebase Functions & Hosting のデプロイ
firebase deploy --only functions,hosting

# 3. Security Rules のデプロイ
firebase deploy --only firestore:rules,storage
```

#### **7.3. 環境変数**

**開発環境 (`.env.local`)**
- Firebase設定（API Key、Project ID等）
- Functions Base URL（エミュレータ）

**本番環境 (`.env.production`)**
- Firebase設定（本番プロジェクト）
- Cloud Run URL
- Google Analytics Measurement ID

---

### **8\. 開発履歴**

* **2025-09-30:** 主要機能の実装完了（認証、インポート、ギャラリー、いいね、コメント）
* **2025-10-02:** Cloud Run移行、PDF処理最適化、ラベル機能追加、データリセット機能追加
* **2025-10-04:** Firebase Hostingへの移行、SSR対応
* **2025-10-05:** GitHub Actions自動デプロイ設定、Google Analytics有効化
* **2025-10-06 (1):** 複数ファイル提出の統合処理実装（同じ学生の複数ファイルを1つのartworkにまとめる）
* **2025-10-06 (2):** ハイブリッドギャラリー管理システム実装（ギャラリー切り替えUI、ギャラリー別データ削除機能）
* **2025-10-06 (3):** ギャラリー選択フロー改善（初回訪問時の挙動改善、localStorage・URL同期の最適化、削除されたギャラリーのハンドリング強化）
* **2025-10-07 (1):** WebP形式対応実装（画像・PDF両方をWebPに変換、ファイルサイズ30%削減）
* **2025-10-07 (2):** インポート待機UI改善（警告メッセージ、beforeunload確認、段階的ステータス表示、ローディングアニメーション）

詳細な変更履歴は [CHANGELOG.md](CHANGELOG.md) を参照してください。

---

### **9\. データ構造の詳細**

#### **9.1. Firestore コレクション構造（現在）**

```
artworks (コレクション)
├── artwork_id (ドキュメント)
│   ├── id: string
│   ├── title: string （例: "山田太郎の提出物"）
│   ├── galleryId: string （どのギャラリーに属するか）
│   ├── files: SubmittedFile[] （提出された元ファイル情報の配列）
│   │   ├── id: string （Google Drive File ID）
│   │   ├── name: string （ファイル名）
│   │   ├── type: 'image' | 'pdf'
│   │   ├── originalFileUrl: string
│   │   └── mimeType: string
│   ├── images: ArtworkImage[] （変換済み画像の配列、全ファイルの全ページ統合）
│   │   ├── id: string
│   │   ├── url: string
│   │   ├── pageNumber: number （全ファイル通しのページ番号）
│   │   ├── width: number
│   │   ├── height: number
│   │   ├── thumbnailUrl?: string
│   │   ├── sourceFileId: string （どのファイルから生成されたか）
│   │   └── sourceFileName: string
│   ├── studentName: string
│   ├── studentEmail: string
│   ├── submittedAt: Timestamp
│   ├── isLate: boolean
│   ├── classroomId: string
│   ├── assignmentId: string
│   ├── likeCount: number
│   ├── labels: LabelType[]
│   ├── comments: Comment[]
│   ├── createdAt: Timestamp
│   └── importedBy: string

galleries (コレクション) ※ハイブリッド方式：メタデータとキャッシュを保存
├── gallery_id (ドキュメント)
│   ├── id: string
│   ├── courseName: string （授業名、例: "デザイン基礎"）
│   ├── assignmentName: string （課題名、例: "第1回課題：ロゴデザイン"）
│   ├── courseId: string （Google Classroom Course ID）
│   ├── assignmentId: string （Google Classroom Assignment ID）
│   ├── classroomId: string （courseIdと同じ、互換性のため）
│   ├── artworkCount: number （作品数キャッシュ）
│   ├── createdBy: string
│   ├── createdAt: Timestamp
│   ├── updatedAt: Timestamp
│   └── lastImportAt?: Timestamp

likes (コレクション)
├── like_id (ドキュメント)
│   ├── id: string
│   ├── artworkId: string
│   ├── userEmail: string
│   └── createdAt: Timestamp

importJobs (コレクション)
├── job_id (ドキュメント)
│   ├── id: string
│   ├── galleryId: string
│   ├── classroomId: string
│   ├── assignmentId: string
│   ├── status: 'pending' | 'processing' | 'completed' | 'error'
│   ├── progress: number (0-100)
│   ├── totalFiles: number （学生提出数）
│   ├── processedFiles: number
│   ├── errorFiles: string[]
│   ├── createdBy: string
│   └── createdAt: Timestamp

userRoles (コレクション)
├── user_email (ドキュメント)
│   ├── role: 'admin' | 'viewer'
│   └── createdAt: Timestamp
```

#### **9.2. ハイブリッド方式の実装（2025-10-06実装済み）**

**設計方針:**
- `galleries`コレクション：軽量なメタデータとキャッシュを保存
- `artworks`コレクション：全作品データを保存、`galleryId`フィールドでフィルタリング
- Google Classroom APIから授業名・課題名を自動取得してギャラリーを生成

**主な機能:**
1. **ギャラリー自動生成**: インポート時にGoogle Classroom APIから授業名・課題名を取得し、ギャラリードキュメントを自動作成
2. **作品数キャッシュ**: 作品追加時に`artworkCount`を自動インクリメント
3. **ギャラリー切り替えUI**: 2段階ドロップダウン（授業選択 → 課題選択）で直感的に切り替え
4. **URLパラメータ連携**: `?galleryId=xxx`形式でギャラリーを指定可能
5. **ギャラリー別削除**: 特定のギャラリーに紐づく全データ（作品、いいね、ファイル）を一括削除

**実装ファイル:**
- `functions/src/importController.ts`: `ensureGalleryExists`関数でギャラリー自動生成、既存ギャラリーのメタデータ更新
- `functions/src/fileProcessor.ts`: `processMultipleFiles`内で`artworkCount`インクリメント
- `functions/src/index.ts`: `deleteGalleryData`関数でギャラリー別削除
- `src/components/GallerySwitcher.tsx`: 2段階ドロップダウンUI、localStorage保存
- `src/app/gallery/page.tsx`: ギャラリー選択の初期化ロジック、URL・localStorage同期、削除されたギャラリーの検証
- `src/app/dashboard/page.tsx`: 2カラムレイアウト（課題削除・全データリセット）、localStorage連携
- `src/app/admin/import/page.tsx`: インポート後のリダイレクト先を`/gallery?galleryId=xxx`に変更